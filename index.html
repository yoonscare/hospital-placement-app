<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìŠ¤ë§ˆíŠ¸ ì‹¤ìŠµ ë°°ì¹˜ ì‹œìŠ¤í…œ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #8b5cf6;
            --primary-dark: #7c3aed;
            --primary-light: #a78bfa;
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        * {
            font-family: 'Noto Sans KR', sans-serif;
        }

        body {
            background: #f8fafc;
            min-height: 100vh;
        }

        .header {
            background: var(--bg-gradient);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }

        .header h1 {
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .card {
            border: none;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-bottom: 1.5rem;
        }

        .card-header {
            background: white;
            border-bottom: 1px solid #e2e8f0;
            border-radius: 16px 16px 0 0 !important;
            font-weight: 600;
            padding: 1rem 1.5rem;
        }

        .btn-primary {
            background: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            border-color: var(--primary-dark);
        }

        .upload-zone {
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            padding: 3rem 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8fafc;
        }

        .upload-zone:hover, .upload-zone.dragover {
            border-color: var(--primary-color);
            background: #faf5ff;
        }

        .hospital-table {
            font-size: 0.8rem;
        }

        .hospital-table input[type="text"] {
            width: 100%;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 0.4rem 0.6rem;
            font-size: 0.85rem;
        }

        .hospital-table input[type="number"] {
            width: 45px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            padding: 0.25rem;
            text-align: center;
            font-size: 0.8rem;
        }

        .hospital-table input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.1);
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .stat-card .number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .stat-card .label {
            color: #64748b;
            font-size: 0.9rem;
        }

        .result-table {
            font-size: 0.85rem;
        }

        .badge-class-A { background: #3b82f6; }
        .badge-class-B { background: #10b981; }
        .badge-class-C { background: #f59e0b; }

        .period-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }

        .period-mixed {
            background: #8b5cf6 !important;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            display: none;
        }

        .loading-overlay.show {
            display: flex;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e2e8f0;
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .nav-tabs .nav-link {
            color: #64748b;
            border: none;
            padding: 1rem 1.5rem;
            font-weight: 500;
        }

        .nav-tabs .nav-link.active {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
            background: transparent;
        }

        .schedule-info {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
        }

        .schedule-item {
            display: inline-flex;
            align-items: center;
            padding: 0.4rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            margin: 0.25rem;
            font-size: 0.9rem;
        }

        .dept-nicu {
            background: #fee2e2;
            color: #dc2626;
        }

        .dept-peds {
            background: #dbeafe;
            color: #2563eb;
        }

        .filter-btn {
            border: 1px solid #e2e8f0;
            background: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
            transition: all 0.2s;
        }

        .filter-btn:hover, .filter-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .class-header {
            text-align: center;
            font-weight: 600;
            font-size: 0.75rem;
            padding: 0.5rem !important;
        }

        .class-header-C { background: #fef3c7 !important; }
        .class-header-A { background: #dbeafe !important; }
        .class-header-B { background: #d1fae5 !important; }
        .class-header-mixed { background: #ede9fe !important; }

        .dept-sub-header {
            font-size: 0.65rem;
            text-align: center;
            padding: 0.25rem !important;
        }

        .nicu-col { background: #fff5f5 !important; }
        .peds-col { background: #f0f9ff !important; }

        .to-cell {
            padding: 0.25rem !important;
            text-align: center;
        }

        .hospital-name-cell {
            min-width: 120px;
        }

        .hospital-addr-cell {
            min-width: 100px;
        }

        .table-scroll-wrapper {
            overflow-x: auto;
            max-width: 100%;
        }

        .capacity-summary {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .capacity-box {
            background: white;
            border-radius: 8px;
            padding: 0.75rem;
            text-align: center;
            border: 1px solid #e2e8f0;
        }

        .capacity-box.class-C { border-left: 4px solid #f59e0b; }
        .capacity-box.class-A { border-left: 4px solid #3b82f6; }
        .capacity-box.class-B { border-left: 4px solid #10b981; }
        .capacity-box.class-mixed { border-left: 4px solid #8b5cf6; }

        .capacity-box .class-name {
            font-weight: 600;
            font-size: 0.85rem;
            margin-bottom: 0.25rem;
        }

        .capacity-box .capacity-detail {
            font-size: 0.75rem;
            color: #64748b;
        }

        .capacity-box .capacity-total {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary-color);
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="text-center">
            <div class="spinner mx-auto mb-3"></div>
            <p class="text-muted">ë°°ì¹˜ ì²˜ë¦¬ ì¤‘...</p>
        </div>
    </div>

    <header class="header">
        <div class="container">
            <h1>ğŸ¥ ìŠ¤ë§ˆíŠ¸ ì‹¤ìŠµ ë°°ì¹˜ ì‹œìŠ¤í…œ</h1>
            <p class="mb-0 opacity-75">ê³µì •í•˜ê³  íš¨ìœ¨ì ì¸ ì‹¤ìŠµ ë³‘ì› ë°°ì •</p>
        </div>
    </header>

    <div class="container pb-5">
        <!-- 8ì£¼ ìŠ¤ì¼€ì¤„ ì•ˆë‚´ -->
        <div class="schedule-info">
            <h6 class="mb-3"><strong>ğŸ“… 8ì£¼ ì‹¤ìŠµ ìŠ¤ì¼€ì¤„ (ê° ë°˜ 2ì£¼ì”© ì‹¤ìŠµ)</strong></h6>
            <div class="d-flex align-items-center justify-content-center flex-wrap">
                <span class="schedule-item" style="background: #fef3c7; color: #b45309;">
                    1-2ì£¼: Cë°˜
                </span>
                <span class="mx-1">â†’</span>
                <span class="schedule-item" style="background: #dbeafe; color: #1d4ed8;">
                    3-4ì£¼: Aë°˜
                </span>
                <span class="mx-1">â†’</span>
                <span class="schedule-item" style="background: #d1fae5; color: #059669;">
                    5-6ì£¼: Bë°˜
                </span>
                <span class="mx-1">â†’</span>
                <span class="schedule-item" style="background: #ede9fe; color: #7c3aed;">
                    7-8ì£¼: ë¯¸ë°°ì¹˜ í•™ìƒ
                </span>
            </div>
            <p class="text-muted small mt-2 mb-0 text-center">
                ê° í•™ìƒì€ <strong>2ì£¼ê°„</strong> ë°°ì •ëœ ë³‘ì›ì˜
                <span class="badge dept-nicu">ì‹ ìƒì•„ì‹¤</span> ë˜ëŠ”
                <span class="badge dept-peds">ì†Œì•„ê³¼</span> ì¤‘ <strong>í•œ ê³³</strong>ì—ì„œ ì‹¤ìŠµí•©ë‹ˆë‹¤.
                <br>ì •ê·œ ê¸°ê°„ì— ë°°ì¹˜ë˜ì§€ ëª»í•œ í•™ìƒì€ 7-8ì£¼ì°¨ì— í˜¼í•© ë°°ì¹˜ë©ë‹ˆë‹¤.
            </p>
        </div>

        <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
        <ul class="nav nav-tabs mb-4" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="hospital-tab" data-bs-toggle="tab" data-bs-target="#hospital-panel" type="button">
                    1ï¸âƒ£ ë³‘ì› í‹°ì˜¤ ì„¤ì •
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload-panel" type="button">
                    2ï¸âƒ£ í•™ìƒ ì—…ë¡œë“œ
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="result-tab" data-bs-toggle="tab" data-bs-target="#result-panel" type="button">
                    3ï¸âƒ£ ë°°ì¹˜ ê²°ê³¼
                </button>
            </li>
        </ul>

        <div class="tab-content" id="mainTabContent">
            <!-- ë³‘ì› ì„¤ì • íƒ­ -->
            <div class="tab-pane fade show active" id="hospital-panel" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>ğŸ¥ ì‹¤ìŠµ ë³‘ì› ë° ë°˜ë³„ í‹°ì˜¤ ì„¤ì •</span>
                        <button class="btn btn-sm btn-outline-primary" onclick="addHospitalRow()">
                            + ë³‘ì› ì¶”ê°€
                        </button>
                    </div>
                    <div class="card-body">
                        <p class="text-muted small mb-3">
                            ğŸ’¡ ê° ë³‘ì›ì˜ <strong>ë°˜ë³„ Â· ë¶€ì„œë³„</strong> ì •ì›(í‹°ì˜¤)ì„ ì…ë ¥í•˜ì„¸ìš”. <strong>7-8ì£¼ì°¨</strong>ëŠ” ì •ê·œ ê¸°ê°„ì— ë°°ì¹˜ë˜ì§€ ëª»í•œ í•™ìƒë“¤ì„ ìœ„í•œ ì¶”ê°€ í‹°ì˜¤ì…ë‹ˆë‹¤.
                        </p>
                        <div class="table-scroll-wrapper">
                            <table class="table table-bordered hospital-table mb-0" id="hospitalTable">
                                <thead>
                                    <tr>
                                        <th rowspan="2" class="align-middle text-center" style="min-width:120px;">ë³‘ì›ëª…</th>
                                        <th rowspan="2" class="align-middle text-center" style="min-width:100px;">ì£¼ì†Œ(êµ¬)</th>
                                        <th colspan="2" class="class-header class-header-C">Cë°˜ (1-2ì£¼)</th>
                                        <th colspan="2" class="class-header class-header-A">Aë°˜ (3-4ì£¼)</th>
                                        <th colspan="2" class="class-header class-header-B">Bë°˜ (5-6ì£¼)</th>
                                        <th colspan="2" class="class-header class-header-mixed">7-8ì£¼ (í˜¼í•©)</th>
                                        <th rowspan="2" class="align-middle text-center" style="width:40px;"></th>
                                    </tr>
                                    <tr>
                                        <th class="dept-sub-header nicu-col">ì‹ ìƒ</th>
                                        <th class="dept-sub-header peds-col">ì†Œì•„</th>
                                        <th class="dept-sub-header nicu-col">ì‹ ìƒ</th>
                                        <th class="dept-sub-header peds-col">ì†Œì•„</th>
                                        <th class="dept-sub-header nicu-col">ì‹ ìƒ</th>
                                        <th class="dept-sub-header peds-col">ì†Œì•„</th>
                                        <th class="dept-sub-header nicu-col">ì‹ ìƒ</th>
                                        <th class="dept-sub-header peds-col">ì†Œì•„</th>
                                    </tr>
                                </thead>
                                <tbody id="hospitalTableBody">
                                </tbody>
                            </table>
                        </div>

                        <!-- ë°˜ë³„ ì •ì› ìš”ì•½ -->
                        <div class="capacity-summary" id="capacitySummary">
                        </div>

                        <div class="text-end mt-3">
                            <button class="btn btn-outline-secondary me-2" onclick="resetHospitals()">ì´ˆê¸°í™”</button>
                            <button class="btn btn-primary" onclick="saveHospitals()">ğŸ’¾ ë³‘ì› ì„¤ì • ì €ì¥</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- í•™ìƒ ì—…ë¡œë“œ íƒ­ -->
            <div class="tab-pane fade" id="upload-panel" role="tabpanel">
                <div class="card">
                    <div class="card-header">ğŸ“„ í•™ìƒ ëª…ë‹¨ ì—…ë¡œë“œ</div>
                    <div class="card-body">
                        <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
                            <div class="mb-3">
                                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#a78bfa" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="17 8 12 3 7 8"></polyline>
                                    <line x1="12" y1="3" x2="12" y2="15"></line>
                                </svg>
                            </div>
                            <h5>ì—‘ì…€ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ</h5>
                            <p class="text-muted mb-0">ì§€ì› í˜•ì‹: .xlsx, .xls, .csv</p>
                        </div>
                        <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" style="display: none;" onchange="handleFileUpload(event)">

                        <div class="alert alert-info mt-4">
                            <h6 class="alert-heading">ğŸ“‹ í•„ìˆ˜ ì»¬ëŸ¼</h6>
                            <ul class="mb-0">
                                <li><strong>í•™ë²ˆ</strong> - í•™ìƒ í•™ë²ˆ</li>
                                <li><strong>ì´ë¦„</strong> - í•™ìƒ ì´ë¦„</li>
                                <li><strong>ë°˜</strong> - A, B, C ì¤‘ í•˜ë‚˜</li>
                                <li><strong>ì£¼ì†Œ</strong> - ê±°ì£¼ì§€ ì£¼ì†Œ (êµ¬/ë™ í¬í•¨)</li>
                            </ul>
                        </div>

                        <div id="uploadPreview" style="display: none;">
                            <h5 class="mt-4 mb-3">ğŸ“Š ì—…ë¡œë“œëœ í•™ìƒ ëª…ë‹¨</h5>

                            <!-- ë°˜ë³„ í•™ìƒ ìˆ˜ ìš”ì•½ -->
                            <div class="row mb-3" id="classSummary"></div>

                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                <table class="table table-sm table-bordered" id="previewTable">
                                    <thead class="table-light" style="position: sticky; top: 0;">
                                        <tr>
                                            <th>#</th>
                                            <th>í•™ë²ˆ</th>
                                            <th>ì´ë¦„</th>
                                            <th>ë°˜</th>
                                            <th>ì£¼ì†Œ</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                            <div class="text-end mt-3">
                                <button class="btn btn-lg btn-primary" onclick="runPlacement()">
                                    ğŸš€ ë°°ì¹˜ ì‹œì‘í•˜ê¸°
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ë°°ì¹˜ ê²°ê³¼ íƒ­ -->
            <div class="tab-pane fade" id="result-panel" role="tabpanel">
                <div id="resultContent" style="display: none;">
                    <!-- í†µê³„ ì¹´ë“œ -->
                    <div class="row mb-4" id="statsRow">
                        <div class="col-md-3 col-6 mb-3">
                            <div class="stat-card">
                                <div class="number" id="statTotal">0</div>
                                <div class="label">ì „ì²´ í•™ìƒ</div>
                            </div>
                        </div>
                        <div class="col-md-3 col-6 mb-3">
                            <div class="stat-card">
                                <div class="number text-success" id="statPlaced">0</div>
                                <div class="label">ë°°ì¹˜ ì™„ë£Œ</div>
                            </div>
                        </div>
                        <div class="col-md-3 col-6 mb-3">
                            <div class="stat-card">
                                <div class="number text-danger" id="statUnplaced">0</div>
                                <div class="label">ë¯¸ë°°ì¹˜</div>
                            </div>
                        </div>
                        <div class="col-md-3 col-6 mb-3">
                            <div class="stat-card">
                                <div class="number text-info" id="statRate">0%</div>
                                <div class="label">ë°°ì¹˜ìœ¨</div>
                            </div>
                        </div>
                    </div>

                    <!-- í•„í„° -->
                    <div class="card mb-3">
                        <div class="card-body py-3">
                            <div class="d-flex flex-wrap align-items-center">
                                <span class="me-3 fw-bold">í•„í„°:</span>
                                <button class="filter-btn active" data-filter="all" onclick="filterResult('all')">ì „ì²´</button>
                                <button class="filter-btn" data-filter="C" onclick="filterResult('C')">Cë°˜</button>
                                <button class="filter-btn" data-filter="A" onclick="filterResult('A')">Aë°˜</button>
                                <button class="filter-btn" data-filter="B" onclick="filterResult('B')">Bë°˜</button>
                                <span class="mx-2">|</span>
                                <button class="filter-btn" data-filter="regular" onclick="filterResult('regular')">ì •ê·œë°°ì¹˜</button>
                                <button class="filter-btn" data-filter="mixed" onclick="filterResult('mixed')">7-8ì£¼ í˜¼í•©</button>
                                <span class="mx-2">|</span>
                                <button class="filter-btn" data-filter="nicu" onclick="filterResult('nicu')">ğŸ¼ ì‹ ìƒì•„ì‹¤</button>
                                <button class="filter-btn" data-filter="peds" onclick="filterResult('peds')">ğŸ‘¶ ì†Œì•„ê³¼</button>
                            </div>
                        </div>
                    </div>

                    <!-- ê²°ê³¼ í…Œì´ë¸” -->
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span>ğŸ“‹ ë°°ì¹˜ ê²°ê³¼ <span class="badge bg-secondary" id="resultCount">0ëª…</span></span>
                            <button class="btn btn-sm btn-success" onclick="downloadResult()">
                                ğŸ“¥ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover result-table" id="resultTable">
                                    <thead class="table-light">
                                        <tr>
                                            <th>í•™ë²ˆ</th>
                                            <th>ì´ë¦„</th>
                                            <th>ë°˜</th>
                                            <th>ì‹¤ìŠµê¸°ê°„</th>
                                            <th>ì£¼ì†Œ</th>
                                            <th>ë°°ì •ë³‘ì›</th>
                                            <th>ì‹¤ìŠµë¶€ì„œ</th>
                                            <th>ìƒíƒœ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="resultTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- ë³‘ì›ë³„ í˜„í™© -->
                    <div class="card mt-4">
                        <div class="card-header">ğŸ¥ ë³‘ì›ë³„ ë°°ì¹˜ í˜„í™©</div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm table-bordered" id="hospitalSummaryTable">
                                    <thead class="table-light">
                                        <tr>
                                            <th rowspan="2" class="align-middle text-center">ë³‘ì›ëª…</th>
                                            <th colspan="2" class="text-center class-header-C">Cë°˜ (1-2ì£¼)</th>
                                            <th colspan="2" class="text-center class-header-A">Aë°˜ (3-4ì£¼)</th>
                                            <th colspan="2" class="text-center class-header-B">Bë°˜ (5-6ì£¼)</th>
                                            <th colspan="2" class="text-center class-header-mixed">7-8ì£¼ (í˜¼í•©)</th>
                                            <th rowspan="2" class="align-middle text-center">ì´ê³„</th>
                                        </tr>
                                        <tr>
                                            <th class="text-center" style="font-size:0.7rem;">ì‹ ìƒ</th>
                                            <th class="text-center" style="font-size:0.7rem;">ì†Œì•„</th>
                                            <th class="text-center" style="font-size:0.7rem;">ì‹ ìƒ</th>
                                            <th class="text-center" style="font-size:0.7rem;">ì†Œì•„</th>
                                            <th class="text-center" style="font-size:0.7rem;">ì‹ ìƒ</th>
                                            <th class="text-center" style="font-size:0.7rem;">ì†Œì•„</th>
                                            <th class="text-center" style="font-size:0.7rem;">ì‹ ìƒ</th>
                                            <th class="text-center" style="font-size:0.7rem;">ì†Œì•„</th>
                                        </tr>
                                    </thead>
                                    <tbody id="hospitalSummaryBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="noResultMessage" class="text-center py-5 text-muted">
                    <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M12 6v6l4 2"></path>
                    </svg>
                    <h5 class="mt-3">ì•„ì§ ë°°ì¹˜ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</h5>
                    <p>í•™ìƒ ëª…ë‹¨ì„ ì—…ë¡œë“œí•˜ê³  ë°°ì¹˜ë¥¼ ì‹œì‘í•˜ì„¸ìš”.</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ====== ì „ì—­ ë³€ìˆ˜ ======
        let hospitals = [];
        let students = [];
        let placementResult = [];

        // ë°˜ ëª©ë¡ (í•™ìƒ ì†Œì†)
        const STUDENT_CLASSES = ['C', 'A', 'B'];

        // í‹°ì˜¤ ìŠ¬ë¡¯ (ë°°ì¹˜ ê¸°ê°„)
        const PLACEMENT_SLOTS = ['C', 'A', 'B', 'mixed'];

        // ë°˜ë³„ ì‹¤ìŠµ ê¸°ê°„
        const CLASS_PERIODS = {
            'C': '1-2ì£¼ì°¨',
            'A': '3-4ì£¼ì°¨',
            'B': '5-6ì£¼ì°¨'
        };

        // ====== ì´ˆê¸°í™” ======
        document.addEventListener('DOMContentLoaded', function() {
            loadHospitals();
            initDragDrop();
        });

        // ====== ë³‘ì› ê´€ë¦¬ ======
        const defaultHospitals = [
            {
                name: 'ì„œìš¸ëŒ€ë³‘ì›',
                address: 'ì¢…ë¡œêµ¬',
                C_nicu: 2, C_peds: 2,
                A_nicu: 2, A_peds: 2,
                B_nicu: 2, B_peds: 2,
                mixed_nicu: 1, mixed_peds: 1
            },
            {
                name: 'ì„¸ë¸Œë€ìŠ¤ë³‘ì›',
                address: 'ì„œëŒ€ë¬¸êµ¬',
                C_nicu: 2, C_peds: 2,
                A_nicu: 2, A_peds: 2,
                B_nicu: 2, B_peds: 2,
                mixed_nicu: 1, mixed_peds: 1
            },
            {
                name: 'ì‚¼ì„±ì„œìš¸ë³‘ì›',
                address: 'ê°•ë‚¨êµ¬',
                C_nicu: 2, C_peds: 2,
                A_nicu: 2, A_peds: 2,
                B_nicu: 2, B_peds: 2,
                mixed_nicu: 1, mixed_peds: 1
            },
            {
                name: 'ì„œìš¸ì•„ì‚°ë³‘ì›',
                address: 'ì†¡íŒŒêµ¬',
                C_nicu: 2, C_peds: 2,
                A_nicu: 2, A_peds: 2,
                B_nicu: 2, B_peds: 2,
                mixed_nicu: 1, mixed_peds: 1
            },
            {
                name: 'ê³ ë ¤ëŒ€ì•ˆì•”ë³‘ì›',
                address: 'ì„±ë¶êµ¬',
                C_nicu: 1, C_peds: 1,
                A_nicu: 2, A_peds: 2,
                B_nicu: 0, B_peds: 2,
                mixed_nicu: 1, mixed_peds: 1
            }
        ];

        function loadHospitals() {
            const saved = localStorage.getItem('hospitals_v4');
            hospitals = saved ? JSON.parse(saved) : JSON.parse(JSON.stringify(defaultHospitals));
            renderHospitalTable();
            updateCapacitySummary();
        }

        function renderHospitalTable() {
            const tbody = document.getElementById('hospitalTableBody');
            tbody.innerHTML = hospitals.map((h, idx) => `
                <tr>
                    <td class="hospital-name-cell">
                        <input type="text" value="${h.name}" onchange="updateHospital(${idx}, 'name', this.value)" placeholder="ë³‘ì›ëª…">
                    </td>
                    <td class="hospital-addr-cell">
                        <input type="text" value="${h.address}" onchange="updateHospital(${idx}, 'address', this.value)" placeholder="êµ¬">
                    </td>
                    <td class="to-cell nicu-col"><input type="number" min="0" value="${h.C_nicu}" onchange="updateHospital(${idx}, 'C_nicu', this.value)"></td>
                    <td class="to-cell peds-col"><input type="number" min="0" value="${h.C_peds}" onchange="updateHospital(${idx}, 'C_peds', this.value)"></td>
                    <td class="to-cell nicu-col"><input type="number" min="0" value="${h.A_nicu}" onchange="updateHospital(${idx}, 'A_nicu', this.value)"></td>
                    <td class="to-cell peds-col"><input type="number" min="0" value="${h.A_peds}" onchange="updateHospital(${idx}, 'A_peds', this.value)"></td>
                    <td class="to-cell nicu-col"><input type="number" min="0" value="${h.B_nicu}" onchange="updateHospital(${idx}, 'B_nicu', this.value)"></td>
                    <td class="to-cell peds-col"><input type="number" min="0" value="${h.B_peds}" onchange="updateHospital(${idx}, 'B_peds', this.value)"></td>
                    <td class="to-cell nicu-col"><input type="number" min="0" value="${h.mixed_nicu}" onchange="updateHospital(${idx}, 'mixed_nicu', this.value)"></td>
                    <td class="to-cell peds-col"><input type="number" min="0" value="${h.mixed_peds}" onchange="updateHospital(${idx}, 'mixed_peds', this.value)"></td>
                    <td><button class="btn btn-sm btn-outline-danger" onclick="removeHospital(${idx})">âœ•</button></td>
                </tr>
            `).join('');
        }

        function updateHospital(idx, field, value) {
            if (field === 'name' || field === 'address') {
                hospitals[idx][field] = value;
            } else {
                hospitals[idx][field] = parseInt(value) || 0;
            }
            updateCapacitySummary();
        }

        function updateCapacitySummary() {
            const summary = {};
            PLACEMENT_SLOTS.forEach(slot => {
                summary[slot] = { nicu: 0, peds: 0, total: 0 };
            });

            hospitals.forEach(h => {
                PLACEMENT_SLOTS.forEach(slot => {
                    const nicu = h[`${slot}_nicu`] || 0;
                    const peds = h[`${slot}_peds`] || 0;
                    summary[slot].nicu += nicu;
                    summary[slot].peds += peds;
                    summary[slot].total += nicu + peds;
                });
            });

            const slotLabels = {
                'C': 'Cë°˜ (1-2ì£¼)',
                'A': 'Aë°˜ (3-4ì£¼)',
                'B': 'Bë°˜ (5-6ì£¼)',
                'mixed': '7-8ì£¼ (í˜¼í•©)'
            };

            const container = document.getElementById('capacitySummary');
            container.innerHTML = PLACEMENT_SLOTS.map(slot => {
                return `
                    <div class="capacity-box class-${slot}">
                        <div class="class-name">${slotLabels[slot]}</div>
                        <div class="capacity-total">${summary[slot].total}ëª…</div>
                        <div class="capacity-detail">
                            ì‹ ìƒì•„ì‹¤ ${summary[slot].nicu} / ì†Œì•„ê³¼ ${summary[slot].peds}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function addHospitalRow() {
            hospitals.push({
                name: '',
                address: '',
                C_nicu: 0, C_peds: 0,
                A_nicu: 0, A_peds: 0,
                B_nicu: 0, B_peds: 0,
                mixed_nicu: 0, mixed_peds: 0
            });
            renderHospitalTable();
            updateCapacitySummary();
        }

        function removeHospital(idx) {
            hospitals.splice(idx, 1);
            renderHospitalTable();
            updateCapacitySummary();
        }

        function saveHospitals() {
            localStorage.setItem('hospitals_v4', JSON.stringify(hospitals));
            alert('ë³‘ì› ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }

        function resetHospitals() {
            if (confirm('ë³‘ì› ì„¤ì •ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                hospitals = JSON.parse(JSON.stringify(defaultHospitals));
                renderHospitalTable();
                updateCapacitySummary();
                localStorage.removeItem('hospitals_v4');
            }
        }

        // ====== íŒŒì¼ ì—…ë¡œë“œ ======
        function initDragDrop() {
            const zone = document.getElementById('uploadZone');

            zone.addEventListener('dragover', (e) => {
                e.preventDefault();
                zone.classList.add('dragover');
            });

            zone.addEventListener('dragleave', () => {
                zone.classList.remove('dragover');
            });

            zone.addEventListener('drop', (e) => {
                e.preventDefault();
                zone.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                if (file) processFile(file);
            });
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) processFile(file);
        }

        function processFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(sheet);

                    // ì»¬ëŸ¼ëª… ì •ê·œí™”
                    students = json.map(row => {
                        const normalized = {};
                        for (let key in row) {
                            const lowerKey = key.toLowerCase().trim();
                            if (lowerKey.includes('í•™ë²ˆ') || lowerKey === 'id' || lowerKey === 'studentid' || lowerKey === 'student_id') {
                                normalized.studentId = String(row[key]).trim();
                            } else if (lowerKey.includes('ì´ë¦„') || lowerKey === 'name') {
                                normalized.name = String(row[key]).trim();
                            } else if (lowerKey.includes('ë°˜') || lowerKey === 'class') {
                                let classVal = String(row[key]).toUpperCase().replace('ë°˜', '').trim();
                                normalized.class = classVal;
                            } else if (lowerKey.includes('ì£¼ì†Œ') || lowerKey === 'address') {
                                normalized.address = String(row[key]).trim();
                            }
                        }
                        return normalized;
                    }).filter(s => s.studentId && s.name && s.class && s.address && STUDENT_CLASSES.includes(s.class));

                    if (students.length === 0) {
                        alert('ì˜¬ë°”ë¥¸ í˜•ì‹ì˜ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\ní•„ìˆ˜ ì»¬ëŸ¼: í•™ë²ˆ, ì´ë¦„, ë°˜(A/B/C), ì£¼ì†Œ');
                        return;
                    }

                    showPreview();
                } catch (error) {
                    alert('íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function showPreview() {
            const preview = document.getElementById('uploadPreview');
            const table = document.getElementById('previewTable');

            // ë°˜ë³„ í•™ìƒ ìˆ˜ ê³„ì‚°
            const classCounts = { C: 0, A: 0, B: 0 };
            students.forEach(s => {
                if (classCounts[s.class] !== undefined) {
                    classCounts[s.class]++;
                }
            });

            // ë°˜ë³„ ìš”ì•½ í‘œì‹œ
            document.getElementById('classSummary').innerHTML = `
                <div class="col-4">
                    <div class="stat-card py-2">
                        <div class="number fs-5" style="color: #b45309;">${classCounts.C}</div>
                        <small class="text-muted">Cë°˜ (1-2ì£¼)</small>
                    </div>
                </div>
                <div class="col-4">
                    <div class="stat-card py-2">
                        <div class="number fs-5" style="color: #1d4ed8;">${classCounts.A}</div>
                        <small class="text-muted">Aë°˜ (3-4ì£¼)</small>
                    </div>
                </div>
                <div class="col-4">
                    <div class="stat-card py-2">
                        <div class="number fs-5" style="color: #059669;">${classCounts.B}</div>
                        <small class="text-muted">Bë°˜ (5-6ì£¼)</small>
                    </div>
                </div>
            `;

            // ë°ì´í„°
            table.querySelector('tbody').innerHTML = students.map((s, i) => `
                <tr>
                    <td>${i + 1}</td>
                    <td>${s.studentId}</td>
                    <td>${s.name}</td>
                    <td><span class="badge badge-class-${s.class}">${s.class}ë°˜</span></td>
                    <td>${s.address}</td>
                </tr>
            `).join('');

            preview.style.display = 'block';
        }

        // ====== ë°°ì¹˜ ì•Œê³ ë¦¬ì¦˜ ======
        function runPlacement() {
            if (hospitals.length === 0) {
                alert('ë¨¼ì € ë³‘ì› ì„¤ì •ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”.');
                return;
            }

            document.getElementById('loadingOverlay').classList.add('show');

            setTimeout(() => {
                try {
                    placementResult = performPlacement();
                    showResults();
                } catch (error) {
                    alert('ë°°ì¹˜ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                    console.error(error);
                } finally {
                    document.getElementById('loadingOverlay').classList.remove('show');
                }
            }, 500);
        }

        function performPlacement() {
            const results = [];
            const unplacedStudents = []; // ì •ê·œ ê¸°ê°„ì— ë°°ì¹˜ ëª»í•œ í•™ìƒë“¤

            // ë³‘ì›ë³„ ì”ì—¬ ì •ì› ë³µì‚¬
            const remaining = hospitals.map(h => {
                const r = { name: h.name, address: h.address };
                PLACEMENT_SLOTS.forEach(slot => {
                    r[`${slot}_nicu`] = h[`${slot}_nicu`] || 0;
                    r[`${slot}_peds`] = h[`${slot}_peds`] || 0;
                });
                return r;
            });

            // ë°˜ë³„ë¡œ í•™ìƒ ê·¸ë£¹í™”
            const studentsByClass = {};
            STUDENT_CLASSES.forEach(c => studentsByClass[c] = []);

            students.forEach(s => {
                if (studentsByClass[s.class]) {
                    studentsByClass[s.class].push({ ...s });
                }
            });

            // 1ë‹¨ê³„: ì •ê·œ ê¸°ê°„ ë°°ì¹˜ (Cë°˜ â†’ Aë°˜ â†’ Bë°˜)
            for (const classId of STUDENT_CLASSES) {
                const classStudents = studentsByClass[classId];
                if (classStudents.length === 0) continue;

                // ì£¼ì†Œ ê¸°ë°˜ ë³‘ì› ë§¤ì¹­ ì ìˆ˜ ê³„ì‚° í›„ ì •ë ¬
                classStudents.forEach(student => {
                    student.hospitalScores = remaining.map((h, idx) => ({
                        idx,
                        hospital: h,
                        score: calculateAddressScore(student.address, h.address)
                    })).sort((a, b) => b.score - a.score);
                });

                // ì‹ ìƒì•„ì‹¤ê³¼ ì†Œì•„ê³¼ë¥¼ ê· í˜•ìˆê²Œ ë°°ì¹˜
                let nicuFirst = true;

                for (const student of classStudents) {
                    let placed = false;
                    const deptOrder = nicuFirst ? ['nicu', 'peds'] : ['peds', 'nicu'];
                    nicuFirst = !nicuFirst;

                    // ì ìˆ˜ ë†’ì€ ë³‘ì›ë¶€í„° ì‹œë„ (í•´ë‹¹ ë°˜ ì •ê·œ í‹°ì˜¤ ì‚¬ìš©)
                    for (const { idx } of student.hospitalScores) {
                        const hospital = remaining[idx];

                        for (const dept of deptOrder) {
                            const key = `${classId}_${dept}`;
                            if (hospital[key] > 0) {
                                hospital[key]--;

                                results.push({
                                    studentId: student.studentId,
                                    name: student.name,
                                    class: student.class,
                                    period: CLASS_PERIODS[student.class],
                                    placementSlot: classId,
                                    isMixed: false,
                                    address: student.address,
                                    hospital: hospital.name,
                                    department: dept === 'nicu' ? 'ì‹ ìƒì•„ì‹¤' : 'ì†Œì•„ê³¼',
                                    deptKey: dept,
                                    status: 'ë°°ì¹˜ì™„ë£Œ'
                                });

                                placed = true;
                                break;
                            }
                        }
                        if (placed) break;
                    }

                    // ì •ê·œ ê¸°ê°„ ë°°ì¹˜ ì‹¤íŒ¨ â†’ 7-8ì£¼ì°¨ í˜¼í•© ëŒ€ê¸°ì—´ì— ì¶”ê°€
                    if (!placed) {
                        unplacedStudents.push(student);
                    }
                }
            }

            // 2ë‹¨ê³„: 7-8ì£¼ì°¨ í˜¼í•© ë°°ì¹˜ (ì •ê·œ ê¸°ê°„ì— ë°°ì¹˜ ëª»í•œ í•™ìƒë“¤)
            let nicuFirst = true;
            for (const student of unplacedStudents) {
                let placed = false;
                const deptOrder = nicuFirst ? ['nicu', 'peds'] : ['peds', 'nicu'];
                nicuFirst = !nicuFirst;

                // ì£¼ì†Œ ì ìˆ˜ ë‹¤ì‹œ ê³„ì‚°
                const hospitalScores = remaining.map((h, idx) => ({
                    idx,
                    hospital: h,
                    score: calculateAddressScore(student.address, h.address)
                })).sort((a, b) => b.score - a.score);

                for (const { idx } of hospitalScores) {
                    const hospital = remaining[idx];

                    for (const dept of deptOrder) {
                        const key = `mixed_${dept}`;
                        if (hospital[key] > 0) {
                            hospital[key]--;

                            results.push({
                                studentId: student.studentId,
                                name: student.name,
                                class: student.class,
                                period: '7-8ì£¼ì°¨',
                                placementSlot: 'mixed',
                                isMixed: true,
                                address: student.address,
                                hospital: hospital.name,
                                department: dept === 'nicu' ? 'ì‹ ìƒì•„ì‹¤' : 'ì†Œì•„ê³¼',
                                deptKey: dept,
                                status: 'ë°°ì¹˜ì™„ë£Œ'
                            });

                            placed = true;
                            break;
                        }
                    }
                    if (placed) break;
                }

                // í˜¼í•© ë°°ì¹˜ë„ ì‹¤íŒ¨
                if (!placed) {
                    results.push({
                        studentId: student.studentId,
                        name: student.name,
                        class: student.class,
                        period: '-',
                        placementSlot: null,
                        isMixed: false,
                        address: student.address,
                        hospital: '-',
                        department: '-',
                        deptKey: null,
                        status: 'ë¯¸ë°°ì¹˜'
                    });
                }
            }

            return results;
        }

        function calculateAddressScore(studentAddr, hospitalAddr) {
            const studentParts = extractAddressParts(studentAddr);
            const hospitalParts = extractAddressParts(hospitalAddr);

            let score = 0;

            // êµ¬ê°€ ê°™ìœ¼ë©´ ë†’ì€ ì ìˆ˜
            if (studentParts.gu && hospitalParts.gu && studentParts.gu === hospitalParts.gu) {
                score += 100;
            }

            // ì¸ì ‘ êµ¬ ë³´ë„ˆìŠ¤
            const adjacent = {
                'ê°•ë‚¨êµ¬': ['ì„œì´ˆêµ¬', 'ì†¡íŒŒêµ¬', 'ê°•ë™êµ¬'],
                'ì„œì´ˆêµ¬': ['ê°•ë‚¨êµ¬', 'ë™ì‘êµ¬', 'ê´€ì•…êµ¬'],
                'ì†¡íŒŒêµ¬': ['ê°•ë‚¨êµ¬', 'ê°•ë™êµ¬', 'ê´‘ì§„êµ¬'],
                'ê°•ë™êµ¬': ['ì†¡íŒŒêµ¬', 'ê´‘ì§„êµ¬', 'ê°•ë‚¨êµ¬'],
                'ì¢…ë¡œêµ¬': ['ì„±ë¶êµ¬', 'ë™ëŒ€ë¬¸êµ¬', 'ì¤‘êµ¬', 'ì„œëŒ€ë¬¸êµ¬'],
                'ì„œëŒ€ë¬¸êµ¬': ['ì¢…ë¡œêµ¬', 'ë§ˆí¬êµ¬', 'ì€í‰êµ¬'],
                'ì„±ë¶êµ¬': ['ì¢…ë¡œêµ¬', 'ë™ëŒ€ë¬¸êµ¬', 'ê°•ë¶êµ¬', 'ë…¸ì›êµ¬'],
                'ë§ˆí¬êµ¬': ['ì„œëŒ€ë¬¸êµ¬', 'ìš©ì‚°êµ¬', 'ì€í‰êµ¬'],
                'ìš©ì‚°êµ¬': ['ë§ˆí¬êµ¬', 'ì¤‘êµ¬', 'ì„±ë™êµ¬'],
                'ì¤‘êµ¬': ['ì¢…ë¡œêµ¬', 'ìš©ì‚°êµ¬', 'ì„±ë™êµ¬', 'ë™ëŒ€ë¬¸êµ¬'],
                'ë™ëŒ€ë¬¸êµ¬': ['ì¤‘êµ¬', 'ì¢…ë¡œêµ¬', 'ì„±ë¶êµ¬', 'ê´‘ì§„êµ¬'],
                'ê´‘ì§„êµ¬': ['ë™ëŒ€ë¬¸êµ¬', 'ì„±ë™êµ¬', 'ì†¡íŒŒêµ¬', 'ê°•ë™êµ¬'],
                'ì„±ë™êµ¬': ['ê´‘ì§„êµ¬', 'ì¤‘êµ¬', 'ìš©ì‚°êµ¬', 'ë™ëŒ€ë¬¸êµ¬'],
                'ê°•ë¶êµ¬': ['ë…¸ì›êµ¬', 'ë„ë´‰êµ¬', 'ì„±ë¶êµ¬'],
                'ë…¸ì›êµ¬': ['ë„ë´‰êµ¬', 'ê°•ë¶êµ¬', 'ì„±ë¶êµ¬', 'ì¤‘ë‘êµ¬'],
                'ë„ë´‰êµ¬': ['ë…¸ì›êµ¬', 'ê°•ë¶êµ¬'],
                'ì¤‘ë‘êµ¬': ['ë…¸ì›êµ¬', 'ë™ëŒ€ë¬¸êµ¬', 'ê´‘ì§„êµ¬'],
                'ì€í‰êµ¬': ['ì„œëŒ€ë¬¸êµ¬', 'ë§ˆí¬êµ¬'],
                'ë™ì‘êµ¬': ['ì„œì´ˆêµ¬', 'ê´€ì•…êµ¬', 'ì˜ë“±í¬êµ¬'],
                'ê´€ì•…êµ¬': ['ì„œì´ˆêµ¬', 'ë™ì‘êµ¬', 'ê¸ˆì²œêµ¬'],
                'ì˜ë“±í¬êµ¬': ['ë™ì‘êµ¬', 'ì–‘ì²œêµ¬', 'ê°•ì„œêµ¬', 'êµ¬ë¡œêµ¬'],
                'ì–‘ì²œêµ¬': ['ì˜ë“±í¬êµ¬', 'ê°•ì„œêµ¬', 'êµ¬ë¡œêµ¬'],
                'ê°•ì„œêµ¬': ['ì–‘ì²œêµ¬', 'ì˜ë“±í¬êµ¬'],
                'êµ¬ë¡œêµ¬': ['ì˜ë“±í¬êµ¬', 'ì–‘ì²œêµ¬', 'ê¸ˆì²œêµ¬'],
                'ê¸ˆì²œêµ¬': ['êµ¬ë¡œêµ¬', 'ê´€ì•…êµ¬']
            };

            if (adjacent[studentParts.gu] && adjacent[studentParts.gu].includes(hospitalParts.gu)) {
                score += 50;
            }

            // ê¸°ë³¸ ì ìˆ˜ (ì•ˆì •ì ì¸ ì •ë ¬ì„ ìœ„í•´)
            score += Math.random() * 5;

            return score;
        }

        function extractAddressParts(address) {
            const parts = { gu: null, dong: null };
            if (!address) return parts;

            const guMatch = address.match(/([ê°€-í£]+êµ¬)/);
            const dongMatch = address.match(/([ê°€-í£]+[ë™ìë©´])/);

            if (guMatch) parts.gu = guMatch[1];
            if (dongMatch) parts.dong = dongMatch[1];

            return parts;
        }

        // ====== ê²°ê³¼ í‘œì‹œ ======
        function showResults() {
            document.getElementById('noResultMessage').style.display = 'none';
            document.getElementById('resultContent').style.display = 'block';

            // í†µê³„ ì—…ë°ì´íŠ¸
            const total = students.length;
            const placed = placementResult.filter(r => r.status === 'ë°°ì¹˜ì™„ë£Œ').length;
            const unplaced = total - placed;
            const rate = total > 0 ? Math.round((placed / total) * 100) : 0;

            document.getElementById('statTotal').textContent = total;
            document.getElementById('statPlaced').textContent = placed;
            document.getElementById('statUnplaced').textContent = unplaced;
            document.getElementById('statRate').textContent = rate + '%';

            // ê²°ê³¼ í…Œì´ë¸”
            filterResult('all');

            // ë³‘ì›ë³„ í˜„í™©
            showHospitalSummary();

            // ê²°ê³¼ íƒ­ìœ¼ë¡œ ì´ë™
            document.getElementById('result-tab').click();
        }

        function filterResult(filter) {
            // ë²„íŠ¼ í™œì„±í™”
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.filter === filter) btn.classList.add('active');
            });

            let filtered;
            if (filter === 'all') {
                filtered = placementResult;
            } else if (filter === 'nicu') {
                filtered = placementResult.filter(r => r.deptKey === 'nicu');
            } else if (filter === 'peds') {
                filtered = placementResult.filter(r => r.deptKey === 'peds');
            } else if (filter === 'regular') {
                filtered = placementResult.filter(r => !r.isMixed && r.status === 'ë°°ì¹˜ì™„ë£Œ');
            } else if (filter === 'mixed') {
                filtered = placementResult.filter(r => r.isMixed);
            } else {
                // A, B, C ë°˜ í•„í„°
                filtered = placementResult.filter(r => r.class === filter);
            }

            document.getElementById('resultCount').textContent = filtered.length + 'ëª…';

            const tbody = document.getElementById('resultTableBody');
            tbody.innerHTML = filtered.map(r => `
                <tr class="${r.status === 'ë¯¸ë°°ì¹˜' ? 'table-danger' : r.isMixed ? 'table-warning' : ''}">
                    <td>${r.studentId}</td>
                    <td>${r.name}</td>
                    <td><span class="badge badge-class-${r.class}">${r.class}ë°˜</span></td>
                    <td><span class="badge ${r.isMixed ? 'period-mixed' : 'bg-secondary'} period-badge">${r.period}</span></td>
                    <td>${r.address}</td>
                    <td>${r.hospital}</td>
                    <td>
                        ${r.department !== '-' ?
                            `<span class="badge ${r.deptKey === 'nicu' ? 'dept-nicu' : 'dept-peds'}">${r.department}</span>`
                            : '-'}
                    </td>
                    <td>
                        <span class="badge ${r.status === 'ë°°ì¹˜ì™„ë£Œ' ? (r.isMixed ? 'bg-warning text-dark' : 'bg-success') : 'bg-danger'}">
                            ${r.status}${r.isMixed ? ' (í˜¼í•©)' : ''}
                        </span>
                    </td>
                </tr>
            `).join('');
        }

        function showHospitalSummary() {
            const summary = {};

            hospitals.forEach(h => {
                summary[h.name] = {};
                PLACEMENT_SLOTS.forEach(slot => {
                    summary[h.name][slot] = {
                        nicu: { placed: 0, total: h[`${slot}_nicu`] || 0 },
                        peds: { placed: 0, total: h[`${slot}_peds`] || 0 }
                    };
                });
            });

            placementResult.forEach(r => {
                if (r.hospital !== '-' && summary[r.hospital] && r.placementSlot) {
                    const slot = r.placementSlot;
                    if (summary[r.hospital][slot]) {
                        if (r.deptKey === 'nicu') {
                            summary[r.hospital][slot].nicu.placed++;
                        } else if (r.deptKey === 'peds') {
                            summary[r.hospital][slot].peds.placed++;
                        }
                    }
                }
            });

            const tbody = document.getElementById('hospitalSummaryBody');
            tbody.innerHTML = Object.entries(summary).map(([name, data]) => {
                let totalPlaced = 0;
                let cells = '';

                PLACEMENT_SLOTS.forEach(slot => {
                    const nicu = data[slot].nicu;
                    const peds = data[slot].peds;
                    totalPlaced += nicu.placed + peds.placed;

                    const nicuFull = nicu.placed >= nicu.total && nicu.total > 0;
                    const pedsFull = peds.placed >= peds.total && peds.total > 0;

                    cells += `
                        <td class="text-center ${nicuFull ? 'text-success fw-bold' : ''}" style="font-size:0.8rem;">
                            ${nicu.total > 0 ? `${nicu.placed}/${nicu.total}` : '-'}
                        </td>
                        <td class="text-center ${pedsFull ? 'text-success fw-bold' : ''}" style="font-size:0.8rem;">
                            ${peds.total > 0 ? `${peds.placed}/${peds.total}` : '-'}
                        </td>
                    `;
                });

                return `
                    <tr>
                        <td>${name}</td>
                        ${cells}
                        <td class="text-center"><strong>${totalPlaced}ëª…</strong></td>
                    </tr>
                `;
            }).join('');
        }

        // ====== ê²°ê³¼ ë‹¤ìš´ë¡œë“œ ======
        function downloadResult() {
            if (placementResult.length === 0) {
                alert('ë‹¤ìš´ë¡œë“œí•  ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const ws = XLSX.utils.json_to_sheet(placementResult.map(r => ({
                'í•™ë²ˆ': r.studentId,
                'ì´ë¦„': r.name,
                'ë°˜': r.class + 'ë°˜',
                'ì‹¤ìŠµê¸°ê°„': r.period,
                'ë°°ì¹˜ìœ í˜•': r.isMixed ? '7-8ì£¼ í˜¼í•©' : 'ì •ê·œë°°ì¹˜',
                'ì£¼ì†Œ': r.address,
                'ë°°ì •ë³‘ì›': r.hospital,
                'ì‹¤ìŠµë¶€ì„œ': r.department,
                'ìƒíƒœ': r.status
            })));

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'ë°°ì¹˜ê²°ê³¼');

            // ë³‘ì›ë³„ ìš”ì•½ ì‹œíŠ¸
            const summaryData = [];
            const slotLabels = { 'C': 'Cë°˜(1-2ì£¼)', 'A': 'Aë°˜(3-4ì£¼)', 'B': 'Bë°˜(5-6ì£¼)', 'mixed': '7-8ì£¼(í˜¼í•©)' };

            hospitals.forEach(h => {
                const row = { 'ë³‘ì›ëª…': h.name };
                PLACEMENT_SLOTS.forEach(slot => {
                    const placed = placementResult.filter(r => r.hospital === h.name && r.placementSlot === slot);
                    row[`${slotLabels[slot]}_ì‹ ìƒì•„ì‹¤`] = `${placed.filter(r => r.deptKey === 'nicu').length}/${h[`${slot}_nicu`] || 0}`;
                    row[`${slotLabels[slot]}_ì†Œì•„ê³¼`] = `${placed.filter(r => r.deptKey === 'peds').length}/${h[`${slot}_peds`] || 0}`;
                });
                summaryData.push(row);
            });
            const ws2 = XLSX.utils.json_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, ws2, 'ë³‘ì›ë³„í˜„í™©');

            XLSX.writeFile(wb, 'ì‹¤ìŠµë°°ì¹˜ê²°ê³¼_' + new Date().toISOString().slice(0,10) + '.xlsx');
        }
    </script>
</body>
</html>
