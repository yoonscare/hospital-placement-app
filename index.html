<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì„ìƒì‹¤ìŠµ ë°°ì¹˜ ì‹œìŠ¤í…œ | ê°„í˜¸í•™ê³¼</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #818cf8;
            --bg-gradient: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        }

        * {
            font-family: 'Noto Sans KR', sans-serif;
        }

        body {
            background: #f8fafc;
            min-height: 100vh;
        }

        .header {
            background: var(--bg-gradient);
            color: white;
            padding: 1.5rem 0;
            margin-bottom: 2rem;
        }

        .header h1 {
            font-weight: 700;
            margin-bottom: 0.25rem;
            font-size: 1.75rem;
        }

        .header-actions {
            display: flex;
            gap: 0.5rem;
        }

        .header-actions .btn {
            padding: 0.4rem 0.75rem;
            font-size: 0.85rem;
        }

        .card {
            border: none;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-bottom: 1.5rem;
        }

        .card-header {
            background: white;
            border-bottom: 1px solid #e2e8f0;
            border-radius: 16px 16px 0 0 !important;
            font-weight: 600;
            padding: 1rem 1.5rem;
        }

        .btn-primary {
            background: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            border-color: var(--primary-dark);
        }

        .upload-zone {
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            padding: 2.5rem 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8fafc;
        }

        .upload-zone:hover, .upload-zone.dragover {
            border-color: var(--primary-color);
            background: #eef2ff;
        }

        .setting-input {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 0.5rem 1rem;
        }

        .setting-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .dept-tag {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            margin: 0.25rem;
            font-size: 0.85rem;
            background: #e0e7ff;
            color: #4338ca;
        }

        .dept-tag button {
            background: none;
            border: none;
            color: #6366f1;
            margin-left: 0.5rem;
            cursor: pointer;
            font-weight: bold;
        }

        .hospital-table {
            font-size: 0.8rem;
        }

        .hospital-table input[type="text"] {
            width: 100%;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 0.4rem 0.6rem;
            font-size: 0.85rem;
        }

        .hospital-table input[type="number"] {
            width: 50px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            padding: 0.25rem;
            text-align: center;
            font-size: 0.8rem;
        }

        .hospital-table input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.1);
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .stat-card .number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .stat-card .label {
            color: #64748b;
            font-size: 0.9rem;
        }

        .result-table {
            font-size: 0.85rem;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            display: none;
        }

        .loading-overlay.show {
            display: flex;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e2e8f0;
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .nav-tabs .nav-link {
            color: #64748b;
            border: none;
            padding: 1rem 1.25rem;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .nav-tabs .nav-link.active {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
            background: transparent;
        }

        .filter-btn {
            border: 1px solid #e2e8f0;
            background: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
            transition: all 0.2s;
            font-size: 0.85rem;
        }

        .filter-btn:hover, .filter-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .table-scroll-wrapper {
            overflow-x: auto;
            max-width: 100%;
        }

        .capacity-summary {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .capacity-box {
            background: white;
            border-radius: 8px;
            padding: 0.75rem 1rem;
            text-align: center;
            border: 1px solid #e2e8f0;
            min-width: 120px;
        }

        .capacity-box .class-name {
            font-weight: 600;
            font-size: 0.85rem;
            margin-bottom: 0.25rem;
        }

        .capacity-box .capacity-total {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .capacity-box .capacity-detail {
            font-size: 0.7rem;
            color: #64748b;
        }

        .schedule-preview {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
        }

        .schedule-item {
            display: inline-flex;
            align-items: center;
            padding: 0.4rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            margin: 0.25rem;
            font-size: 0.85rem;
        }

        .info-box {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            color: #1e40af;
            border-radius: 8px;
            padding: 1rem;
            font-size: 0.9rem;
        }

        .warning-box {
            background: #fef3c7;
            border: 1px solid #fde68a;
            color: #92400e;
            border-radius: 8px;
            padding: 1rem;
            font-size: 0.9rem;
        }

        .success-box {
            background: #d1fae5;
            border: 1px solid #6ee7b7;
            color: #065f46;
            border-radius: 8px;
            padding: 1rem;
            font-size: 0.9rem;
        }

        .preset-btn {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 0.75rem 1rem;
            text-align: left;
            transition: all 0.2s;
            cursor: pointer;
            width: 100%;
        }

        .preset-btn:hover {
            border-color: var(--primary-color);
            background: #eef2ff;
        }

        .preset-btn .preset-title {
            font-weight: 600;
            color: #1f2937;
        }

        .preset-btn .preset-desc {
            font-size: 0.8rem;
            color: #64748b;
        }

        .step-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            font-size: 0.75rem;
            font-weight: 600;
            margin-right: 0.5rem;
        }

        .help-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            border: none;
            font-size: 1.5rem;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
            cursor: pointer;
            z-index: 1000;
        }

        .help-btn:hover {
            background: var(--primary-dark);
            transform: scale(1.05);
        }

        .modal-header {
            background: var(--bg-gradient);
            color: white;
        }

        .modal-header .btn-close {
            filter: brightness(0) invert(1);
        }

        .guide-step {
            display: flex;
            align-items: flex-start;
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .guide-step:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .guide-step-number {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            flex-shrink: 0;
            margin-right: 1rem;
        }

        .guide-step-content h6 {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .class-group-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .current-settings {
            background: #f8fafc;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .current-settings h6 {
            font-size: 0.85rem;
            color: #64748b;
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="text-center">
            <div class="spinner mx-auto mb-3"></div>
            <p class="text-muted">ë°°ì¹˜ ì²˜ë¦¬ ì¤‘...</p>
        </div>
    </div>

    <header class="header">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center flex-wrap">
                <div>
                    <h1>ğŸ¥ ì„ìƒì‹¤ìŠµ ë°°ì¹˜ ì‹œìŠ¤í…œ</h1>
                    <p class="mb-0 opacity-75 small">ëª¨ë“  ì‹¤ìŠµê³¼ëª©ì„ ìœ„í•œ ìŠ¤ë§ˆíŠ¸ ë³‘ì› ë°°ì •</p>
                </div>
                <div class="header-actions mt-2 mt-md-0">
                    <button class="btn btn-outline-light btn-sm" onclick="exportAllSettings()">
                        ğŸ“¤ ì„¤ì • ë‚´ë³´ë‚´ê¸°
                    </button>
                    <button class="btn btn-outline-light btn-sm" onclick="document.getElementById('importFile').click()">
                        ğŸ“¥ ì„¤ì • ê°€ì ¸ì˜¤ê¸°
                    </button>
                    <input type="file" id="importFile" accept=".json" style="display:none" onchange="importSettings(event)">
                    <button class="btn btn-light btn-sm" onclick="showGuide()">
                        â“ ì‚¬ìš©ë²•
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="container pb-5">
        <!-- í˜„ì¬ ì„¤ì • ìš”ì•½ -->
        <div class="info-box mb-4" id="currentSettingSummary">
            <div class="d-flex justify-content-between align-items-center flex-wrap">
                <div>
                    <strong id="summarySubject">ì„¤ì • í•„ìš”</strong>
                    <span class="text-muted mx-2">|</span>
                    <span id="summaryClasses">ë¶„ë°˜: -</span>
                    <span class="text-muted mx-2">|</span>
                    <span id="summaryDepts">ë³‘ë™: -</span>
                    <span class="text-muted mx-2">|</span>
                    <span id="summaryHospitals">ë³‘ì›: 0ê°œ</span>
                </div>
                <button class="btn btn-sm btn-outline-primary mt-2 mt-md-0" onclick="document.getElementById('setup-tab').click()">
                    ì„¤ì • ë³€ê²½
                </button>
            </div>
        </div>

        <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
        <ul class="nav nav-tabs mb-4" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="setup-tab" data-bs-toggle="tab" data-bs-target="#setup-panel" type="button">
                    <span class="step-badge">1</span> ê³¼ëª© ì„¤ì •
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="hospital-tab" data-bs-toggle="tab" data-bs-target="#hospital-panel" type="button">
                    <span class="step-badge">2</span> ë³‘ì› í‹°ì˜¤
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload-panel" type="button">
                    <span class="step-badge">3</span> í•™ìƒ ì—…ë¡œë“œ
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="result-tab" data-bs-toggle="tab" data-bs-target="#result-panel" type="button">
                    <span class="step-badge">4</span> ë°°ì¹˜ ê²°ê³¼
                </button>
            </li>
        </ul>

        <div class="tab-content" id="mainTabContent">
            <!-- ê³¼ëª©/ë¶„ë°˜ ì„¤ì • íƒ­ -->
            <div class="tab-pane fade show active" id="setup-panel" role="tabpanel">
                <!-- ë¹ ë¥¸ ì„¤ì • í”„ë¦¬ì…‹ -->
                <div class="card">
                    <div class="card-header">âš¡ ë¹ ë¥¸ ì„¤ì • (í”„ë¦¬ì…‹ ì„ íƒ)</div>
                    <div class="card-body">
                        <div class="row g-2">
                            <div class="col-md-4 col-6">
                                <button class="preset-btn" onclick="applyPreset('pediatric')">
                                    <div class="preset-title">ğŸ‘¶ ì•„ë™ê°„í˜¸í•™ì‹¤ìŠµ</div>
                                    <div class="preset-desc">A/B/Cë°˜, ì‹ ìƒì•„ì‹¤/ì†Œì•„ê³¼</div>
                                </button>
                            </div>
                            <div class="col-md-4 col-6">
                                <button class="preset-btn" onclick="applyPreset('adult')">
                                    <div class="preset-title">ğŸ¥ ì„±ì¸ê°„í˜¸í•™ì‹¤ìŠµ</div>
                                    <div class="preset-desc">A/B/Cë°˜, ë‚´ê³¼/ì™¸ê³¼ë³‘ë™</div>
                                </button>
                            </div>
                            <div class="col-md-4 col-6">
                                <button class="preset-btn" onclick="applyPreset('psychiatric')">
                                    <div class="preset-title">ğŸ§  ì •ì‹ ê°„í˜¸í•™ì‹¤ìŠµ</div>
                                    <div class="preset-desc">A/Bë°˜, íì‡„/ê°œë°©ë³‘ë™</div>
                                </button>
                            </div>
                            <div class="col-md-4 col-6">
                                <button class="preset-btn" onclick="applyPreset('maternity')">
                                    <div class="preset-title">ğŸ¤° ëª¨ì„±ê°„í˜¸í•™ì‹¤ìŠµ</div>
                                    <div class="preset-desc">A/B/Cë°˜, ë¶„ë§Œì‹¤/ì‚°í›„ì¡°ë¦¬</div>
                                </button>
                            </div>
                            <div class="col-md-4 col-6">
                                <button class="preset-btn" onclick="applyPreset('community')">
                                    <div class="preset-title">ğŸ˜ï¸ ì§€ì—­ì‚¬íšŒê°„í˜¸í•™ì‹¤ìŠµ</div>
                                    <div class="preset-desc">A/Bë°˜, ë³´ê±´ì†Œ/ë°©ë¬¸ê°„í˜¸</div>
                                </button>
                            </div>
                            <div class="col-md-4 col-6">
                                <button class="preset-btn" onclick="applyPreset('custom')">
                                    <div class="preset-title">âœï¸ ì§ì ‘ ì„¤ì •</div>
                                    <div class="preset-desc">ê³¼ëª©/ë¶„ë°˜/ë³‘ë™ ì§ì ‘ ì…ë ¥</div>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">ğŸ“š ì‹¤ìŠµê³¼ëª© ê¸°ë³¸ ì„¤ì •</div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">ê³¼ëª©ëª… <span class="text-danger">*</span></label>
                                <input type="text" class="form-control setting-input" id="subjectName"
                                       placeholder="ì˜ˆ: ì„±ì¸ê°„í˜¸í•™ì‹¤ìŠµ" value="" onchange="updateSummary()">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-bold">ì „ì²´ ì‹¤ìŠµ ì£¼ì°¨</label>
                                <input type="number" class="form-control setting-input" id="totalWeeks"
                                       min="1" max="16" value="8" onchange="updateScheduleDisplay()">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-bold">ë¶„ë°˜ë‹¹ ì‹¤ìŠµ ì£¼</label>
                                <input type="number" class="form-control setting-input" id="weeksPerClass"
                                       min="1" max="8" value="2" onchange="updateScheduleDisplay()">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span>ğŸ‘¥ ë¶„ë°˜ ì„¤ì •</span>
                                <button class="btn btn-sm btn-outline-primary" onclick="addClassGroup()">+ ì¶”ê°€</button>
                            </div>
                            <div class="card-body">
                                <div id="classGroupList"></div>
                                <div class="mt-2">
                                    <button class="btn btn-outline-secondary btn-sm" onclick="addPresetClasses('ABC')">A,B,Cë°˜</button>
                                    <button class="btn btn-outline-secondary btn-sm" onclick="addPresetClasses('ABCD')">A,B,C,Dë°˜</button>
                                    <button class="btn btn-outline-secondary btn-sm" onclick="addPresetClasses('12')">1,2ë¶„ë°˜</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span>ğŸ¥ ì‹¤ìŠµ ë³‘ë™/ë¶€ì„œ</span>
                                <button class="btn btn-sm btn-outline-primary" onclick="addDepartment()">+ ì¶”ê°€</button>
                            </div>
                            <div class="card-body">
                                <div id="departmentList" class="mb-2"></div>
                                <div class="mt-2">
                                    <button class="btn btn-outline-secondary btn-sm" onclick="addPresetDepts('peds')">ì‹ ìƒì•„ì‹¤/ì†Œì•„ê³¼</button>
                                    <button class="btn btn-outline-secondary btn-sm" onclick="addPresetDepts('adult')">ë‚´ê³¼/ì™¸ê³¼</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ìŠ¤ì¼€ì¤„ ë¯¸ë¦¬ë³´ê¸° -->
                <div class="schedule-preview" id="schedulePreview">
                    <h6 class="mb-3"><strong>ğŸ“… ì‹¤ìŠµ ìŠ¤ì¼€ì¤„ ë¯¸ë¦¬ë³´ê¸°</strong></h6>
                    <div id="scheduleDisplay"></div>
                </div>

                <div class="d-flex justify-content-between">
                    <button class="btn btn-outline-secondary" onclick="resetSettings()">ì´ˆê¸°í™”</button>
                    <button class="btn btn-primary btn-lg" onclick="saveAndNext()">ì„¤ì • ì™„ë£Œ â†’ ë³‘ì› í‹°ì˜¤ ì„¤ì •</button>
                </div>
            </div>

            <!-- ë³‘ì› ì„¤ì • íƒ­ -->
            <div class="tab-pane fade" id="hospital-panel" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center flex-wrap">
                        <span>ğŸ¥ ì‹¤ìŠµ ë³‘ì› ë° í‹°ì˜¤ ì„¤ì •</span>
                        <div class="mt-2 mt-md-0">
                            <button class="btn btn-sm btn-outline-secondary me-1" onclick="downloadHospitalTemplate()">ğŸ“‹ í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ</button>
                            <button class="btn btn-sm btn-outline-primary" onclick="addHospitalRow()">+ ë³‘ì› ì¶”ê°€</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="info-box mb-3">
                            ğŸ’¡ ê° ë³‘ì›ì˜ <strong>ë¶„ë°˜ë³„ Ã— ë³‘ë™ë³„</strong> ì •ì›(í‹°ì˜¤)ì„ ì…ë ¥í•˜ì„¸ìš”.
                        </div>
                        <div class="table-scroll-wrapper">
                            <table class="table table-bordered hospital-table mb-0" id="hospitalTable">
                                <thead id="hospitalTableHead"></thead>
                                <tbody id="hospitalTableBody"></tbody>
                            </table>
                        </div>

                        <div class="capacity-summary" id="capacitySummary"></div>

                        <div class="d-flex justify-content-between mt-3">
                            <button class="btn btn-outline-secondary" onclick="resetHospitals()">ì´ˆê¸°í™”</button>
                            <div>
                                <button class="btn btn-outline-primary me-2" onclick="saveHospitals()">ğŸ’¾ ì €ì¥</button>
                                <button class="btn btn-primary btn-lg" onclick="saveHospitalsAndNext()">ì™„ë£Œ â†’ í•™ìƒ ì—…ë¡œë“œ</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- í•™ìƒ ì—…ë¡œë“œ íƒ­ -->
            <div class="tab-pane fade" id="upload-panel" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>ğŸ“„ í•™ìƒ ëª…ë‹¨ ì—…ë¡œë“œ</span>
                        <button class="btn btn-sm btn-outline-secondary" onclick="downloadStudentTemplate()">ğŸ“‹ í•™ìƒ í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ</button>
                    </div>
                    <div class="card-body">
                        <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
                            <div class="mb-3">
                                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#818cf8" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="17 8 12 3 7 8"></polyline>
                                    <line x1="12" y1="3" x2="12" y2="15"></line>
                                </svg>
                            </div>
                            <h5>ì—‘ì…€ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ</h5>
                            <p class="text-muted mb-0 small">ì§€ì› í˜•ì‹: .xlsx, .xls, .csv</p>
                        </div>
                        <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" style="display: none;" onchange="handleFileUpload(event)">

                        <div class="info-box mt-3">
                            <strong>ğŸ“‹ í•„ìˆ˜ ì»¬ëŸ¼:</strong> í•™ë²ˆ, ì´ë¦„, ë°˜ (<span id="validClassNames">A/B/C</span>), ì£¼ì†Œ (êµ¬/ì‹œ í¬í•¨)
                        </div>

                        <div id="uploadPreview" style="display: none;">
                            <h5 class="mt-4 mb-3">ğŸ“Š ì—…ë¡œë“œëœ í•™ìƒ ëª…ë‹¨</h5>
                            <div class="row mb-3" id="classSummary"></div>
                            <div class="table-responsive" style="max-height: 350px; overflow-y: auto;">
                                <table class="table table-sm table-bordered" id="previewTable">
                                    <thead class="table-light" style="position: sticky; top: 0;">
                                        <tr>
                                            <th>#</th>
                                            <th>í•™ë²ˆ</th>
                                            <th>ì´ë¦„</th>
                                            <th>ë°˜</th>
                                            <th>ì£¼ì†Œ</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                            <div class="text-end mt-3">
                                <button class="btn btn-lg btn-primary" onclick="runPlacement()">
                                    ğŸš€ ë°°ì¹˜ ì‹œì‘í•˜ê¸°
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ë°°ì¹˜ ê²°ê³¼ íƒ­ -->
            <div class="tab-pane fade" id="result-panel" role="tabpanel">
                <div id="resultContent" style="display: none;">
                    <div class="row mb-4" id="statsRow">
                        <div class="col-md-3 col-6 mb-3">
                            <div class="stat-card">
                                <div class="number" id="statTotal">0</div>
                                <div class="label">ì „ì²´ í•™ìƒ</div>
                            </div>
                        </div>
                        <div class="col-md-3 col-6 mb-3">
                            <div class="stat-card">
                                <div class="number text-success" id="statPlaced">0</div>
                                <div class="label">ë°°ì¹˜ ì™„ë£Œ</div>
                            </div>
                        </div>
                        <div class="col-md-3 col-6 mb-3">
                            <div class="stat-card">
                                <div class="number text-danger" id="statUnplaced">0</div>
                                <div class="label">ë¯¸ë°°ì¹˜</div>
                            </div>
                        </div>
                        <div class="col-md-3 col-6 mb-3">
                            <div class="stat-card">
                                <div class="number text-info" id="statRate">0%</div>
                                <div class="label">ë°°ì¹˜ìœ¨</div>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-3">
                        <div class="card-body py-3">
                            <div class="d-flex flex-wrap align-items-center" id="filterButtons">
                                <span class="me-3 fw-bold">í•„í„°:</span>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span>ğŸ“‹ ë°°ì¹˜ ê²°ê³¼ <span class="badge bg-secondary" id="resultCount">0ëª…</span></span>
                            <button class="btn btn-sm btn-success" onclick="downloadResult()">ğŸ“¥ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover result-table" id="resultTable">
                                    <thead class="table-light" id="resultTableHead"></thead>
                                    <tbody id="resultTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="card mt-4">
                        <div class="card-header">ğŸ¥ ë³‘ì›ë³„ ë°°ì¹˜ í˜„í™©</div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm table-bordered" id="hospitalSummaryTable">
                                    <thead class="table-light" id="hospitalSummaryHead"></thead>
                                    <tbody id="hospitalSummaryBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="noResultMessage" class="text-center py-5 text-muted">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M12 6v6l4 2"></path>
                    </svg>
                    <h5 class="mt-3">ì•„ì§ ë°°ì¹˜ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</h5>
                    <p>í•™ìƒ ëª…ë‹¨ì„ ì—…ë¡œë“œí•˜ê³  ë°°ì¹˜ë¥¼ ì‹œì‘í•˜ì„¸ìš”.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ë„ì›€ë§ ë²„íŠ¼ -->
    <button class="help-btn" onclick="showGuide()" title="ì‚¬ìš©ë²• ë³´ê¸°">?</button>

    <!-- ì‚¬ìš© ê°€ì´ë“œ ëª¨ë‹¬ -->
    <div class="modal fade" id="guideModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ğŸ“– ì‚¬ìš© ê°€ì´ë“œ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="guide-step">
                        <div class="guide-step-number">1</div>
                        <div class="guide-step-content">
                            <h6>ê³¼ëª© ì„¤ì •</h6>
                            <p class="mb-0">ì‹¤ìŠµ ê³¼ëª©ëª…, ë¶„ë°˜(A/B/C ë“±), ì‹¤ìŠµ ë³‘ë™(ì‹ ìƒì•„ì‹¤/ì†Œì•„ê³¼ ë“±)ì„ ì„¤ì •í•©ë‹ˆë‹¤.<br>
                            <strong>ğŸ’¡ íŒ:</strong> í”„ë¦¬ì…‹ì„ ì„ íƒí•˜ë©´ ë¹ ë¥´ê²Œ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                        </div>
                    </div>
                    <div class="guide-step">
                        <div class="guide-step-number">2</div>
                        <div class="guide-step-content">
                            <h6>ë³‘ì› í‹°ì˜¤ ì„¤ì •</h6>
                            <p class="mb-0">ì‹¤ìŠµ ë³‘ì›ê³¼ ê° ë³‘ì›ì˜ ë¶„ë°˜ë³„/ë³‘ë™ë³„ ì •ì›(í‹°ì˜¤)ì„ ì…ë ¥í•©ë‹ˆë‹¤.<br>
                            ë³‘ì› ì£¼ì†ŒëŠ” <strong>êµ¬/ì‹œ ë‹¨ìœ„</strong>ë¡œ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ê°•ë‚¨êµ¬, ì„±ë‚¨ì‹œ).</p>
                        </div>
                    </div>
                    <div class="guide-step">
                        <div class="guide-step-number">3</div>
                        <div class="guide-step-content">
                            <h6>í•™ìƒ ëª…ë‹¨ ì—…ë¡œë“œ</h6>
                            <p class="mb-2">ì—‘ì…€ íŒŒì¼ì— ì•„ë˜ ì»¬ëŸ¼ì´ í¬í•¨ë˜ì–´ì•¼ í•©ë‹ˆë‹¤:</p>
                            <ul class="mb-0">
                                <li><strong>í•™ë²ˆ</strong> - í•™ìƒ í•™ë²ˆ</li>
                                <li><strong>ì´ë¦„</strong> - í•™ìƒ ì´ë¦„</li>
                                <li><strong>ë°˜</strong> - ì„¤ì •í•œ ë¶„ë°˜ëª… (ì˜ˆ: A, B, C ë˜ëŠ” 1, 2, 3)</li>
                                <li><strong>ì£¼ì†Œ</strong> - ê±°ì£¼ì§€ ì£¼ì†Œ (êµ¬/ì‹œ í¬í•¨)</li>
                            </ul>
                        </div>
                    </div>
                    <div class="guide-step">
                        <div class="guide-step-number">4</div>
                        <div class="guide-step-content">
                            <h6>ë°°ì¹˜ ê²°ê³¼ í™•ì¸</h6>
                            <p class="mb-0">í•™ìƒ ì£¼ì†Œì™€ ë³‘ì› ìœ„ì¹˜ê°€ <strong>ê°€ê¹Œìš´ ê³³ ìš°ì„ </strong>ìœ¼ë¡œ ìë™ ë°°ì¹˜ë©ë‹ˆë‹¤.<br>
                            ê²°ê³¼ë¥¼ í™•ì¸í•˜ê³  ì—‘ì…€ë¡œ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                        </div>
                    </div>
                    <hr>
                    <h6>ğŸ’¾ ì„¤ì • ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸°</h6>
                    <p class="small text-muted mb-0">
                        ìƒë‹¨ì˜ "ì„¤ì • ë‚´ë³´ë‚´ê¸°"ë¡œ í˜„ì¬ ì„¤ì •ì„ JSON íŒŒì¼ë¡œ ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
                        ë‹¤ìŒ í•™ê¸°ì— "ì„¤ì • ê°€ì ¸ì˜¤ê¸°"ë¡œ ë¶ˆëŸ¬ì™€ì„œ ë°”ë¡œ ì‚¬ìš©í•˜ì„¸ìš”.
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">í™•ì¸</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ====== ì „ì—­ ë³€ìˆ˜ ======
        let config = {
            subjectName: '',
            totalWeeks: 8,
            weeksPerClass: 2,
            classGroups: [],
            departments: []
        };

        let hospitals = [];
        let students = [];
        let placementResult = [];

        const CLASS_COLORS = ['#fef3c7', '#dbeafe', '#d1fae5', '#fce7f3', '#e0e7ff', '#fed7aa', '#d9f99d', '#ccfbf1'];
        const CLASS_TEXT_COLORS = ['#b45309', '#1d4ed8', '#059669', '#be185d', '#4338ca', '#c2410c', '#65a30d', '#0d9488'];
        const DEPT_COLORS = ['#fee2e2', '#dbeafe', '#d1fae5', '#fef3c7', '#e0e7ff', '#fce7f3', '#ccfbf1', '#fed7aa'];
        const DEPT_TEXT_COLORS = ['#dc2626', '#2563eb', '#059669', '#d97706', '#4f46e5', '#db2777', '#0d9488', '#ea580c'];

        // ====== ì´ˆê¸°í™” ======
        document.addEventListener('DOMContentLoaded', function() {
            loadConfig();
            loadHospitals();
            initDragDrop();
            updateUI();
        });

        // ====== í”„ë¦¬ì…‹ ======
        function applyPreset(type) {
            const presets = {
                'pediatric': {
                    subjectName: 'ì•„ë™ê°„í˜¸í•™ì‹¤ìŠµ',
                    totalWeeks: 8,
                    weeksPerClass: 2,
                    classes: ['Aë°˜', 'Bë°˜', 'Cë°˜'],
                    departments: ['ì‹ ìƒì•„ì‹¤', 'ì†Œì•„ê³¼']
                },
                'adult': {
                    subjectName: 'ì„±ì¸ê°„í˜¸í•™ì‹¤ìŠµ',
                    totalWeeks: 8,
                    weeksPerClass: 2,
                    classes: ['Aë°˜', 'Bë°˜', 'Cë°˜'],
                    departments: ['ë‚´ê³¼ë³‘ë™', 'ì™¸ê³¼ë³‘ë™']
                },
                'psychiatric': {
                    subjectName: 'ì •ì‹ ê°„í˜¸í•™ì‹¤ìŠµ',
                    totalWeeks: 6,
                    weeksPerClass: 3,
                    classes: ['Aë°˜', 'Bë°˜'],
                    departments: ['íì‡„ë³‘ë™', 'ê°œë°©ë³‘ë™']
                },
                'maternity': {
                    subjectName: 'ëª¨ì„±ê°„í˜¸í•™ì‹¤ìŠµ',
                    totalWeeks: 8,
                    weeksPerClass: 2,
                    classes: ['Aë°˜', 'Bë°˜', 'Cë°˜'],
                    departments: ['ë¶„ë§Œì‹¤', 'ì‚°í›„ì¡°ë¦¬ì‹¤']
                },
                'community': {
                    subjectName: 'ì§€ì—­ì‚¬íšŒê°„í˜¸í•™ì‹¤ìŠµ',
                    totalWeeks: 4,
                    weeksPerClass: 2,
                    classes: ['Aë°˜', 'Bë°˜'],
                    departments: ['ë³´ê±´ì†Œ', 'ë°©ë¬¸ê°„í˜¸']
                },
                'custom': {
                    subjectName: '',
                    totalWeeks: 8,
                    weeksPerClass: 2,
                    classes: [],
                    departments: []
                }
            };

            const preset = presets[type];
            if (!preset) return;

            config.subjectName = preset.subjectName;
            config.totalWeeks = preset.totalWeeks;
            config.weeksPerClass = preset.weeksPerClass;

            document.getElementById('subjectName').value = preset.subjectName;
            document.getElementById('totalWeeks').value = preset.totalWeeks;
            document.getElementById('weeksPerClass').value = preset.weeksPerClass;

            // ë¶„ë°˜ ì„¤ì •
            config.classGroups = preset.classes.map((name, i) => ({
                id: 'class_' + Date.now() + i,
                name: name,
                color: CLASS_COLORS[i % CLASS_COLORS.length],
                textColor: CLASS_TEXT_COLORS[i % CLASS_TEXT_COLORS.length]
            }));

            // ë³‘ë™ ì„¤ì •
            config.departments = preset.departments.map((name, i) => ({
                id: 'dept_' + Date.now() + i,
                name: name,
                color: DEPT_COLORS[i % DEPT_COLORS.length],
                textColor: DEPT_TEXT_COLORS[i % DEPT_TEXT_COLORS.length]
            }));

            saveConfig();
            renderClassGroups();
            renderDepartments();
            updateScheduleDisplay();
            updateSummary();
        }

        // ====== ì„¤ì • ê´€ë¦¬ ======
        function loadConfig() {
            const saved = localStorage.getItem('placement_config_v2');
            if (saved) {
                config = JSON.parse(saved);
                document.getElementById('subjectName').value = config.subjectName || '';
                document.getElementById('totalWeeks').value = config.totalWeeks || 8;
                document.getElementById('weeksPerClass').value = config.weeksPerClass || 2;
            }
            renderClassGroups();
            renderDepartments();
            updateSummary();
        }

        function saveConfig() {
            config.subjectName = document.getElementById('subjectName').value;
            config.totalWeeks = parseInt(document.getElementById('totalWeeks').value) || 8;
            config.weeksPerClass = parseInt(document.getElementById('weeksPerClass').value) || 2;
            localStorage.setItem('placement_config_v2', JSON.stringify(config));
        }

        function saveAndNext() {
            if (config.classGroups.length === 0) {
                alert('ìµœì†Œ 1ê°œì˜ ë¶„ë°˜ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.');
                return;
            }
            if (config.departments.length === 0) {
                alert('ìµœì†Œ 1ê°œì˜ ë³‘ë™/ë¶€ì„œë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”.');
                return;
            }
            saveConfig();
            renderHospitalTable();
            updateCapacitySummary();
            updateSummary();
            document.getElementById('hospital-tab').click();
        }

        function resetSettings() {
            if (confirm('ëª¨ë“  ì„¤ì •ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                config = { subjectName: '', totalWeeks: 8, weeksPerClass: 2, classGroups: [], departments: [] };
                document.getElementById('subjectName').value = '';
                document.getElementById('totalWeeks').value = 8;
                document.getElementById('weeksPerClass').value = 2;
                localStorage.removeItem('placement_config_v2');
                renderClassGroups();
                renderDepartments();
                updateScheduleDisplay();
                updateSummary();
            }
        }

        function updateSummary() {
            const subject = config.subjectName || document.getElementById('subjectName').value || 'ì„¤ì • í•„ìš”';
            const classes = config.classGroups.map(g => g.name).join(', ') || '-';
            const depts = config.departments.map(d => d.name).join(', ') || '-';

            document.getElementById('summarySubject').textContent = subject;
            document.getElementById('summaryClasses').textContent = 'ë¶„ë°˜: ' + classes;
            document.getElementById('summaryDepts').textContent = 'ë³‘ë™: ' + depts;
            document.getElementById('summaryHospitals').textContent = 'ë³‘ì›: ' + hospitals.length + 'ê°œ';

            // í•™ìƒ ì—…ë¡œë“œ íƒ­ì˜ ìœ íš¨ ë¶„ë°˜ëª… í‘œì‹œ
            const validNames = config.classGroups.map(g => g.name.replace(/[ë°˜ë¶„ë°˜]/g, '')).join('/');
            document.getElementById('validClassNames').textContent = validNames || '-';
        }

        // ====== ì„¤ì • ë‚´ë³´ë‚´ê¸°/ê°€ì ¸ì˜¤ê¸° ======
        function exportAllSettings() {
            saveConfig();
            const exportData = {
                version: 2,
                exportDate: new Date().toISOString(),
                config: config,
                hospitals: hospitals
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ì‹¤ìŠµë°°ì¹˜ì„¤ì •_${config.subjectName || 'ë¯¸ì„¤ì •'}_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importSettings(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.config) {
                        config = data.config;
                        document.getElementById('subjectName').value = config.subjectName || '';
                        document.getElementById('totalWeeks').value = config.totalWeeks || 8;
                        document.getElementById('weeksPerClass').value = config.weeksPerClass || 2;
                        saveConfig();
                        renderClassGroups();
                        renderDepartments();
                        updateScheduleDisplay();
                    }
                    if (data.hospitals) {
                        hospitals = data.hospitals;
                        localStorage.setItem('placement_hospitals_v2', JSON.stringify(hospitals));
                        renderHospitalTable();
                        updateCapacitySummary();
                    }
                    updateSummary();
                    alert('ì„¤ì •ì„ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤!');
                } catch (error) {
                    alert('ì„¤ì • íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // ====== ë¶„ë°˜ ê´€ë¦¬ ======
        function addClassGroup(name = '') {
            const idx = config.classGroups.length;
            const defaultName = name || String.fromCharCode(65 + idx) + 'ë°˜';

            config.classGroups.push({
                id: 'class_' + Date.now(),
                name: defaultName,
                color: CLASS_COLORS[idx % CLASS_COLORS.length],
                textColor: CLASS_TEXT_COLORS[idx % CLASS_TEXT_COLORS.length]
            });

            saveConfig();
            renderClassGroups();
            updateScheduleDisplay();
            updateSummary();
        }

        function removeClassGroup(id) {
            config.classGroups = config.classGroups.filter(c => c.id !== id);
            saveConfig();
            renderClassGroups();
            updateScheduleDisplay();
            updateSummary();
        }

        function updateClassGroupName(id, name) {
            const group = config.classGroups.find(c => c.id === id);
            if (group) {
                group.name = name;
                saveConfig();
                updateScheduleDisplay();
                updateSummary();
            }
        }

        function renderClassGroups() {
            const container = document.getElementById('classGroupList');
            if (config.classGroups.length === 0) {
                container.innerHTML = '<p class="text-muted small mb-2">ë¶„ë°˜ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.</p>';
                return;
            }

            container.innerHTML = config.classGroups.map((g, idx) => `
                <div class="class-group-item" style="background: ${g.color};">
                    <span class="badge me-2" style="background: ${g.textColor};">${idx + 1}</span>
                    <input type="text" class="form-control form-control-sm me-2" style="max-width: 100px; background: transparent; border: 1px solid ${g.textColor}40;"
                           value="${g.name}" onchange="updateClassGroupName('${g.id}', this.value)">
                    <small class="text-muted me-auto">${getWeekRangeForClass(idx)}</small>
                    <button class="btn btn-sm btn-outline-danger py-0 px-2" onclick="removeClassGroup('${g.id}')">Ã—</button>
                </div>
            `).join('');
        }

        function addPresetClasses(type) {
            config.classGroups = [];
            let names = [];
            if (type === 'ABC') names = ['Aë°˜', 'Bë°˜', 'Cë°˜'];
            else if (type === 'ABCD') names = ['Aë°˜', 'Bë°˜', 'Cë°˜', 'Dë°˜'];
            else if (type === '12') names = ['1ë¶„ë°˜', '2ë¶„ë°˜'];

            names.forEach((name, i) => {
                config.classGroups.push({
                    id: 'class_' + Date.now() + i,
                    name: name,
                    color: CLASS_COLORS[i],
                    textColor: CLASS_TEXT_COLORS[i]
                });
            });

            saveConfig();
            renderClassGroups();
            updateScheduleDisplay();
            updateSummary();
        }

        function getWeekRangeForClass(idx) {
            const weeksPerClass = config.weeksPerClass || 2;
            const start = idx * weeksPerClass + 1;
            const end = start + weeksPerClass - 1;
            return `${start}-${end}ì£¼`;
        }

        // ====== ë³‘ë™/ë¶€ì„œ ê´€ë¦¬ ======
        function addDepartment(name = '') {
            const idx = config.departments.length;
            config.departments.push({
                id: 'dept_' + Date.now(),
                name: name || 'ë³‘ë™' + (idx + 1),
                color: DEPT_COLORS[idx % DEPT_COLORS.length],
                textColor: DEPT_TEXT_COLORS[idx % DEPT_TEXT_COLORS.length]
            });
            saveConfig();
            renderDepartments();
            updateSummary();
        }

        function removeDepartment(id) {
            config.departments = config.departments.filter(d => d.id !== id);
            saveConfig();
            renderDepartments();
            updateSummary();
        }

        function updateDepartmentName(id, name) {
            const dept = config.departments.find(d => d.id === id);
            if (dept) {
                dept.name = name;
                saveConfig();
                updateSummary();
            }
        }

        function renderDepartments() {
            const container = document.getElementById('departmentList');
            if (config.departments.length === 0) {
                container.innerHTML = '<p class="text-muted small mb-2">ë³‘ë™/ë¶€ì„œë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”.</p>';
                return;
            }

            container.innerHTML = config.departments.map(d => `
                <span class="dept-tag" style="background: ${d.color}; color: ${d.textColor};">
                    <input type="text" value="${d.name}" style="border: none; background: transparent; color: inherit; width: 70px; font-size: inherit;"
                           onchange="updateDepartmentName('${d.id}', this.value)">
                    <button onclick="removeDepartment('${d.id}')">Ã—</button>
                </span>
            `).join('');
        }

        function addPresetDepts(type) {
            config.departments = [];
            let depts = type === 'peds' ? ['ì‹ ìƒì•„ì‹¤', 'ì†Œì•„ê³¼'] : ['ë‚´ê³¼ë³‘ë™', 'ì™¸ê³¼ë³‘ë™'];
            depts.forEach((name, i) => {
                config.departments.push({
                    id: 'dept_' + Date.now() + i,
                    name: name,
                    color: DEPT_COLORS[i],
                    textColor: DEPT_TEXT_COLORS[i]
                });
            });
            saveConfig();
            renderDepartments();
            updateSummary();
        }

        // ====== ìŠ¤ì¼€ì¤„ í‘œì‹œ ======
        function updateScheduleDisplay() {
            const container = document.getElementById('scheduleDisplay');
            if (config.classGroups.length === 0) {
                container.innerHTML = '<p class="text-muted mb-0 small">ë¶„ë°˜ì„ ì¶”ê°€í•˜ë©´ ìŠ¤ì¼€ì¤„ì´ í‘œì‹œë©ë‹ˆë‹¤.</p>';
                return;
            }

            let html = '';
            config.classGroups.forEach((g, idx) => {
                if (idx > 0) html += '<span class="mx-1">â†’</span>';
                html += `<span class="schedule-item" style="background: ${g.color}; color: ${g.textColor};">
                    ${getWeekRangeForClass(idx)}: ${g.name}
                </span>`;
            });

            const regularWeeks = config.classGroups.length * (config.weeksPerClass || 2);
            const totalWeeks = parseInt(document.getElementById('totalWeeks').value) || 8;
            if (regularWeeks < totalWeeks) {
                html += '<span class="mx-1">â†’</span>';
                html += `<span class="schedule-item" style="background: #ede9fe; color: #7c3aed;">
                    ${regularWeeks + 1}-${totalWeeks}ì£¼: ì¶”ê°€ë°°ì¹˜
                </span>`;
            }

            container.innerHTML = html;
        }

        function updateUI() {
            updateScheduleDisplay();
            updateSummary();
        }

        // ====== ë³‘ì› ê´€ë¦¬ ======
        function loadHospitals() {
            const saved = localStorage.getItem('placement_hospitals_v2');
            hospitals = saved ? JSON.parse(saved) : [];
            renderHospitalTable();
            updateCapacitySummary();
        }

        function getPlacementSlots() {
            const slots = config.classGroups.map((g, idx) => ({
                id: g.id,
                classId: g.id,
                label: `${g.name} (${getWeekRangeForClass(idx)})`,
                isMixed: false
            }));

            const regularWeeks = config.classGroups.length * config.weeksPerClass;
            if (regularWeeks < config.totalWeeks) {
                slots.push({
                    id: 'mixed',
                    classId: null,
                    label: `ì¶”ê°€ë°°ì¹˜ (${regularWeeks + 1}-${config.totalWeeks}ì£¼)`,
                    isMixed: true
                });
            }

            return slots;
        }

        function renderHospitalTable() {
            if (config.classGroups.length === 0 || config.departments.length === 0) {
                document.getElementById('hospitalTableHead').innerHTML = '';
                document.getElementById('hospitalTableBody').innerHTML = '<tr><td colspan="3" class="text-center text-muted py-4">ë¨¼ì € ê³¼ëª©/ë¶„ë°˜ ì„¤ì •ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”.</td></tr>';
                return;
            }

            const slots = getPlacementSlots();
            const thead = document.getElementById('hospitalTableHead');
            const tbody = document.getElementById('hospitalTableBody');

            let headerRow1 = `
                <th rowspan="2" class="align-middle text-center" style="min-width:100px;">ë³‘ì›ëª…</th>
                <th rowspan="2" class="align-middle text-center" style="min-width:80px;">ì£¼ì†Œ(êµ¬/ì‹œ)</th>
            `;

            slots.forEach(slot => {
                const group = config.classGroups.find(g => g.id === slot.classId);
                const style = group ? `background: ${group.color}; color: ${group.textColor};` : 'background: #ede9fe; color: #7c3aed;';
                headerRow1 += `<th colspan="${config.departments.length}" class="text-center" style="${style}; font-size: 0.75rem;">${slot.label}</th>`;
            });
            headerRow1 += `<th rowspan="2" class="align-middle text-center" style="width:40px;"></th>`;

            let headerRow2 = '';
            slots.forEach(() => {
                config.departments.forEach(dept => {
                    headerRow2 += `<th class="text-center" style="font-size:0.65rem; background: ${dept.color}; padding: 0.25rem;">${dept.name.substring(0, 3)}</th>`;
                });
            });

            thead.innerHTML = `<tr>${headerRow1}</tr><tr>${headerRow2}</tr>`;

            tbody.innerHTML = hospitals.map((h, idx) => {
                let cellsHtml = `
                    <td><input type="text" value="${h.name || ''}" onchange="updateHospital(${idx}, 'name', this.value)" placeholder="ë³‘ì›ëª…"></td>
                    <td><input type="text" value="${h.address || ''}" onchange="updateHospital(${idx}, 'address', this.value)" placeholder="êµ¬/ì‹œ"></td>
                `;

                slots.forEach(slot => {
                    config.departments.forEach(dept => {
                        const key = `${slot.id}_${dept.id}`;
                        cellsHtml += `<td class="text-center" style="background: ${dept.color}20; padding: 0.25rem;">
                            <input type="number" min="0" value="${h[key] || 0}" onchange="updateHospital(${idx}, '${key}', this.value)">
                        </td>`;
                    });
                });

                cellsHtml += `<td><button class="btn btn-sm btn-outline-danger py-0 px-2" onclick="removeHospital(${idx})">Ã—</button></td>`;
                return `<tr>${cellsHtml}</tr>`;
            }).join('');

            if (hospitals.length === 0) {
                const colSpan = 3 + slots.length * config.departments.length;
                tbody.innerHTML = `<tr><td colspan="${colSpan}" class="text-center text-muted py-4">ë³‘ì›ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.</td></tr>`;
            }
        }

        function addHospitalRow() {
            const newHospital = { name: '', address: '' };
            const slots = getPlacementSlots();
            slots.forEach(slot => {
                config.departments.forEach(dept => {
                    newHospital[`${slot.id}_${dept.id}`] = 0;
                });
            });
            hospitals.push(newHospital);
            renderHospitalTable();
            updateCapacitySummary();
            updateSummary();
        }

        function updateHospital(idx, field, value) {
            if (field === 'name' || field === 'address') {
                hospitals[idx][field] = value;
            } else {
                hospitals[idx][field] = parseInt(value) || 0;
            }
            updateCapacitySummary();
        }

        function removeHospital(idx) {
            hospitals.splice(idx, 1);
            renderHospitalTable();
            updateCapacitySummary();
            updateSummary();
        }

        function updateCapacitySummary() {
            const container = document.getElementById('capacitySummary');
            if (config.classGroups.length === 0 || config.departments.length === 0) {
                container.innerHTML = '';
                return;
            }

            const slots = getPlacementSlots();
            const summary = {};
            slots.forEach(slot => {
                summary[slot.id] = { total: 0, byDept: {} };
                config.departments.forEach(dept => summary[slot.id].byDept[dept.id] = 0);
            });

            hospitals.forEach(h => {
                slots.forEach(slot => {
                    config.departments.forEach(dept => {
                        const key = `${slot.id}_${dept.id}`;
                        const val = h[key] || 0;
                        summary[slot.id].byDept[dept.id] += val;
                        summary[slot.id].total += val;
                    });
                });
            });

            container.innerHTML = slots.map(slot => {
                const group = config.classGroups.find(g => g.id === slot.classId);
                const borderColor = group ? group.textColor : '#7c3aed';
                const deptDetails = config.departments.map(dept =>
                    `${dept.name.substring(0, 2)} ${summary[slot.id].byDept[dept.id]}`
                ).join(' / ');

                return `
                    <div class="capacity-box" style="border-left: 4px solid ${borderColor};">
                        <div class="class-name" style="font-size: 0.75rem;">${slot.label}</div>
                        <div class="capacity-total">${summary[slot.id].total}ëª…</div>
                        <div class="capacity-detail">${deptDetails}</div>
                    </div>
                `;
            }).join('');
        }

        function saveHospitals() {
            localStorage.setItem('placement_hospitals_v2', JSON.stringify(hospitals));
            updateSummary();
            alert('ë³‘ì› ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }

        function saveHospitalsAndNext() {
            if (hospitals.length === 0) {
                alert('ìµœì†Œ 1ê°œì˜ ë³‘ì›ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.');
                return;
            }
            localStorage.setItem('placement_hospitals_v2', JSON.stringify(hospitals));
            updateSummary();
            document.getElementById('upload-tab').click();
        }

        function resetHospitals() {
            if (confirm('ë³‘ì› ì„¤ì •ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                hospitals = [];
                localStorage.removeItem('placement_hospitals_v2');
                renderHospitalTable();
                updateCapacitySummary();
                updateSummary();
            }
        }

        // ====== í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ ======
        function downloadHospitalTemplate() {
            const slots = getPlacementSlots();
            const headers = ['ë³‘ì›ëª…', 'ì£¼ì†Œ(êµ¬/ì‹œ)'];
            slots.forEach(slot => {
                config.departments.forEach(dept => {
                    headers.push(`${slot.label}_${dept.name}`);
                });
            });

            const ws = XLSX.utils.aoa_to_sheet([headers, ['ì„œìš¸ëŒ€ë³‘ì›', 'ì¢…ë¡œêµ¬', ...Array(slots.length * config.departments.length).fill(2)]]);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'ë³‘ì›í‹°ì˜¤');
            XLSX.writeFile(wb, 'ë³‘ì›í‹°ì˜¤_í…œí”Œë¦¿.xlsx');
        }

        function downloadStudentTemplate() {
            const validClasses = config.classGroups.map(g => g.name.replace(/[ë°˜ë¶„ë°˜]/g, '')).join(', ');
            const ws = XLSX.utils.aoa_to_sheet([
                ['í•™ë²ˆ', 'ì´ë¦„', 'ë°˜', 'ì£¼ì†Œ'],
                ['2024001', 'í™ê¸¸ë™', config.classGroups[0]?.name.replace(/[ë°˜ë¶„ë°˜]/g, '') || 'A', 'ì„œìš¸ì‹œ ê°•ë‚¨êµ¬ ì—­ì‚¼ë™'],
                ['2024002', 'ê¹€ì² ìˆ˜', config.classGroups[0]?.name.replace(/[ë°˜ë¶„ë°˜]/g, '') || 'A', 'ê²½ê¸°ë„ ì„±ë‚¨ì‹œ ë¶„ë‹¹êµ¬'],
                ['', '', `â€» ë°˜ ì»¬ëŸ¼ì—ëŠ” ${validClasses} ì¤‘ í•˜ë‚˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”`, '']
            ]);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'í•™ìƒëª…ë‹¨');
            XLSX.writeFile(wb, 'í•™ìƒëª…ë‹¨_í…œí”Œë¦¿.xlsx');
        }

        // ====== íŒŒì¼ ì—…ë¡œë“œ ======
        function initDragDrop() {
            const zone = document.getElementById('uploadZone');
            zone.addEventListener('dragover', (e) => { e.preventDefault(); zone.classList.add('dragover'); });
            zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
            zone.addEventListener('drop', (e) => {
                e.preventDefault();
                zone.classList.remove('dragover');
                if (e.dataTransfer.files[0]) processFile(e.dataTransfer.files[0]);
            });
        }

        function handleFileUpload(event) {
            if (event.target.files[0]) processFile(event.target.files[0]);
        }

        function processFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(sheet);

                    const validClassNames = config.classGroups.map(g => ({
                        id: g.id,
                        name: g.name,
                        normalized: g.name.replace(/[ë°˜ë¶„ë°˜]/g, '').trim().toUpperCase()
                    }));

                    students = json.map(row => {
                        const normalized = {};
                        for (let key in row) {
                            const lowerKey = key.toLowerCase().trim();
                            if (lowerKey.includes('í•™ë²ˆ') || lowerKey === 'id' || lowerKey === 'studentid') {
                                normalized.studentId = String(row[key]).trim();
                            } else if (lowerKey.includes('ì´ë¦„') || lowerKey === 'name') {
                                normalized.name = String(row[key]).trim();
                            } else if (lowerKey.includes('ë°˜') || lowerKey === 'class') {
                                let classVal = String(row[key]).replace(/[ë°˜ë¶„ë°˜]/g, '').trim().toUpperCase();
                                const found = validClassNames.find(v => v.normalized === classVal || v.name === row[key]);
                                normalized.classId = found ? found.id : null;
                                normalized.className = found ? found.name : row[key];
                            } else if (lowerKey.includes('ì£¼ì†Œ') || lowerKey === 'address') {
                                normalized.address = String(row[key]).trim();
                            }
                        }
                        return normalized;
                    }).filter(s => s.studentId && s.name && s.classId && s.address);

                    if (students.length === 0) {
                        const validNames = config.classGroups.map(g => g.name).join(', ');
                        alert(`ì˜¬ë°”ë¥¸ í˜•ì‹ì˜ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\ní•„ìˆ˜ ì»¬ëŸ¼: í•™ë²ˆ, ì´ë¦„, ë°˜, ì£¼ì†Œ\nìœ íš¨í•œ ë¶„ë°˜ëª…: ${validNames}`);
                        return;
                    }

                    showPreview();
                } catch (error) {
                    alert('íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function showPreview() {
            const preview = document.getElementById('uploadPreview');
            const table = document.getElementById('previewTable');

            const classCounts = {};
            config.classGroups.forEach(g => classCounts[g.id] = 0);
            students.forEach(s => { if (classCounts[s.classId] !== undefined) classCounts[s.classId]++; });

            const colSize = Math.max(Math.floor(12 / config.classGroups.length), 3);
            document.getElementById('classSummary').innerHTML = config.classGroups.map((g, idx) => `
                <div class="col-${colSize}">
                    <div class="stat-card py-2" style="border-left: 3px solid ${g.textColor};">
                        <div class="number fs-5" style="color: ${g.textColor};">${classCounts[g.id]}</div>
                        <small class="text-muted">${g.name}</small>
                    </div>
                </div>
            `).join('');

            table.querySelector('tbody').innerHTML = students.map((s, i) => {
                const group = config.classGroups.find(g => g.id === s.classId);
                const style = group ? `background: ${group.color}; color: ${group.textColor};` : '';
                return `<tr><td>${i + 1}</td><td>${s.studentId}</td><td>${s.name}</td><td><span class="badge" style="${style}">${s.className}</span></td><td>${s.address}</td></tr>`;
            }).join('');

            preview.style.display = 'block';
        }

        // ====== ë°°ì¹˜ ì•Œê³ ë¦¬ì¦˜ ======
        function runPlacement() {
            if (hospitals.length === 0) { alert('ë¨¼ì € ë³‘ì› ì„¤ì •ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”.'); return; }
            document.getElementById('loadingOverlay').classList.add('show');

            setTimeout(() => {
                try {
                    placementResult = performPlacement();
                    showResults();
                } catch (error) {
                    alert('ë°°ì¹˜ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                    console.error(error);
                } finally {
                    document.getElementById('loadingOverlay').classList.remove('show');
                }
            }, 300);
        }

        function performPlacement() {
            const results = [];
            const unplacedStudents = [];
            const slots = getPlacementSlots();

            const remaining = hospitals.map((h, idx) => {
                const r = { name: h.name, address: h.address, originalIdx: idx };
                slots.forEach(slot => {
                    config.departments.forEach(dept => {
                        r[`${slot.id}_${dept.id}`] = h[`${slot.id}_${dept.id}`] || 0;
                    });
                });
                return r;
            });

            const studentsByClass = {};
            config.classGroups.forEach(g => studentsByClass[g.id] = []);
            students.forEach(s => { if (studentsByClass[s.classId]) studentsByClass[s.classId].push({ ...s }); });

            for (const group of config.classGroups) {
                const classStudents = studentsByClass[group.id];
                if (classStudents.length === 0) continue;

                const slotId = group.id;
                const groupIdx = config.classGroups.findIndex(g => g.id === group.id);

                classStudents.forEach(student => {
                    student.hospitalScores = remaining.map((h, idx) => ({
                        idx, hospital: h, score: calculateAddressScore(student.address, h.address)
                    })).sort((a, b) => b.score - a.score);
                    student.bestScore = student.hospitalScores[0]?.score || 0;
                });

                classStudents.sort((a, b) => a.bestScore - b.bestScore);

                const deptCounts = {};
                config.departments.forEach(d => deptCounts[d.id] = 0);
                const classResults = [];

                for (const student of classStudents) {
                    let placed = false;
                    const deptOrder = [...config.departments].sort((a, b) => deptCounts[a.id] - deptCounts[b.id]);

                    for (const { idx } of student.hospitalScores) {
                        const hospital = remaining[idx];
                        for (const dept of deptOrder) {
                            const key = `${slotId}_${dept.id}`;
                            if (hospital[key] > 0) {
                                hospital[key]--;
                                deptCounts[dept.id]++;
                                classResults.push({
                                    studentId: student.studentId, name: student.name, classId: student.classId, className: student.className,
                                    address: student.address, hospitalIdx: idx, hospitalName: hospital.name, hospitalAddr: hospital.address,
                                    deptId: dept.id, deptName: dept.name, score: student.hospitalScores.find(h => h.idx === idx).score, slotId
                                });
                                placed = true;
                                break;
                            }
                        }
                        if (placed) break;
                    }
                    if (!placed) unplacedStudents.push(student);
                }

                // êµí™˜ ê°œì„ 
                let improved = true, iterations = 0;
                while (improved && iterations < 100) {
                    improved = false; iterations++;
                    for (let i = 0; i < classResults.length; i++) {
                        for (let j = i + 1; j < classResults.length; j++) {
                            const r1 = classResults[i], r2 = classResults[j];
                            if (r1.deptId !== r2.deptId) continue;
                            const s1 = classStudents.find(s => s.studentId === r1.studentId);
                            const s2 = classStudents.find(s => s.studentId === r2.studentId);
                            const currentScore = r1.score + r2.score;
                            const newScore1 = calculateAddressScore(s1.address, remaining[r2.hospitalIdx].address);
                            const newScore2 = calculateAddressScore(s2.address, remaining[r1.hospitalIdx].address);
                            if (newScore1 + newScore2 > currentScore) {
                                [r1.hospitalIdx, r2.hospitalIdx] = [r2.hospitalIdx, r1.hospitalIdx];
                                [r1.hospitalName, r2.hospitalName] = [r2.hospitalName, r1.hospitalName];
                                [r1.hospitalAddr, r2.hospitalAddr] = [r2.hospitalAddr, r1.hospitalAddr];
                                r1.score = newScore1; r2.score = newScore2;
                                improved = true;
                            }
                        }
                    }
                }

                classResults.forEach(r => {
                    results.push({
                        studentId: r.studentId, name: r.name, classId: r.classId, className: r.className,
                        period: getWeekRangeForClass(groupIdx), slotId: r.slotId, isMixed: false, address: r.address,
                        hospital: r.hospitalName, hospitalAddr: r.hospitalAddr, deptId: r.deptId, department: r.deptName,
                        score: r.score, status: 'ë°°ì¹˜ì™„ë£Œ'
                    });
                });
            }

            // ì¶”ê°€ ë°°ì¹˜
            const mixedSlot = slots.find(s => s.isMixed);
            if (mixedSlot && unplacedStudents.length > 0) {
                unplacedStudents.forEach(student => {
                    student.hospitalScores = remaining.map((h, idx) => ({
                        idx, hospital: h, score: calculateAddressScore(student.address, h.address)
                    })).sort((a, b) => b.score - a.score);
                    student.bestScore = student.hospitalScores[0]?.score || 0;
                });
                unplacedStudents.sort((a, b) => a.bestScore - b.bestScore);

                const deptCounts = {};
                config.departments.forEach(d => deptCounts[d.id] = 0);
                const mixedResults = [];

                for (const student of unplacedStudents) {
                    let placed = false;
                    const deptOrder = [...config.departments].sort((a, b) => deptCounts[a.id] - deptCounts[b.id]);

                    for (const { idx } of student.hospitalScores) {
                        const hospital = remaining[idx];
                        for (const dept of deptOrder) {
                            const key = `${mixedSlot.id}_${dept.id}`;
                            if (hospital[key] > 0) {
                                hospital[key]--;
                                deptCounts[dept.id]++;
                                mixedResults.push({
                                    studentId: student.studentId, name: student.name, classId: student.classId, className: student.className,
                                    address: student.address, hospitalIdx: idx, hospitalName: hospital.name, hospitalAddr: hospital.address,
                                    deptId: dept.id, deptName: dept.name, score: student.hospitalScores.find(h => h.idx === idx).score
                                });
                                placed = true;
                                break;
                            }
                        }
                        if (placed) break;
                    }

                    if (!placed) {
                        results.push({
                            studentId: student.studentId, name: student.name, classId: student.classId, className: student.className,
                            period: '-', slotId: null, isMixed: false, address: student.address, hospital: '-', department: '-',
                            deptId: null, score: 0, status: 'ë¯¸ë°°ì¹˜'
                        });
                    }
                }

                const regularWeeks = config.classGroups.length * config.weeksPerClass;
                mixedResults.forEach(r => {
                    results.push({
                        studentId: r.studentId, name: r.name, classId: r.classId, className: r.className,
                        period: `${regularWeeks + 1}-${config.totalWeeks}ì£¼`, slotId: 'mixed', isMixed: true, address: r.address,
                        hospital: r.hospitalName, hospitalAddr: r.hospitalAddr, deptId: r.deptId, department: r.deptName,
                        score: r.score, status: 'ë°°ì¹˜ì™„ë£Œ'
                    });
                });
            }

            return results;
        }

        function calculateAddressScore(studentAddr, hospitalAddr) {
            const studentParts = extractAddressParts(studentAddr);
            const hospitalParts = extractAddressParts(hospitalAddr);
            let score = 0;

            if (studentParts.region && hospitalParts.region && studentParts.region === hospitalParts.region) score += 100;

            const adjacent = {
                'ê°•ë‚¨êµ¬': ['ì„œì´ˆêµ¬', 'ì†¡íŒŒêµ¬', 'ê°•ë™êµ¬', 'ì„±ë‚¨ì‹œ', 'ë¶„ë‹¹êµ¬'], 'ì„œì´ˆêµ¬': ['ê°•ë‚¨êµ¬', 'ë™ì‘êµ¬', 'ê´€ì•…êµ¬', 'ê³¼ì²œì‹œ', 'ì„±ë‚¨ì‹œ'],
                'ì†¡íŒŒêµ¬': ['ê°•ë‚¨êµ¬', 'ê°•ë™êµ¬', 'ê´‘ì§„êµ¬', 'í•˜ë‚¨ì‹œ', 'ì„±ë‚¨ì‹œ'], 'ê°•ë™êµ¬': ['ì†¡íŒŒêµ¬', 'ê´‘ì§„êµ¬', 'í•˜ë‚¨ì‹œ', 'êµ¬ë¦¬ì‹œ'],
                'ì¢…ë¡œêµ¬': ['ì„±ë¶êµ¬', 'ë™ëŒ€ë¬¸êµ¬', 'ì¤‘êµ¬', 'ì„œëŒ€ë¬¸êµ¬', 'ì€í‰êµ¬'], 'ì„œëŒ€ë¬¸êµ¬': ['ì¢…ë¡œêµ¬', 'ë§ˆí¬êµ¬', 'ì€í‰êµ¬', 'ê³ ì–‘ì‹œ'],
                'ì„±ë¶êµ¬': ['ì¢…ë¡œêµ¬', 'ë™ëŒ€ë¬¸êµ¬', 'ê°•ë¶êµ¬', 'ë…¸ì›êµ¬', 'ì˜ì •ë¶€ì‹œ'], 'ë§ˆí¬êµ¬': ['ì„œëŒ€ë¬¸êµ¬', 'ìš©ì‚°êµ¬', 'ì€í‰êµ¬', 'ê³ ì–‘ì‹œ'],
                'ìš©ì‚°êµ¬': ['ë§ˆí¬êµ¬', 'ì¤‘êµ¬', 'ì„±ë™êµ¬', 'ë™ì‘êµ¬'], 'ì¤‘êµ¬': ['ì¢…ë¡œêµ¬', 'ìš©ì‚°êµ¬', 'ì„±ë™êµ¬', 'ë™ëŒ€ë¬¸êµ¬'],
                'ë™ëŒ€ë¬¸êµ¬': ['ì¤‘êµ¬', 'ì¢…ë¡œêµ¬', 'ì„±ë¶êµ¬', 'ê´‘ì§„êµ¬', 'ì¤‘ë‘êµ¬'], 'ê´‘ì§„êµ¬': ['ë™ëŒ€ë¬¸êµ¬', 'ì„±ë™êµ¬', 'ì†¡íŒŒêµ¬', 'ê°•ë™êµ¬', 'ì¤‘ë‘êµ¬', 'êµ¬ë¦¬ì‹œ'],
                'ì„±ë™êµ¬': ['ê´‘ì§„êµ¬', 'ì¤‘êµ¬', 'ìš©ì‚°êµ¬', 'ë™ëŒ€ë¬¸êµ¬'], 'ê°•ë¶êµ¬': ['ë…¸ì›êµ¬', 'ë„ë´‰êµ¬', 'ì„±ë¶êµ¬', 'ì˜ì •ë¶€ì‹œ'],
                'ë…¸ì›êµ¬': ['ë„ë´‰êµ¬', 'ê°•ë¶êµ¬', 'ì„±ë¶êµ¬', 'ì¤‘ë‘êµ¬', 'ì˜ì •ë¶€ì‹œ', 'ë‚¨ì–‘ì£¼ì‹œ'], 'ë„ë´‰êµ¬': ['ë…¸ì›êµ¬', 'ê°•ë¶êµ¬', 'ì˜ì •ë¶€ì‹œ', 'ì–‘ì£¼ì‹œ'],
                'ì¤‘ë‘êµ¬': ['ë…¸ì›êµ¬', 'ë™ëŒ€ë¬¸êµ¬', 'ê´‘ì§„êµ¬', 'êµ¬ë¦¬ì‹œ', 'ë‚¨ì–‘ì£¼ì‹œ'], 'ì€í‰êµ¬': ['ì„œëŒ€ë¬¸êµ¬', 'ë§ˆí¬êµ¬', 'ì¢…ë¡œêµ¬', 'ê³ ì–‘ì‹œ'],
                'ë™ì‘êµ¬': ['ì„œì´ˆêµ¬', 'ê´€ì•…êµ¬', 'ì˜ë“±í¬êµ¬', 'ìš©ì‚°êµ¬'], 'ê´€ì•…êµ¬': ['ì„œì´ˆêµ¬', 'ë™ì‘êµ¬', 'ê¸ˆì²œêµ¬', 'ê³¼ì²œì‹œ', 'ì•ˆì–‘ì‹œ'],
                'ì˜ë“±í¬êµ¬': ['ë™ì‘êµ¬', 'ì–‘ì²œêµ¬', 'ê°•ì„œêµ¬', 'êµ¬ë¡œêµ¬', 'ê´‘ëª…ì‹œ'], 'ì–‘ì²œêµ¬': ['ì˜ë“±í¬êµ¬', 'ê°•ì„œêµ¬', 'êµ¬ë¡œêµ¬', 'ë¶€ì²œì‹œ'],
                'ê°•ì„œêµ¬': ['ì–‘ì²œêµ¬', 'ì˜ë“±í¬êµ¬', 'ë¶€ì²œì‹œ', 'ê¹€í¬ì‹œ', 'ê³ ì–‘ì‹œ'], 'êµ¬ë¡œêµ¬': ['ì˜ë“±í¬êµ¬', 'ì–‘ì²œêµ¬', 'ê¸ˆì²œêµ¬', 'ê´‘ëª…ì‹œ', 'ë¶€ì²œì‹œ'],
                'ê¸ˆì²œêµ¬': ['êµ¬ë¡œêµ¬', 'ê´€ì•…êµ¬', 'ê´‘ëª…ì‹œ', 'ì•ˆì–‘ì‹œ'],
                'ì„±ë‚¨ì‹œ': ['ê°•ë‚¨êµ¬', 'ì„œì´ˆêµ¬', 'ì†¡íŒŒêµ¬', 'ë¶„ë‹¹êµ¬', 'ìˆ˜ì •êµ¬', 'ì¤‘ì›êµ¬', 'ê´‘ì£¼ì‹œ', 'í•˜ë‚¨ì‹œ', 'ìš©ì¸ì‹œ'],
                'ë¶„ë‹¹êµ¬': ['ê°•ë‚¨êµ¬', 'ì„œì´ˆêµ¬', 'ì„±ë‚¨ì‹œ', 'ìˆ˜ì •êµ¬', 'ì¤‘ì›êµ¬', 'ìš©ì¸ì‹œ', 'ê´‘ì£¼ì‹œ'],
                'ìš©ì¸ì‹œ': ['ì„±ë‚¨ì‹œ', 'ë¶„ë‹¹êµ¬', 'ìˆ˜ì›ì‹œ', 'ê´‘ì£¼ì‹œ', 'ì•ˆì„±ì‹œ', 'í™”ì„±ì‹œ'], 'ìˆ˜ì›ì‹œ': ['ìš©ì¸ì‹œ', 'í™”ì„±ì‹œ', 'ì•ˆì–‘ì‹œ', 'ì˜ì™•ì‹œ', 'ì•ˆì‚°ì‹œ', 'ì˜¤ì‚°ì‹œ'],
                'ì•ˆì–‘ì‹œ': ['ê´€ì•…êµ¬', 'ê¸ˆì²œêµ¬', 'ê³¼ì²œì‹œ', 'ì˜ì™•ì‹œ', 'ìˆ˜ì›ì‹œ', 'êµ°í¬ì‹œ', 'ê´‘ëª…ì‹œ'], 'ê³¼ì²œì‹œ': ['ì„œì´ˆêµ¬', 'ê´€ì•…êµ¬', 'ì•ˆì–‘ì‹œ', 'ì˜ì™•ì‹œ', 'ì„±ë‚¨ì‹œ'],
                'ê´‘ëª…ì‹œ': ['ì˜ë“±í¬êµ¬', 'êµ¬ë¡œêµ¬', 'ê¸ˆì²œêµ¬', 'ì•ˆì–‘ì‹œ', 'ì‹œí¥ì‹œ', 'ë¶€ì²œì‹œ'], 'ë¶€ì²œì‹œ': ['ì–‘ì²œêµ¬', 'ê°•ì„œêµ¬', 'êµ¬ë¡œêµ¬', 'ê´‘ëª…ì‹œ', 'ì‹œí¥ì‹œ', 'ê¹€í¬ì‹œ', 'ì¸ì²œ'],
                'ê³ ì–‘ì‹œ': ['ì„œëŒ€ë¬¸êµ¬', 'ë§ˆí¬êµ¬', 'ì€í‰êµ¬', 'ê°•ì„œêµ¬', 'ê¹€í¬ì‹œ', 'íŒŒì£¼ì‹œ', 'ì–‘ì£¼ì‹œ'], 'ì˜ì •ë¶€ì‹œ': ['ê°•ë¶êµ¬', 'ë„ë´‰êµ¬', 'ë…¸ì›êµ¬', 'ì–‘ì£¼ì‹œ', 'ë‚¨ì–‘ì£¼ì‹œ', 'í¬ì²œì‹œ'],
                'ë‚¨ì–‘ì£¼ì‹œ': ['ë…¸ì›êµ¬', 'ì¤‘ë‘êµ¬', 'êµ¬ë¦¬ì‹œ', 'ì˜ì •ë¶€ì‹œ', 'ê°€í‰êµ°', 'í¬ì²œì‹œ'], 'êµ¬ë¦¬ì‹œ': ['ê°•ë™êµ¬', 'ê´‘ì§„êµ¬', 'ì¤‘ë‘êµ¬', 'ë‚¨ì–‘ì£¼ì‹œ', 'í•˜ë‚¨ì‹œ'],
                'í•˜ë‚¨ì‹œ': ['ì†¡íŒŒêµ¬', 'ê°•ë™êµ¬', 'êµ¬ë¦¬ì‹œ', 'ë‚¨ì–‘ì£¼ì‹œ', 'ì„±ë‚¨ì‹œ', 'ê´‘ì£¼ì‹œ'], 'ê´‘ì£¼ì‹œ': ['ì„±ë‚¨ì‹œ', 'í•˜ë‚¨ì‹œ', 'ìš©ì¸ì‹œ', 'ì—¬ì£¼ì‹œ', 'ì´ì²œì‹œ'],
                'ì¸ì²œ': ['ë¶€ì²œì‹œ', 'ì‹œí¥ì‹œ', 'ê¹€í¬ì‹œ'], 'ì¸ì²œì‹œ': ['ë¶€ì²œì‹œ', 'ì‹œí¥ì‹œ', 'ê¹€í¬ì‹œ']
            };

            if (studentParts.region && hospitalParts.region && adjacent[studentParts.region]?.includes(hospitalParts.region)) score += 50;

            const regions = {
                'ì„œìš¸ë¶ë¶€': ['ì¢…ë¡œêµ¬', 'ì„±ë¶êµ¬', 'ê°•ë¶êµ¬', 'ë…¸ì›êµ¬', 'ë„ë´‰êµ¬', 'ë™ëŒ€ë¬¸êµ¬', 'ì¤‘ë‘êµ¬', 'ì˜ì •ë¶€ì‹œ', 'ì–‘ì£¼ì‹œ', 'í¬ì²œì‹œ'],
                'ì„œìš¸ë™ë¶€': ['ê´‘ì§„êµ¬', 'ì„±ë™êµ¬', 'ì¤‘êµ¬', 'êµ¬ë¦¬ì‹œ', 'ë‚¨ì–‘ì£¼ì‹œ', 'í•˜ë‚¨ì‹œ'],
                'ì„œìš¸ì„œë¶€': ['ì„œëŒ€ë¬¸êµ¬', 'ë§ˆí¬êµ¬', 'ì€í‰êµ¬', 'ê³ ì–‘ì‹œ', 'íŒŒì£¼ì‹œ', 'ê¹€í¬ì‹œ'],
                'ì„œìš¸ë‚¨ì„œ': ['ì˜ë“±í¬êµ¬', 'ì–‘ì²œêµ¬', 'ê°•ì„œêµ¬', 'êµ¬ë¡œêµ¬', 'ê¸ˆì²œêµ¬', 'ê´‘ëª…ì‹œ', 'ë¶€ì²œì‹œ', 'ì‹œí¥ì‹œ', 'ì¸ì²œ', 'ì¸ì²œì‹œ'],
                'ì„œìš¸ë‚¨ë¶€': ['ë™ì‘êµ¬', 'ê´€ì•…êµ¬', 'ì•ˆì–‘ì‹œ', 'ê³¼ì²œì‹œ', 'ì˜ì™•ì‹œ', 'êµ°í¬ì‹œ', 'ì•ˆì‚°ì‹œ'],
                'ê°•ë‚¨ê¶Œ': ['ê°•ë‚¨êµ¬', 'ì„œì´ˆêµ¬', 'ì†¡íŒŒêµ¬', 'ê°•ë™êµ¬', 'ì„±ë‚¨ì‹œ', 'ë¶„ë‹¹êµ¬', 'ìˆ˜ì •êµ¬', 'ì¤‘ì›êµ¬', 'í•˜ë‚¨ì‹œ', 'ê´‘ì£¼ì‹œ'],
                'ìˆ˜ì›ê¶Œ': ['ìˆ˜ì›ì‹œ', 'ìš©ì¸ì‹œ', 'í™”ì„±ì‹œ', 'ì˜¤ì‚°ì‹œ', 'í‰íƒì‹œ', 'ì•ˆì„±ì‹œ', 'ì´ì²œì‹œ', 'ì—¬ì£¼ì‹œ']
            };

            for (const areas of Object.values(regions)) {
                if (areas.includes(studentParts.region) && areas.includes(hospitalParts.region)) { score += 25; break; }
            }

            return score + Math.random() * 3;
        }

        function extractAddressParts(address) {
            if (!address) return { region: null };
            const guMatch = address.match(/([ê°€-í£]+êµ¬)/);
            const cityMatch = address.match(/([ê°€-í£]+[ì‹œêµ°])/);

            const seoulGu = ['ê°•ë‚¨êµ¬', 'ê°•ë™êµ¬', 'ê°•ë¶êµ¬', 'ê°•ì„œêµ¬', 'ê´€ì•…êµ¬', 'ê´‘ì§„êµ¬', 'êµ¬ë¡œêµ¬', 'ê¸ˆì²œêµ¬', 'ë…¸ì›êµ¬', 'ë„ë´‰êµ¬', 'ë™ëŒ€ë¬¸êµ¬', 'ë™ì‘êµ¬', 'ë§ˆí¬êµ¬', 'ì„œëŒ€ë¬¸êµ¬', 'ì„œì´ˆêµ¬', 'ì„±ë™êµ¬', 'ì„±ë¶êµ¬', 'ì†¡íŒŒêµ¬', 'ì–‘ì²œêµ¬', 'ì˜ë“±í¬êµ¬', 'ìš©ì‚°êµ¬', 'ì€í‰êµ¬', 'ì¢…ë¡œêµ¬', 'ì¤‘êµ¬', 'ì¤‘ë‘êµ¬'];
            const seongnamGu = ['ë¶„ë‹¹êµ¬', 'ìˆ˜ì •êµ¬', 'ì¤‘ì›êµ¬'];

            if (guMatch) {
                const gu = guMatch[1];
                if (seoulGu.includes(gu) || seongnamGu.includes(gu)) return { region: gu };
                if (cityMatch) return { region: cityMatch[1] };
            }
            if (cityMatch) return { region: cityMatch[1] };
            return { region: null };
        }

        // ====== ê²°ê³¼ í‘œì‹œ ======
        function showResults() {
            document.getElementById('noResultMessage').style.display = 'none';
            document.getElementById('resultContent').style.display = 'block';

            const total = students.length;
            const placed = placementResult.filter(r => r.status === 'ë°°ì¹˜ì™„ë£Œ').length;

            document.getElementById('statTotal').textContent = total;
            document.getElementById('statPlaced').textContent = placed;
            document.getElementById('statUnplaced').textContent = total - placed;
            document.getElementById('statRate').textContent = total > 0 ? Math.round((placed / total) * 100) + '%' : '0%';

            renderFilterButtons();
            renderResultTableHeader();
            filterResult('all');
            showHospitalSummary();
            document.getElementById('result-tab').click();
        }

        function renderFilterButtons() {
            const container = document.getElementById('filterButtons');
            let html = '<span class="me-3 fw-bold">í•„í„°:</span>';
            html += '<button class="filter-btn active" data-filter="all" onclick="filterResult(\'all\')">ì „ì²´</button>';
            config.classGroups.forEach(g => {
                html += `<button class="filter-btn" data-filter="${g.id}" onclick="filterResult('${g.id}')" style="border-color: ${g.textColor};">${g.name}</button>`;
            });
            html += '<span class="mx-1">|</span>';
            config.departments.forEach(d => {
                html += `<button class="filter-btn" data-filter="${d.id}" onclick="filterResult('${d.id}')" style="border-color: ${d.textColor};">${d.name}</button>`;
            });
            html += '<span class="mx-1">|</span>';
            html += '<button class="filter-btn text-danger" data-filter="lowscore" onclick="filterResult(\'lowscore\')">ì›ê±°ë¦¬</button>';
            container.innerHTML = html;
        }

        function renderResultTableHeader() {
            document.getElementById('resultTableHead').innerHTML = '<tr><th>í•™ë²ˆ</th><th>ì´ë¦„</th><th>ë¶„ë°˜</th><th>ì‹¤ìŠµê¸°ê°„</th><th>ì£¼ì†Œ</th><th>ë°°ì •ë³‘ì›</th><th>ì‹¤ìŠµë³‘ë™</th><th>ìƒíƒœ</th></tr>';
        }

        function filterResult(filter) {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter);
            });

            let filtered = placementResult;
            if (filter === 'lowscore') filtered = placementResult.filter(r => r.status === 'ë°°ì¹˜ì™„ë£Œ' && (r.score || 0) < 50);
            else if (config.classGroups.find(g => g.id === filter)) filtered = placementResult.filter(r => r.classId === filter);
            else if (config.departments.find(d => d.id === filter)) filtered = placementResult.filter(r => r.deptId === filter);

            document.getElementById('resultCount').textContent = filtered.length + 'ëª…';

            document.getElementById('resultTableBody').innerHTML = filtered.map(r => {
                const score = r.score || 0;
                const isLowScore = r.status === 'ë°°ì¹˜ì™„ë£Œ' && score < 50;
                const scoreLabel = score >= 100 ? 'ë™ì¼ì§€ì—­' : score >= 50 ? 'ì¸ì ‘ì§€ì—­' : 'ì›ê±°ë¦¬';
                const scoreClass = score >= 100 ? 'text-success' : score >= 50 ? 'text-primary' : 'text-danger';
                const group = config.classGroups.find(g => g.id === r.classId);
                const dept = config.departments.find(d => d.id === r.deptId);
                const classStyle = group ? `background: ${group.color}; color: ${group.textColor};` : '';
                const deptStyle = dept ? `background: ${dept.color}; color: ${dept.textColor};` : '';

                return `
                <tr class="${r.status === 'ë¯¸ë°°ì¹˜' ? 'table-danger' : isLowScore ? 'table-warning' : r.isMixed ? 'table-info' : ''}">
                    <td>${r.studentId}</td><td>${r.name}</td>
                    <td><span class="badge" style="${classStyle}">${r.className}</span></td>
                    <td><span class="badge ${r.isMixed ? '' : 'bg-secondary'}" style="${r.isMixed ? 'background: #8b5cf6; color: white;' : ''}">${r.period}</span></td>
                    <td>${r.address}</td>
                    <td>${r.hospital}${r.hospitalAddr ? `<br><small class="text-muted">(${r.hospitalAddr})</small>` : ''}</td>
                    <td>${r.department !== '-' ? `<span class="badge" style="${deptStyle}">${r.department}</span>` : '-'}</td>
                    <td>${r.status === 'ë°°ì¹˜ì™„ë£Œ' ? `<span class="badge ${isLowScore ? 'bg-warning text-dark' : 'bg-success'}">${r.isMixed ? 'ì¶”ê°€' : 'ì™„ë£Œ'}</span><br><small class="${scoreClass}">${scoreLabel}</small>` : '<span class="badge bg-danger">ë¯¸ë°°ì¹˜</span>'}</td>
                </tr>`;
            }).join('');
        }

        function showHospitalSummary() {
            const slots = getPlacementSlots();
            const summary = {};
            hospitals.forEach(h => {
                summary[h.name] = {};
                slots.forEach(slot => {
                    summary[h.name][slot.id] = {};
                    config.departments.forEach(dept => {
                        summary[h.name][slot.id][dept.id] = { placed: 0, total: h[`${slot.id}_${dept.id}`] || 0 };
                    });
                });
            });

            placementResult.forEach(r => {
                if (r.hospital !== '-' && summary[r.hospital] && r.slotId && summary[r.hospital][r.slotId]?.[r.deptId]) {
                    summary[r.hospital][r.slotId][r.deptId].placed++;
                }
            });

            let headerRow1 = '<th rowspan="2" class="align-middle text-center">ë³‘ì›ëª…</th>';
            let headerRow2 = '';
            slots.forEach(slot => {
                const group = config.classGroups.find(g => g.id === slot.classId);
                const style = group ? `background: ${group.color}; color: ${group.textColor};` : 'background: #ede9fe; color: #7c3aed;';
                headerRow1 += `<th colspan="${config.departments.length}" class="text-center" style="${style}; font-size: 0.7rem;">${slot.label}</th>`;
                config.departments.forEach(dept => {
                    headerRow2 += `<th class="text-center" style="font-size:0.65rem; background: ${dept.color};">${dept.name.substring(0, 2)}</th>`;
                });
            });
            headerRow1 += '<th rowspan="2" class="align-middle text-center">ì´ê³„</th>';
            document.getElementById('hospitalSummaryHead').innerHTML = `<tr>${headerRow1}</tr><tr>${headerRow2}</tr>`;

            document.getElementById('hospitalSummaryBody').innerHTML = Object.entries(summary).map(([name, data]) => {
                let totalPlaced = 0, cells = '';
                slots.forEach(slot => {
                    config.departments.forEach(dept => {
                        const info = data[slot.id][dept.id];
                        totalPlaced += info.placed;
                        const isFull = info.placed >= info.total && info.total > 0;
                        cells += `<td class="text-center ${isFull ? 'text-success fw-bold' : ''}" style="font-size:0.75rem;">${info.total > 0 ? `${info.placed}/${info.total}` : '-'}</td>`;
                    });
                });
                return `<tr><td>${name}</td>${cells}<td class="text-center"><strong>${totalPlaced}ëª…</strong></td></tr>`;
            }).join('');
        }

        function downloadResult() {
            if (placementResult.length === 0) { alert('ë‹¤ìš´ë¡œë“œí•  ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }

            const ws = XLSX.utils.json_to_sheet(placementResult.map(r => ({
                'í•™ë²ˆ': r.studentId, 'ì´ë¦„': r.name, 'ë¶„ë°˜': r.className, 'ì‹¤ìŠµê¸°ê°„': r.period,
                'ë°°ì¹˜ìœ í˜•': r.isMixed ? 'ì¶”ê°€ë°°ì¹˜' : 'ì •ê·œë°°ì¹˜', 'ì£¼ì†Œ': r.address, 'ë°°ì •ë³‘ì›': r.hospital, 'ì‹¤ìŠµë³‘ë™': r.department, 'ìƒíƒœ': r.status
            })));

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'ë°°ì¹˜ê²°ê³¼');

            const slots = getPlacementSlots();
            const summaryData = hospitals.map(h => {
                const row = { 'ë³‘ì›ëª…': h.name };
                slots.forEach(slot => {
                    config.departments.forEach(dept => {
                        const placed = placementResult.filter(r => r.hospital === h.name && r.slotId === slot.id && r.deptId === dept.id).length;
                        row[`${slot.label}_${dept.name}`] = `${placed}/${h[`${slot.id}_${dept.id}`] || 0}`;
                    });
                });
                return row;
            });
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(summaryData), 'ë³‘ì›ë³„í˜„í™©');
            XLSX.writeFile(wb, `${config.subjectName || 'ì„ìƒì‹¤ìŠµ'}_ë°°ì¹˜ê²°ê³¼_${new Date().toISOString().slice(0,10)}.xlsx`);
        }

        function showGuide() {
            new bootstrap.Modal(document.getElementById('guideModal')).show();
        }
    </script>
</body>
</html>
