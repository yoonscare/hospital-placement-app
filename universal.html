<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë²”ìš© ì„ìƒì‹¤ìŠµ ë°°ì¹˜ ì‹œìŠ¤í…œ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #818cf8;
            --bg-gradient: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        }

        * {
            font-family: 'Noto Sans KR', sans-serif;
        }

        body {
            background: #f8fafc;
            min-height: 100vh;
        }

        .header {
            background: var(--bg-gradient);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }

        .header h1 {
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .card {
            border: none;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-bottom: 1.5rem;
        }

        .card-header {
            background: white;
            border-bottom: 1px solid #e2e8f0;
            border-radius: 16px 16px 0 0 !important;
            font-weight: 600;
            padding: 1rem 1.5rem;
        }

        .btn-primary {
            background: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            border-color: var(--primary-dark);
        }

        .upload-zone {
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            padding: 3rem 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8fafc;
        }

        .upload-zone:hover, .upload-zone.dragover {
            border-color: var(--primary-color);
            background: #eef2ff;
        }

        .setting-input {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 0.5rem 1rem;
        }

        .setting-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .dept-tag {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            margin: 0.25rem;
            font-size: 0.85rem;
            background: #e0e7ff;
            color: #4338ca;
        }

        .dept-tag button {
            background: none;
            border: none;
            color: #6366f1;
            margin-left: 0.5rem;
            cursor: pointer;
            font-weight: bold;
        }

        .class-tag {
            display: inline-flex;
            align-items: center;
            padding: 0.35rem 0.85rem;
            border-radius: 20px;
            margin: 0.25rem;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .hospital-table {
            font-size: 0.8rem;
        }

        .hospital-table input[type="text"] {
            width: 100%;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 0.4rem 0.6rem;
            font-size: 0.85rem;
        }

        .hospital-table input[type="number"] {
            width: 50px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            padding: 0.25rem;
            text-align: center;
            font-size: 0.8rem;
        }

        .hospital-table input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.1);
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .stat-card .number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .stat-card .label {
            color: #64748b;
            font-size: 0.9rem;
        }

        .result-table {
            font-size: 0.85rem;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            display: none;
        }

        .loading-overlay.show {
            display: flex;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e2e8f0;
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .nav-tabs .nav-link {
            color: #64748b;
            border: none;
            padding: 1rem 1.5rem;
            font-weight: 500;
        }

        .nav-tabs .nav-link.active {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
            background: transparent;
        }

        .filter-btn {
            border: 1px solid #e2e8f0;
            background: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
            transition: all 0.2s;
        }

        .filter-btn:hover, .filter-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .table-scroll-wrapper {
            overflow-x: auto;
            max-width: 100%;
        }

        .capacity-summary {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .capacity-box {
            background: white;
            border-radius: 8px;
            padding: 0.75rem 1rem;
            text-align: center;
            border: 1px solid #e2e8f0;
            min-width: 120px;
        }

        .capacity-box .class-name {
            font-weight: 600;
            font-size: 0.85rem;
            margin-bottom: 0.25rem;
        }

        .capacity-box .capacity-total {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .capacity-box .capacity-detail {
            font-size: 0.7rem;
            color: #64748b;
        }

        .schedule-preview {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
        }

        .schedule-item {
            display: inline-flex;
            align-items: center;
            padding: 0.4rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            margin: 0.25rem;
            font-size: 0.9rem;
        }

        .color-palette {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .color-option {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .color-option:hover, .color-option.selected {
            transform: scale(1.1);
            border-color: #1f2937;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 1.5rem;
        }

        .step {
            display: flex;
            align-items: center;
            color: #94a3b8;
        }

        .step.active {
            color: var(--primary-color);
        }

        .step.completed {
            color: #10b981;
        }

        .step-number {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-right: 0.5rem;
        }

        .step.active .step-number {
            background: var(--primary-color);
            color: white;
        }

        .step.completed .step-number {
            background: #10b981;
            color: white;
        }

        .step-connector {
            width: 40px;
            height: 2px;
            background: #e2e8f0;
            margin: 0 0.5rem;
        }

        .step.completed + .step-connector {
            background: #10b981;
        }

        .info-alert {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            color: #1e40af;
            border-radius: 8px;
            padding: 1rem;
            font-size: 0.9rem;
        }

        .warning-alert {
            background: #fef3c7;
            border: 1px solid #fde68a;
            color: #92400e;
            border-radius: 8px;
            padding: 1rem;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="text-center">
            <div class="spinner mx-auto mb-3"></div>
            <p class="text-muted">ë°°ì¹˜ ì²˜ë¦¬ ì¤‘...</p>
        </div>
    </div>

    <header class="header">
        <div class="container">
            <h1>ğŸ¥ ë²”ìš© ì„ìƒì‹¤ìŠµ ë°°ì¹˜ ì‹œìŠ¤í…œ</h1>
            <p class="mb-0 opacity-75">ëª¨ë“  ì‹¤ìŠµê³¼ëª©ì„ ìœ„í•œ ìŠ¤ë§ˆíŠ¸ ë³‘ì› ë°°ì •</p>
        </div>
    </header>

    <div class="container pb-5">
        <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
        <ul class="nav nav-tabs mb-4" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="setup-tab" data-bs-toggle="tab" data-bs-target="#setup-panel" type="button">
                    1ï¸âƒ£ ê³¼ëª©/ë¶„ë°˜ ì„¤ì •
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="hospital-tab" data-bs-toggle="tab" data-bs-target="#hospital-panel" type="button">
                    2ï¸âƒ£ ë³‘ì› í‹°ì˜¤ ì„¤ì •
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload-panel" type="button">
                    3ï¸âƒ£ í•™ìƒ ì—…ë¡œë“œ
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="result-tab" data-bs-toggle="tab" data-bs-target="#result-panel" type="button">
                    4ï¸âƒ£ ë°°ì¹˜ ê²°ê³¼
                </button>
            </li>
        </ul>

        <div class="tab-content" id="mainTabContent">
            <!-- ê³¼ëª©/ë¶„ë°˜ ì„¤ì • íƒ­ -->
            <div class="tab-pane fade show active" id="setup-panel" role="tabpanel">
                <div class="card">
                    <div class="card-header">ğŸ“š ì‹¤ìŠµê³¼ëª© ì„¤ì •</div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">ê³¼ëª©ëª…</label>
                                <input type="text" class="form-control setting-input" id="subjectName"
                                       placeholder="ì˜ˆ: ì„±ì¸ê°„í˜¸í•™ì‹¤ìŠµ, ì •ì‹ ê°„í˜¸í•™ì‹¤ìŠµ" value="">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-bold">ì‹¤ìŠµ ì£¼ì°¨ ìˆ˜</label>
                                <input type="number" class="form-control setting-input" id="totalWeeks"
                                       min="1" max="16" value="8">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-bold">ë¶„ë°˜ë‹¹ ì‹¤ìŠµ ì£¼</label>
                                <input type="number" class="form-control setting-input" id="weeksPerClass"
                                       min="1" max="8" value="2">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>ğŸ‘¥ ë¶„ë°˜ ì„¤ì •</span>
                        <button class="btn btn-sm btn-outline-primary" onclick="addClassGroup()">+ ë¶„ë°˜ ì¶”ê°€</button>
                    </div>
                    <div class="card-body">
                        <div class="info-alert mb-3">
                            ğŸ’¡ ì‹¤ìŠµì— ì°¸ì—¬í•˜ëŠ” ë¶„ë°˜ì„ ìˆœì„œëŒ€ë¡œ ì¶”ê°€í•˜ì„¸ìš”. ë“œë˜ê·¸ë¡œ ìˆœì„œë¥¼ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                        </div>
                        <div id="classGroupList"></div>
                        <div class="mt-3">
                            <button class="btn btn-outline-secondary btn-sm" onclick="addPresetClasses('ABC')">A,B,Cë°˜ ì¶”ê°€</button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="addPresetClasses('123')">1,2,3ë¶„ë°˜ ì¶”ê°€</button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>ğŸ¥ ì‹¤ìŠµ ë³‘ë™/ë¶€ì„œ ì„¤ì •</span>
                        <button class="btn btn-sm btn-outline-primary" onclick="addDepartment()">+ ë³‘ë™ ì¶”ê°€</button>
                    </div>
                    <div class="card-body">
                        <div class="info-alert mb-3">
                            ğŸ’¡ ê° ë³‘ì›ì—ì„œ í•™ìƒë“¤ì´ ì‹¤ìŠµí•  ë³‘ë™/ë¶€ì„œë¥¼ ì¶”ê°€í•˜ì„¸ìš”.
                        </div>
                        <div id="departmentList" class="mb-3"></div>
                        <div class="mt-3">
                            <button class="btn btn-outline-secondary btn-sm" onclick="addPresetDepts('peds')">ì•„ë™ê°„í˜¸(ì‹ ìƒì•„ì‹¤,ì†Œì•„ê³¼)</button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="addPresetDepts('adult')">ì„±ì¸ê°„í˜¸(ë‚´ê³¼,ì™¸ê³¼)</button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="addPresetDepts('psych')">ì •ì‹ ê°„í˜¸(íì‡„ë³‘ë™,ê°œë°©ë³‘ë™)</button>
                        </div>
                    </div>
                </div>

                <!-- ìŠ¤ì¼€ì¤„ ë¯¸ë¦¬ë³´ê¸° -->
                <div class="schedule-preview" id="schedulePreview">
                    <h6 class="mb-3"><strong>ğŸ“… ì‹¤ìŠµ ìŠ¤ì¼€ì¤„ ë¯¸ë¦¬ë³´ê¸°</strong></h6>
                    <div id="scheduleDisplay"></div>
                </div>

                <div class="text-end">
                    <button class="btn btn-outline-secondary me-2" onclick="resetSettings()">ì´ˆê¸°í™”</button>
                    <button class="btn btn-primary" onclick="saveSettings()">ğŸ’¾ ì„¤ì • ì €ì¥ ë° ë‹¤ìŒ ë‹¨ê³„</button>
                </div>
            </div>

            <!-- ë³‘ì› ì„¤ì • íƒ­ -->
            <div class="tab-pane fade" id="hospital-panel" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>ğŸ¥ ì‹¤ìŠµ ë³‘ì› ë° ë¶„ë°˜ë³„ í‹°ì˜¤ ì„¤ì •</span>
                        <button class="btn btn-sm btn-outline-primary" onclick="addHospitalRow()">+ ë³‘ì› ì¶”ê°€</button>
                    </div>
                    <div class="card-body">
                        <p class="text-muted small mb-3">
                            ğŸ’¡ ê° ë³‘ì›ì˜ <strong>ë¶„ë°˜ë³„ Â· ë³‘ë™ë³„</strong> ì •ì›(í‹°ì˜¤)ì„ ì…ë ¥í•˜ì„¸ìš”. ë§ˆì§€ë§‰ ì—´ì€ ì •ê·œ ê¸°ê°„ì— ë°°ì¹˜ë˜ì§€ ëª»í•œ í•™ìƒë“¤ì„ ìœ„í•œ ì¶”ê°€ í‹°ì˜¤ì…ë‹ˆë‹¤.
                        </p>
                        <div class="table-scroll-wrapper">
                            <table class="table table-bordered hospital-table mb-0" id="hospitalTable">
                                <thead id="hospitalTableHead"></thead>
                                <tbody id="hospitalTableBody"></tbody>
                            </table>
                        </div>

                        <!-- ë¶„ë°˜ë³„ ì •ì› ìš”ì•½ -->
                        <div class="capacity-summary" id="capacitySummary"></div>

                        <div class="text-end mt-3">
                            <button class="btn btn-outline-secondary me-2" onclick="resetHospitals()">ì´ˆê¸°í™”</button>
                            <button class="btn btn-primary" onclick="saveHospitals()">ğŸ’¾ ë³‘ì› ì„¤ì • ì €ì¥</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- í•™ìƒ ì—…ë¡œë“œ íƒ­ -->
            <div class="tab-pane fade" id="upload-panel" role="tabpanel">
                <div class="card">
                    <div class="card-header">ğŸ“„ í•™ìƒ ëª…ë‹¨ ì—…ë¡œë“œ</div>
                    <div class="card-body">
                        <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
                            <div class="mb-3">
                                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#818cf8" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="17 8 12 3 7 8"></polyline>
                                    <line x1="12" y1="3" x2="12" y2="15"></line>
                                </svg>
                            </div>
                            <h5>ì—‘ì…€ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ</h5>
                            <p class="text-muted mb-0">ì§€ì› í˜•ì‹: .xlsx, .xls, .csv</p>
                        </div>
                        <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" style="display: none;" onchange="handleFileUpload(event)">

                        <div class="info-alert mt-4">
                            <h6 class="mb-2"><strong>ğŸ“‹ í•„ìˆ˜ ì»¬ëŸ¼</strong></h6>
                            <ul class="mb-0">
                                <li><strong>í•™ë²ˆ</strong> - í•™ìƒ í•™ë²ˆ</li>
                                <li><strong>ì´ë¦„</strong> - í•™ìƒ ì´ë¦„</li>
                                <li><strong>ë°˜</strong> - ì„¤ì •í•œ ë¶„ë°˜ëª… (ì˜ˆ: A, B, C ë˜ëŠ” 1, 2, 3)</li>
                                <li><strong>ì£¼ì†Œ</strong> - ê±°ì£¼ì§€ ì£¼ì†Œ (êµ¬/ì‹œ í¬í•¨)</li>
                            </ul>
                        </div>

                        <div id="uploadPreview" style="display: none;">
                            <h5 class="mt-4 mb-3">ğŸ“Š ì—…ë¡œë“œëœ í•™ìƒ ëª…ë‹¨</h5>
                            <div class="row mb-3" id="classSummary"></div>
                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                <table class="table table-sm table-bordered" id="previewTable">
                                    <thead class="table-light" style="position: sticky; top: 0;">
                                        <tr>
                                            <th>#</th>
                                            <th>í•™ë²ˆ</th>
                                            <th>ì´ë¦„</th>
                                            <th>ë°˜</th>
                                            <th>ì£¼ì†Œ</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                            <div class="text-end mt-3">
                                <button class="btn btn-lg btn-primary" onclick="runPlacement()">
                                    ğŸš€ ë°°ì¹˜ ì‹œì‘í•˜ê¸°
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ë°°ì¹˜ ê²°ê³¼ íƒ­ -->
            <div class="tab-pane fade" id="result-panel" role="tabpanel">
                <div id="resultContent" style="display: none;">
                    <!-- í†µê³„ ì¹´ë“œ -->
                    <div class="row mb-4" id="statsRow">
                        <div class="col-md-3 col-6 mb-3">
                            <div class="stat-card">
                                <div class="number" id="statTotal">0</div>
                                <div class="label">ì „ì²´ í•™ìƒ</div>
                            </div>
                        </div>
                        <div class="col-md-3 col-6 mb-3">
                            <div class="stat-card">
                                <div class="number text-success" id="statPlaced">0</div>
                                <div class="label">ë°°ì¹˜ ì™„ë£Œ</div>
                            </div>
                        </div>
                        <div class="col-md-3 col-6 mb-3">
                            <div class="stat-card">
                                <div class="number text-danger" id="statUnplaced">0</div>
                                <div class="label">ë¯¸ë°°ì¹˜</div>
                            </div>
                        </div>
                        <div class="col-md-3 col-6 mb-3">
                            <div class="stat-card">
                                <div class="number text-info" id="statRate">0%</div>
                                <div class="label">ë°°ì¹˜ìœ¨</div>
                            </div>
                        </div>
                    </div>

                    <!-- í•„í„° -->
                    <div class="card mb-3">
                        <div class="card-body py-3">
                            <div class="d-flex flex-wrap align-items-center" id="filterButtons">
                                <span class="me-3 fw-bold">í•„í„°:</span>
                                <button class="filter-btn active" data-filter="all" onclick="filterResult('all')">ì „ì²´</button>
                            </div>
                        </div>
                    </div>

                    <!-- ê²°ê³¼ í…Œì´ë¸” -->
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span>ğŸ“‹ ë°°ì¹˜ ê²°ê³¼ <span class="badge bg-secondary" id="resultCount">0ëª…</span></span>
                            <button class="btn btn-sm btn-success" onclick="downloadResult()">
                                ğŸ“¥ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover result-table" id="resultTable">
                                    <thead class="table-light" id="resultTableHead"></thead>
                                    <tbody id="resultTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- ë³‘ì›ë³„ í˜„í™© -->
                    <div class="card mt-4">
                        <div class="card-header">ğŸ¥ ë³‘ì›ë³„ ë°°ì¹˜ í˜„í™©</div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm table-bordered" id="hospitalSummaryTable">
                                    <thead class="table-light" id="hospitalSummaryHead"></thead>
                                    <tbody id="hospitalSummaryBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="noResultMessage" class="text-center py-5 text-muted">
                    <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M12 6v6l4 2"></path>
                    </svg>
                    <h5 class="mt-3">ì•„ì§ ë°°ì¹˜ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</h5>
                    <p>í•™ìƒ ëª…ë‹¨ì„ ì—…ë¡œë“œí•˜ê³  ë°°ì¹˜ë¥¼ ì‹œì‘í•˜ì„¸ìš”.</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ====== ì „ì—­ ë³€ìˆ˜ ======
        let config = {
            subjectName: '',
            totalWeeks: 8,
            weeksPerClass: 2,
            classGroups: [],  // [{id: 'A', name: 'Aë°˜', color: '#...'}]
            departments: []   // [{id: 'ward1', name: 'ë‚´ê³¼ë³‘ë™', color: '#...'}]
        };

        let hospitals = [];
        let students = [];
        let placementResult = [];

        // ìƒ‰ìƒ íŒ”ë ˆíŠ¸
        const CLASS_COLORS = [
            '#fef3c7', '#dbeafe', '#d1fae5', '#fce7f3', '#e0e7ff', '#fed7aa', '#d9f99d', '#ccfbf1'
        ];
        const CLASS_TEXT_COLORS = [
            '#b45309', '#1d4ed8', '#059669', '#be185d', '#4338ca', '#c2410c', '#65a30d', '#0d9488'
        ];
        const DEPT_COLORS = [
            '#fee2e2', '#dbeafe', '#d1fae5', '#fef3c7', '#e0e7ff', '#fce7f3', '#ccfbf1', '#fed7aa'
        ];
        const DEPT_TEXT_COLORS = [
            '#dc2626', '#2563eb', '#059669', '#d97706', '#4f46e5', '#db2777', '#0d9488', '#ea580c'
        ];

        // ====== ì´ˆê¸°í™” ======
        document.addEventListener('DOMContentLoaded', function() {
            loadConfig();
            loadHospitals();
            initDragDrop();
            updateUI();
        });

        // ====== ì„¤ì • ê´€ë¦¬ ======
        function loadConfig() {
            const saved = localStorage.getItem('universal_config');
            if (saved) {
                config = JSON.parse(saved);
                document.getElementById('subjectName').value = config.subjectName || '';
                document.getElementById('totalWeeks').value = config.totalWeeks || 8;
                document.getElementById('weeksPerClass').value = config.weeksPerClass || 2;
            }
            renderClassGroups();
            renderDepartments();
        }

        function saveConfig() {
            config.subjectName = document.getElementById('subjectName').value;
            config.totalWeeks = parseInt(document.getElementById('totalWeeks').value) || 8;
            config.weeksPerClass = parseInt(document.getElementById('weeksPerClass').value) || 2;
            localStorage.setItem('universal_config', JSON.stringify(config));
        }

        function saveSettings() {
            if (config.classGroups.length === 0) {
                alert('ìµœì†Œ 1ê°œì˜ ë¶„ë°˜ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.');
                return;
            }
            if (config.departments.length === 0) {
                alert('ìµœì†Œ 1ê°œì˜ ë³‘ë™/ë¶€ì„œë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”.');
                return;
            }
            saveConfig();
            renderHospitalTable();
            updateCapacitySummary();
            alert('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
            document.getElementById('hospital-tab').click();
        }

        function resetSettings() {
            if (confirm('ëª¨ë“  ì„¤ì •ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                config = {
                    subjectName: '',
                    totalWeeks: 8,
                    weeksPerClass: 2,
                    classGroups: [],
                    departments: []
                };
                document.getElementById('subjectName').value = '';
                document.getElementById('totalWeeks').value = 8;
                document.getElementById('weeksPerClass').value = 2;
                localStorage.removeItem('universal_config');
                renderClassGroups();
                renderDepartments();
                updateScheduleDisplay();
            }
        }

        // ====== ë¶„ë°˜ ê´€ë¦¬ ======
        function addClassGroup(name = '', autoName = true) {
            const id = 'class_' + Date.now();
            const idx = config.classGroups.length;
            const defaultName = autoName && !name ? String.fromCharCode(65 + idx) + 'ë°˜' : name;

            config.classGroups.push({
                id: id,
                name: defaultName,
                color: CLASS_COLORS[idx % CLASS_COLORS.length],
                textColor: CLASS_TEXT_COLORS[idx % CLASS_TEXT_COLORS.length]
            });

            saveConfig();
            renderClassGroups();
            updateScheduleDisplay();
        }

        function removeClassGroup(id) {
            config.classGroups = config.classGroups.filter(c => c.id !== id);
            saveConfig();
            renderClassGroups();
            updateScheduleDisplay();
        }

        function updateClassGroupName(id, name) {
            const group = config.classGroups.find(c => c.id === id);
            if (group) {
                group.name = name;
                saveConfig();
                updateScheduleDisplay();
            }
        }

        function renderClassGroups() {
            const container = document.getElementById('classGroupList');
            if (config.classGroups.length === 0) {
                container.innerHTML = '<p class="text-muted">ë¶„ë°˜ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.</p>';
                return;
            }

            container.innerHTML = config.classGroups.map((g, idx) => `
                <div class="d-flex align-items-center mb-2 p-2 rounded" style="background: ${g.color}; border: 1px solid ${g.textColor}20;">
                    <span class="me-2 text-muted" style="cursor: move;">â‰¡</span>
                    <span class="badge me-2" style="background: ${g.textColor}; min-width: 30px;">${idx + 1}</span>
                    <input type="text" class="form-control form-control-sm me-2" style="max-width: 150px;"
                           value="${g.name}" onchange="updateClassGroupName('${g.id}', this.value)">
                    <span class="text-muted small me-auto">ì£¼ì°¨: ${getWeekRangeForClass(idx)}</span>
                    <button class="btn btn-sm btn-outline-danger" onclick="removeClassGroup('${g.id}')">âœ•</button>
                </div>
            `).join('');
        }

        function addPresetClasses(type) {
            config.classGroups = [];
            if (type === 'ABC') {
                ['Aë°˜', 'Bë°˜', 'Cë°˜'].forEach((name, i) => {
                    config.classGroups.push({
                        id: 'class_' + Date.now() + i,
                        name: name,
                        color: CLASS_COLORS[i],
                        textColor: CLASS_TEXT_COLORS[i]
                    });
                });
            } else if (type === '123') {
                ['1ë¶„ë°˜', '2ë¶„ë°˜', '3ë¶„ë°˜'].forEach((name, i) => {
                    config.classGroups.push({
                        id: 'class_' + Date.now() + i,
                        name: name,
                        color: CLASS_COLORS[i],
                        textColor: CLASS_TEXT_COLORS[i]
                    });
                });
            }
            saveConfig();
            renderClassGroups();
            updateScheduleDisplay();
        }

        function getWeekRangeForClass(idx) {
            const weeksPerClass = config.weeksPerClass || 2;
            const start = idx * weeksPerClass + 1;
            const end = start + weeksPerClass - 1;
            return `${start}-${end}ì£¼`;
        }

        // ====== ë³‘ë™/ë¶€ì„œ ê´€ë¦¬ ======
        function addDepartment(name = '') {
            const id = 'dept_' + Date.now();
            const idx = config.departments.length;

            config.departments.push({
                id: id,
                name: name || 'ë³‘ë™' + (idx + 1),
                color: DEPT_COLORS[idx % DEPT_COLORS.length],
                textColor: DEPT_TEXT_COLORS[idx % DEPT_TEXT_COLORS.length]
            });

            saveConfig();
            renderDepartments();
        }

        function removeDepartment(id) {
            config.departments = config.departments.filter(d => d.id !== id);
            saveConfig();
            renderDepartments();
        }

        function updateDepartmentName(id, name) {
            const dept = config.departments.find(d => d.id === id);
            if (dept) {
                dept.name = name;
                saveConfig();
            }
        }

        function renderDepartments() {
            const container = document.getElementById('departmentList');
            if (config.departments.length === 0) {
                container.innerHTML = '<p class="text-muted">ë³‘ë™/ë¶€ì„œë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”.</p>';
                return;
            }

            container.innerHTML = config.departments.map(d => `
                <span class="dept-tag" style="background: ${d.color}; color: ${d.textColor};">
                    <input type="text" value="${d.name}" style="border: none; background: transparent; color: inherit; width: 80px; font-size: inherit;"
                           onchange="updateDepartmentName('${d.id}', this.value)">
                    <button onclick="removeDepartment('${d.id}')">âœ•</button>
                </span>
            `).join('');
        }

        function addPresetDepts(type) {
            config.departments = [];
            let depts = [];
            if (type === 'peds') {
                depts = ['ì‹ ìƒì•„ì‹¤', 'ì†Œì•„ê³¼'];
            } else if (type === 'adult') {
                depts = ['ë‚´ê³¼ë³‘ë™', 'ì™¸ê³¼ë³‘ë™'];
            } else if (type === 'psych') {
                depts = ['íì‡„ë³‘ë™', 'ê°œë°©ë³‘ë™'];
            }

            depts.forEach((name, i) => {
                config.departments.push({
                    id: 'dept_' + Date.now() + i,
                    name: name,
                    color: DEPT_COLORS[i],
                    textColor: DEPT_TEXT_COLORS[i]
                });
            });

            saveConfig();
            renderDepartments();
        }

        // ====== ìŠ¤ì¼€ì¤„ í‘œì‹œ ======
        function updateScheduleDisplay() {
            const container = document.getElementById('scheduleDisplay');
            if (config.classGroups.length === 0) {
                container.innerHTML = '<p class="text-muted mb-0">ë¶„ë°˜ì„ ì¶”ê°€í•˜ë©´ ìŠ¤ì¼€ì¤„ì´ í‘œì‹œë©ë‹ˆë‹¤.</p>';
                return;
            }

            let html = '';
            config.classGroups.forEach((g, idx) => {
                if (idx > 0) html += '<span class="mx-1">â†’</span>';
                html += `<span class="schedule-item" style="background: ${g.color}; color: ${g.textColor};">
                    ${getWeekRangeForClass(idx)}: ${g.name}
                </span>`;
            });

            // ì¶”ê°€ ë°°ì¹˜ ì£¼ì°¨ (ì •ê·œ ê¸°ê°„ ì´í›„)
            const regularWeeks = config.classGroups.length * config.weeksPerClass;
            if (regularWeeks < config.totalWeeks) {
                html += '<span class="mx-1">â†’</span>';
                html += `<span class="schedule-item" style="background: #ede9fe; color: #7c3aed;">
                    ${regularWeeks + 1}-${config.totalWeeks}ì£¼: ì¶”ê°€ë°°ì¹˜
                </span>`;
            }

            container.innerHTML = html;
        }

        function updateUI() {
            updateScheduleDisplay();
        }

        // ====== ë³‘ì› ê´€ë¦¬ ======
        function loadHospitals() {
            const saved = localStorage.getItem('universal_hospitals');
            if (saved) {
                hospitals = JSON.parse(saved);
            } else {
                hospitals = [];
            }
            renderHospitalTable();
            updateCapacitySummary();
        }

        function renderHospitalTable() {
            if (config.classGroups.length === 0 || config.departments.length === 0) {
                document.getElementById('hospitalTableHead').innerHTML = '';
                document.getElementById('hospitalTableBody').innerHTML = '<tr><td colspan="3" class="text-center text-muted py-4">ë¨¼ì € ê³¼ëª©/ë¶„ë°˜ ì„¤ì •ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”.</td></tr>';
                return;
            }

            const slots = getPlacementSlots();
            const thead = document.getElementById('hospitalTableHead');
            const tbody = document.getElementById('hospitalTableBody');

            // í—¤ë” ìƒì„±
            let headerRow1 = `
                <th rowspan="2" class="align-middle text-center" style="min-width:120px;">ë³‘ì›ëª…</th>
                <th rowspan="2" class="align-middle text-center" style="min-width:100px;">ì£¼ì†Œ(êµ¬/ì‹œ)</th>
            `;

            slots.forEach((slot, idx) => {
                const group = config.classGroups.find(g => g.id === slot.classId);
                const style = group ? `background: ${group.color}; color: ${group.textColor};` : 'background: #ede9fe; color: #7c3aed;';
                headerRow1 += `<th colspan="${config.departments.length}" class="text-center" style="${style}">
                    ${slot.label}
                </th>`;
            });
            headerRow1 += `<th rowspan="2" class="align-middle text-center" style="width:40px;"></th>`;

            let headerRow2 = '';
            slots.forEach(slot => {
                config.departments.forEach(dept => {
                    headerRow2 += `<th class="text-center" style="font-size:0.7rem; background: ${dept.color};">${dept.name.substring(0, 3)}</th>`;
                });
            });

            thead.innerHTML = `<tr>${headerRow1}</tr><tr>${headerRow2}</tr>`;

            // ë°”ë”” ìƒì„±
            tbody.innerHTML = hospitals.map((h, idx) => {
                let cellsHtml = `
                    <td><input type="text" value="${h.name || ''}" onchange="updateHospital(${idx}, 'name', this.value)" placeholder="ë³‘ì›ëª…"></td>
                    <td><input type="text" value="${h.address || ''}" onchange="updateHospital(${idx}, 'address', this.value)" placeholder="êµ¬/ì‹œ"></td>
                `;

                slots.forEach(slot => {
                    config.departments.forEach(dept => {
                        const key = `${slot.id}_${dept.id}`;
                        cellsHtml += `<td class="text-center" style="background: ${dept.color}20;">
                            <input type="number" min="0" value="${h[key] || 0}" onchange="updateHospital(${idx}, '${key}', this.value)">
                        </td>`;
                    });
                });

                cellsHtml += `<td><button class="btn btn-sm btn-outline-danger" onclick="removeHospital(${idx})">âœ•</button></td>`;

                return `<tr>${cellsHtml}</tr>`;
            }).join('');

            if (hospitals.length === 0) {
                const colSpan = 3 + slots.length * config.departments.length;
                tbody.innerHTML = `<tr><td colspan="${colSpan}" class="text-center text-muted py-4">ë³‘ì›ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.</td></tr>`;
            }
        }

        function getPlacementSlots() {
            const slots = [];

            // ê° ë¶„ë°˜ë³„ ìŠ¬ë¡¯
            config.classGroups.forEach((g, idx) => {
                slots.push({
                    id: g.id,
                    classId: g.id,
                    label: `${g.name} (${getWeekRangeForClass(idx)})`,
                    isMixed: false
                });
            });

            // ì¶”ê°€ ë°°ì¹˜ ìŠ¬ë¡¯
            const regularWeeks = config.classGroups.length * config.weeksPerClass;
            if (regularWeeks < config.totalWeeks) {
                slots.push({
                    id: 'mixed',
                    classId: null,
                    label: `ì¶”ê°€ë°°ì¹˜ (${regularWeeks + 1}-${config.totalWeeks}ì£¼)`,
                    isMixed: true
                });
            }

            return slots;
        }

        function addHospitalRow() {
            const newHospital = { name: '', address: '' };
            const slots = getPlacementSlots();
            slots.forEach(slot => {
                config.departments.forEach(dept => {
                    newHospital[`${slot.id}_${dept.id}`] = 0;
                });
            });
            hospitals.push(newHospital);
            renderHospitalTable();
            updateCapacitySummary();
        }

        function updateHospital(idx, field, value) {
            if (field === 'name' || field === 'address') {
                hospitals[idx][field] = value;
            } else {
                hospitals[idx][field] = parseInt(value) || 0;
            }
            updateCapacitySummary();
        }

        function removeHospital(idx) {
            hospitals.splice(idx, 1);
            renderHospitalTable();
            updateCapacitySummary();
        }

        function updateCapacitySummary() {
            const container = document.getElementById('capacitySummary');
            if (config.classGroups.length === 0 || config.departments.length === 0) {
                container.innerHTML = '';
                return;
            }

            const slots = getPlacementSlots();
            const summary = {};

            slots.forEach(slot => {
                summary[slot.id] = { total: 0, byDept: {} };
                config.departments.forEach(dept => {
                    summary[slot.id].byDept[dept.id] = 0;
                });
            });

            hospitals.forEach(h => {
                slots.forEach(slot => {
                    config.departments.forEach(dept => {
                        const key = `${slot.id}_${dept.id}`;
                        const val = h[key] || 0;
                        summary[slot.id].byDept[dept.id] += val;
                        summary[slot.id].total += val;
                    });
                });
            });

            container.innerHTML = slots.map(slot => {
                const group = config.classGroups.find(g => g.id === slot.classId);
                const borderColor = group ? group.textColor : '#7c3aed';

                const deptDetails = config.departments.map(dept =>
                    `${dept.name.substring(0, 2)} ${summary[slot.id].byDept[dept.id]}`
                ).join(' / ');

                return `
                    <div class="capacity-box" style="border-left: 4px solid ${borderColor};">
                        <div class="class-name">${slot.label}</div>
                        <div class="capacity-total">${summary[slot.id].total}ëª…</div>
                        <div class="capacity-detail">${deptDetails}</div>
                    </div>
                `;
            }).join('');
        }

        function saveHospitals() {
            localStorage.setItem('universal_hospitals', JSON.stringify(hospitals));
            alert('ë³‘ì› ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }

        function resetHospitals() {
            if (confirm('ë³‘ì› ì„¤ì •ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                hospitals = [];
                localStorage.removeItem('universal_hospitals');
                renderHospitalTable();
                updateCapacitySummary();
            }
        }

        // ====== íŒŒì¼ ì—…ë¡œë“œ ======
        function initDragDrop() {
            const zone = document.getElementById('uploadZone');

            zone.addEventListener('dragover', (e) => {
                e.preventDefault();
                zone.classList.add('dragover');
            });

            zone.addEventListener('dragleave', () => {
                zone.classList.remove('dragover');
            });

            zone.addEventListener('drop', (e) => {
                e.preventDefault();
                zone.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                if (file) processFile(file);
            });
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) processFile(file);
        }

        function processFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(sheet);

                    // ìœ íš¨í•œ ë¶„ë°˜ ì´ë¦„ ëª©ë¡
                    const validClassNames = config.classGroups.map(g => {
                        // "Aë°˜" -> "A", "1ë¶„ë°˜" -> "1" ë“± ë‹¤ì–‘í•œ í˜•ì‹ ì§€ì›
                        return {
                            id: g.id,
                            name: g.name,
                            normalized: g.name.replace(/[ë°˜ë¶„ë°˜]/g, '').trim().toUpperCase()
                        };
                    });

                    students = json.map(row => {
                        const normalized = {};
                        for (let key in row) {
                            const lowerKey = key.toLowerCase().trim();
                            if (lowerKey.includes('í•™ë²ˆ') || lowerKey === 'id' || lowerKey === 'studentid') {
                                normalized.studentId = String(row[key]).trim();
                            } else if (lowerKey.includes('ì´ë¦„') || lowerKey === 'name') {
                                normalized.name = String(row[key]).trim();
                            } else if (lowerKey.includes('ë°˜') || lowerKey === 'class') {
                                let classVal = String(row[key]).replace(/[ë°˜ë¶„ë°˜]/g, '').trim().toUpperCase();
                                // ë¶„ë°˜ ID ì°¾ê¸°
                                const found = validClassNames.find(v => v.normalized === classVal || v.name === row[key]);
                                normalized.classId = found ? found.id : null;
                                normalized.className = found ? found.name : row[key];
                            } else if (lowerKey.includes('ì£¼ì†Œ') || lowerKey === 'address') {
                                normalized.address = String(row[key]).trim();
                            }
                        }
                        return normalized;
                    }).filter(s => s.studentId && s.name && s.classId && s.address);

                    if (students.length === 0) {
                        alert('ì˜¬ë°”ë¥¸ í˜•ì‹ì˜ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\ní•„ìˆ˜ ì»¬ëŸ¼: í•™ë²ˆ, ì´ë¦„, ë°˜, ì£¼ì†Œ\n\në¶„ë°˜ëª…ì´ ì„¤ì •ê³¼ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.');
                        return;
                    }

                    showPreview();
                } catch (error) {
                    alert('íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function showPreview() {
            const preview = document.getElementById('uploadPreview');
            const table = document.getElementById('previewTable');

            // ë¶„ë°˜ë³„ í•™ìƒ ìˆ˜ ê³„ì‚°
            const classCounts = {};
            config.classGroups.forEach(g => classCounts[g.id] = 0);
            students.forEach(s => {
                if (classCounts[s.classId] !== undefined) {
                    classCounts[s.classId]++;
                }
            });

            // ë¶„ë°˜ë³„ ìš”ì•½ í‘œì‹œ
            const colSize = Math.max(Math.floor(12 / config.classGroups.length), 3);
            document.getElementById('classSummary').innerHTML = config.classGroups.map((g, idx) => `
                <div class="col-${colSize}">
                    <div class="stat-card py-2" style="border-left: 3px solid ${g.textColor};">
                        <div class="number fs-5" style="color: ${g.textColor};">${classCounts[g.id]}</div>
                        <small class="text-muted">${g.name} (${getWeekRangeForClass(idx)})</small>
                    </div>
                </div>
            `).join('');

            // í…Œì´ë¸” ë°ì´í„°
            table.querySelector('tbody').innerHTML = students.map((s, i) => {
                const group = config.classGroups.find(g => g.id === s.classId);
                const style = group ? `background: ${group.color}; color: ${group.textColor};` : '';
                return `
                    <tr>
                        <td>${i + 1}</td>
                        <td>${s.studentId}</td>
                        <td>${s.name}</td>
                        <td><span class="badge" style="${style}">${s.className}</span></td>
                        <td>${s.address}</td>
                    </tr>
                `;
            }).join('');

            preview.style.display = 'block';
        }

        // ====== ë°°ì¹˜ ì•Œê³ ë¦¬ì¦˜ ======
        function runPlacement() {
            if (hospitals.length === 0) {
                alert('ë¨¼ì € ë³‘ì› ì„¤ì •ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”.');
                return;
            }

            document.getElementById('loadingOverlay').classList.add('show');

            setTimeout(() => {
                try {
                    placementResult = performPlacement();
                    showResults();
                } catch (error) {
                    alert('ë°°ì¹˜ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                    console.error(error);
                } finally {
                    document.getElementById('loadingOverlay').classList.remove('show');
                }
            }, 500);
        }

        function performPlacement() {
            const results = [];
            const unplacedStudents = [];
            const slots = getPlacementSlots();

            // ë³‘ì›ë³„ ì”ì—¬ ì •ì› ë³µì‚¬
            const remaining = hospitals.map((h, idx) => {
                const r = { name: h.name, address: h.address, originalIdx: idx };
                slots.forEach(slot => {
                    config.departments.forEach(dept => {
                        r[`${slot.id}_${dept.id}`] = h[`${slot.id}_${dept.id}`] || 0;
                    });
                });
                return r;
            });

            // ë¶„ë°˜ë³„ë¡œ í•™ìƒ ê·¸ë£¹í™”
            const studentsByClass = {};
            config.classGroups.forEach(g => studentsByClass[g.id] = []);
            students.forEach(s => {
                if (studentsByClass[s.classId]) {
                    studentsByClass[s.classId].push({ ...s });
                }
            });

            // 1ë‹¨ê³„: ì •ê·œ ê¸°ê°„ ë°°ì¹˜
            for (const group of config.classGroups) {
                const classStudents = studentsByClass[group.id];
                if (classStudents.length === 0) continue;

                const slotId = group.id;
                const groupIdx = config.classGroups.findIndex(g => g.id === group.id);

                // ë³‘ì›ë³„ ì ìˆ˜ ê³„ì‚°
                classStudents.forEach(student => {
                    student.hospitalScores = remaining.map((h, idx) => ({
                        idx,
                        hospital: h,
                        score: calculateAddressScore(student.address, h.address)
                    })).sort((a, b) => b.score - a.score);
                    student.bestScore = student.hospitalScores[0]?.score || 0;
                });

                // ì œì•½ì´ ë§ì€ í•™ìƒ ìš°ì„ 
                classStudents.sort((a, b) => a.bestScore - b.bestScore);

                // ë¶€ì„œë³„ ë°°ì¹˜ ì¹´ìš´íŠ¸
                const deptCounts = {};
                config.departments.forEach(d => deptCounts[d.id] = 0);

                const classResults = [];

                for (const student of classStudents) {
                    let placed = false;

                    // ë¶€ì„œ ê· í˜• ë§ì¶”ê¸°
                    const deptOrder = [...config.departments].sort((a, b) =>
                        deptCounts[a.id] - deptCounts[b.id]
                    );

                    for (const { idx } of student.hospitalScores) {
                        const hospital = remaining[idx];
                        for (const dept of deptOrder) {
                            const key = `${slotId}_${dept.id}`;
                            if (hospital[key] > 0) {
                                hospital[key]--;
                                deptCounts[dept.id]++;

                                classResults.push({
                                    studentId: student.studentId,
                                    name: student.name,
                                    classId: student.classId,
                                    className: student.className,
                                    address: student.address,
                                    hospitalIdx: idx,
                                    hospitalName: hospital.name,
                                    hospitalAddr: hospital.address,
                                    deptId: dept.id,
                                    deptName: dept.name,
                                    score: student.hospitalScores.find(h => h.idx === idx).score,
                                    slotId: slotId
                                });
                                placed = true;
                                break;
                            }
                        }
                        if (placed) break;
                    }

                    if (!placed) {
                        unplacedStudents.push(student);
                    }
                }

                // êµí™˜ ê°œì„ 
                let improved = true;
                let iterations = 0;
                while (improved && iterations < 100) {
                    improved = false;
                    iterations++;

                    for (let i = 0; i < classResults.length; i++) {
                        for (let j = i + 1; j < classResults.length; j++) {
                            const r1 = classResults[i];
                            const r2 = classResults[j];

                            if (r1.deptId !== r2.deptId) continue;

                            const student1 = classStudents.find(s => s.studentId === r1.studentId);
                            const student2 = classStudents.find(s => s.studentId === r2.studentId);

                            const currentScore = r1.score + r2.score;
                            const newScore1 = calculateAddressScore(student1.address, remaining[r2.hospitalIdx].address);
                            const newScore2 = calculateAddressScore(student2.address, remaining[r1.hospitalIdx].address);

                            if (newScore1 + newScore2 > currentScore) {
                                const tempIdx = r1.hospitalIdx;
                                const tempName = r1.hospitalName;
                                const tempAddr = r1.hospitalAddr;
                                r1.hospitalIdx = r2.hospitalIdx;
                                r1.hospitalName = r2.hospitalName;
                                r1.hospitalAddr = r2.hospitalAddr;
                                r1.score = newScore1;
                                r2.hospitalIdx = tempIdx;
                                r2.hospitalName = tempName;
                                r2.hospitalAddr = tempAddr;
                                r2.score = newScore2;
                                improved = true;
                            }
                        }
                    }
                }

                // ê²°ê³¼ ì €ì¥
                classResults.forEach(r => {
                    results.push({
                        studentId: r.studentId,
                        name: r.name,
                        classId: r.classId,
                        className: r.className,
                        period: getWeekRangeForClass(groupIdx),
                        slotId: r.slotId,
                        isMixed: false,
                        address: r.address,
                        hospital: r.hospitalName,
                        hospitalAddr: r.hospitalAddr,
                        deptId: r.deptId,
                        department: r.deptName,
                        score: r.score,
                        status: 'ë°°ì¹˜ì™„ë£Œ'
                    });
                });
            }

            // 2ë‹¨ê³„: ì¶”ê°€ ë°°ì¹˜ (mixed)
            const mixedSlot = slots.find(s => s.isMixed);
            if (mixedSlot && unplacedStudents.length > 0) {
                // ì ìˆ˜ ì¬ê³„ì‚°
                unplacedStudents.forEach(student => {
                    student.hospitalScores = remaining.map((h, idx) => ({
                        idx,
                        hospital: h,
                        score: calculateAddressScore(student.address, h.address)
                    })).sort((a, b) => b.score - a.score);
                    student.bestScore = student.hospitalScores[0]?.score || 0;
                });

                unplacedStudents.sort((a, b) => a.bestScore - b.bestScore);

                const deptCounts = {};
                config.departments.forEach(d => deptCounts[d.id] = 0);

                const mixedResults = [];

                for (const student of unplacedStudents) {
                    let placed = false;
                    const deptOrder = [...config.departments].sort((a, b) =>
                        deptCounts[a.id] - deptCounts[b.id]
                    );

                    for (const { idx } of student.hospitalScores) {
                        const hospital = remaining[idx];
                        for (const dept of deptOrder) {
                            const key = `${mixedSlot.id}_${dept.id}`;
                            if (hospital[key] > 0) {
                                hospital[key]--;
                                deptCounts[dept.id]++;

                                mixedResults.push({
                                    studentId: student.studentId,
                                    name: student.name,
                                    classId: student.classId,
                                    className: student.className,
                                    address: student.address,
                                    hospitalIdx: idx,
                                    hospitalName: hospital.name,
                                    hospitalAddr: hospital.address,
                                    deptId: dept.id,
                                    deptName: dept.name,
                                    score: student.hospitalScores.find(h => h.idx === idx).score
                                });
                                placed = true;
                                break;
                            }
                        }
                        if (placed) break;
                    }

                    if (!placed) {
                        results.push({
                            studentId: student.studentId,
                            name: student.name,
                            classId: student.classId,
                            className: student.className,
                            period: '-',
                            slotId: null,
                            isMixed: false,
                            address: student.address,
                            hospital: '-',
                            department: '-',
                            deptId: null,
                            score: 0,
                            status: 'ë¯¸ë°°ì¹˜'
                        });
                    }
                }

                // êµí™˜ ê°œì„ 
                let improved = true;
                let iterations = 0;
                while (improved && iterations < 100) {
                    improved = false;
                    iterations++;
                    for (let i = 0; i < mixedResults.length; i++) {
                        for (let j = i + 1; j < mixedResults.length; j++) {
                            const r1 = mixedResults[i];
                            const r2 = mixedResults[j];
                            if (r1.deptId !== r2.deptId) continue;

                            const student1 = unplacedStudents.find(s => s.studentId === r1.studentId);
                            const student2 = unplacedStudents.find(s => s.studentId === r2.studentId);

                            const currentScore = r1.score + r2.score;
                            const newScore1 = calculateAddressScore(student1.address, remaining[r2.hospitalIdx].address);
                            const newScore2 = calculateAddressScore(student2.address, remaining[r1.hospitalIdx].address);

                            if (newScore1 + newScore2 > currentScore) {
                                const tempIdx = r1.hospitalIdx;
                                const tempName = r1.hospitalName;
                                const tempAddr = r1.hospitalAddr;
                                r1.hospitalIdx = r2.hospitalIdx;
                                r1.hospitalName = r2.hospitalName;
                                r1.hospitalAddr = r2.hospitalAddr;
                                r1.score = newScore1;
                                r2.hospitalIdx = tempIdx;
                                r2.hospitalName = tempName;
                                r2.hospitalAddr = tempAddr;
                                r2.score = newScore2;
                                improved = true;
                            }
                        }
                    }
                }

                const regularWeeks = config.classGroups.length * config.weeksPerClass;
                mixedResults.forEach(r => {
                    results.push({
                        studentId: r.studentId,
                        name: r.name,
                        classId: r.classId,
                        className: r.className,
                        period: `${regularWeeks + 1}-${config.totalWeeks}ì£¼`,
                        slotId: 'mixed',
                        isMixed: true,
                        address: r.address,
                        hospital: r.hospitalName,
                        hospitalAddr: r.hospitalAddr,
                        deptId: r.deptId,
                        department: r.deptName,
                        score: r.score,
                        status: 'ë°°ì¹˜ì™„ë£Œ'
                    });
                });
            }

            return results;
        }

        function calculateAddressScore(studentAddr, hospitalAddr) {
            const studentParts = extractAddressParts(studentAddr);
            const hospitalParts = extractAddressParts(hospitalAddr);

            let score = 0;

            // ê°™ì€ ì§€ì—­ì´ë©´ ìµœê³  ì ìˆ˜
            if (studentParts.region && hospitalParts.region && studentParts.region === hospitalParts.region) {
                score += 100;
            }

            // ì¸ì ‘ ì§€ì—­ ë³´ë„ˆìŠ¤
            const adjacent = {
                'ê°•ë‚¨êµ¬': ['ì„œì´ˆêµ¬', 'ì†¡íŒŒêµ¬', 'ê°•ë™êµ¬', 'ì„±ë‚¨ì‹œ', 'ë¶„ë‹¹êµ¬'],
                'ì„œì´ˆêµ¬': ['ê°•ë‚¨êµ¬', 'ë™ì‘êµ¬', 'ê´€ì•…êµ¬', 'ê³¼ì²œì‹œ', 'ì„±ë‚¨ì‹œ'],
                'ì†¡íŒŒêµ¬': ['ê°•ë‚¨êµ¬', 'ê°•ë™êµ¬', 'ê´‘ì§„êµ¬', 'í•˜ë‚¨ì‹œ', 'ì„±ë‚¨ì‹œ'],
                'ê°•ë™êµ¬': ['ì†¡íŒŒêµ¬', 'ê´‘ì§„êµ¬', 'í•˜ë‚¨ì‹œ', 'êµ¬ë¦¬ì‹œ'],
                'ì¢…ë¡œêµ¬': ['ì„±ë¶êµ¬', 'ë™ëŒ€ë¬¸êµ¬', 'ì¤‘êµ¬', 'ì„œëŒ€ë¬¸êµ¬', 'ì€í‰êµ¬'],
                'ì„œëŒ€ë¬¸êµ¬': ['ì¢…ë¡œêµ¬', 'ë§ˆí¬êµ¬', 'ì€í‰êµ¬', 'ê³ ì–‘ì‹œ'],
                'ì„±ë¶êµ¬': ['ì¢…ë¡œêµ¬', 'ë™ëŒ€ë¬¸êµ¬', 'ê°•ë¶êµ¬', 'ë…¸ì›êµ¬', 'ì˜ì •ë¶€ì‹œ'],
                'ë§ˆí¬êµ¬': ['ì„œëŒ€ë¬¸êµ¬', 'ìš©ì‚°êµ¬', 'ì€í‰êµ¬', 'ê³ ì–‘ì‹œ'],
                'ìš©ì‚°êµ¬': ['ë§ˆí¬êµ¬', 'ì¤‘êµ¬', 'ì„±ë™êµ¬', 'ë™ì‘êµ¬'],
                'ì¤‘êµ¬': ['ì¢…ë¡œêµ¬', 'ìš©ì‚°êµ¬', 'ì„±ë™êµ¬', 'ë™ëŒ€ë¬¸êµ¬'],
                'ë™ëŒ€ë¬¸êµ¬': ['ì¤‘êµ¬', 'ì¢…ë¡œêµ¬', 'ì„±ë¶êµ¬', 'ê´‘ì§„êµ¬', 'ì¤‘ë‘êµ¬'],
                'ê´‘ì§„êµ¬': ['ë™ëŒ€ë¬¸êµ¬', 'ì„±ë™êµ¬', 'ì†¡íŒŒêµ¬', 'ê°•ë™êµ¬', 'ì¤‘ë‘êµ¬', 'êµ¬ë¦¬ì‹œ'],
                'ì„±ë™êµ¬': ['ê´‘ì§„êµ¬', 'ì¤‘êµ¬', 'ìš©ì‚°êµ¬', 'ë™ëŒ€ë¬¸êµ¬'],
                'ê°•ë¶êµ¬': ['ë…¸ì›êµ¬', 'ë„ë´‰êµ¬', 'ì„±ë¶êµ¬', 'ì˜ì •ë¶€ì‹œ'],
                'ë…¸ì›êµ¬': ['ë„ë´‰êµ¬', 'ê°•ë¶êµ¬', 'ì„±ë¶êµ¬', 'ì¤‘ë‘êµ¬', 'ì˜ì •ë¶€ì‹œ', 'ë‚¨ì–‘ì£¼ì‹œ'],
                'ë„ë´‰êµ¬': ['ë…¸ì›êµ¬', 'ê°•ë¶êµ¬', 'ì˜ì •ë¶€ì‹œ', 'ì–‘ì£¼ì‹œ'],
                'ì¤‘ë‘êµ¬': ['ë…¸ì›êµ¬', 'ë™ëŒ€ë¬¸êµ¬', 'ê´‘ì§„êµ¬', 'êµ¬ë¦¬ì‹œ', 'ë‚¨ì–‘ì£¼ì‹œ'],
                'ì€í‰êµ¬': ['ì„œëŒ€ë¬¸êµ¬', 'ë§ˆí¬êµ¬', 'ì¢…ë¡œêµ¬', 'ê³ ì–‘ì‹œ'],
                'ë™ì‘êµ¬': ['ì„œì´ˆêµ¬', 'ê´€ì•…êµ¬', 'ì˜ë“±í¬êµ¬', 'ìš©ì‚°êµ¬'],
                'ê´€ì•…êµ¬': ['ì„œì´ˆêµ¬', 'ë™ì‘êµ¬', 'ê¸ˆì²œêµ¬', 'ê³¼ì²œì‹œ', 'ì•ˆì–‘ì‹œ'],
                'ì˜ë“±í¬êµ¬': ['ë™ì‘êµ¬', 'ì–‘ì²œêµ¬', 'ê°•ì„œêµ¬', 'êµ¬ë¡œêµ¬', 'ê´‘ëª…ì‹œ'],
                'ì–‘ì²œêµ¬': ['ì˜ë“±í¬êµ¬', 'ê°•ì„œêµ¬', 'êµ¬ë¡œêµ¬', 'ë¶€ì²œì‹œ'],
                'ê°•ì„œêµ¬': ['ì–‘ì²œêµ¬', 'ì˜ë“±í¬êµ¬', 'ë¶€ì²œì‹œ', 'ê¹€í¬ì‹œ', 'ê³ ì–‘ì‹œ'],
                'êµ¬ë¡œêµ¬': ['ì˜ë“±í¬êµ¬', 'ì–‘ì²œêµ¬', 'ê¸ˆì²œêµ¬', 'ê´‘ëª…ì‹œ', 'ë¶€ì²œì‹œ'],
                'ê¸ˆì²œêµ¬': ['êµ¬ë¡œêµ¬', 'ê´€ì•…êµ¬', 'ê´‘ëª…ì‹œ', 'ì•ˆì–‘ì‹œ'],
                'ì„±ë‚¨ì‹œ': ['ê°•ë‚¨êµ¬', 'ì„œì´ˆêµ¬', 'ì†¡íŒŒêµ¬', 'ë¶„ë‹¹êµ¬', 'ìˆ˜ì •êµ¬', 'ì¤‘ì›êµ¬', 'ê´‘ì£¼ì‹œ', 'í•˜ë‚¨ì‹œ', 'ìš©ì¸ì‹œ'],
                'ë¶„ë‹¹êµ¬': ['ê°•ë‚¨êµ¬', 'ì„œì´ˆêµ¬', 'ì„±ë‚¨ì‹œ', 'ìˆ˜ì •êµ¬', 'ì¤‘ì›êµ¬', 'ìš©ì¸ì‹œ', 'ê´‘ì£¼ì‹œ'],
                'ìˆ˜ì •êµ¬': ['ì„±ë‚¨ì‹œ', 'ë¶„ë‹¹êµ¬', 'ì¤‘ì›êµ¬', 'í•˜ë‚¨ì‹œ', 'ê´‘ì£¼ì‹œ'],
                'ì¤‘ì›êµ¬': ['ì„±ë‚¨ì‹œ', 'ë¶„ë‹¹êµ¬', 'ìˆ˜ì •êµ¬', 'í•˜ë‚¨ì‹œ'],
                'ìš©ì¸ì‹œ': ['ì„±ë‚¨ì‹œ', 'ë¶„ë‹¹êµ¬', 'ìˆ˜ì›ì‹œ', 'ê´‘ì£¼ì‹œ', 'ì•ˆì„±ì‹œ', 'í™”ì„±ì‹œ'],
                'ìˆ˜ì›ì‹œ': ['ìš©ì¸ì‹œ', 'í™”ì„±ì‹œ', 'ì•ˆì–‘ì‹œ', 'ì˜ì™•ì‹œ', 'ì•ˆì‚°ì‹œ', 'ì˜¤ì‚°ì‹œ'],
                'í™”ì„±ì‹œ': ['ìˆ˜ì›ì‹œ', 'ìš©ì¸ì‹œ', 'ì˜¤ì‚°ì‹œ', 'í‰íƒì‹œ', 'ì•ˆì‚°ì‹œ'],
                'ì•ˆì–‘ì‹œ': ['ê´€ì•…êµ¬', 'ê¸ˆì²œêµ¬', 'ê³¼ì²œì‹œ', 'ì˜ì™•ì‹œ', 'ìˆ˜ì›ì‹œ', 'êµ°í¬ì‹œ', 'ê´‘ëª…ì‹œ'],
                'ê³¼ì²œì‹œ': ['ì„œì´ˆêµ¬', 'ê´€ì•…êµ¬', 'ì•ˆì–‘ì‹œ', 'ì˜ì™•ì‹œ', 'ì„±ë‚¨ì‹œ'],
                'ì˜ì™•ì‹œ': ['ì•ˆì–‘ì‹œ', 'ê³¼ì²œì‹œ', 'ìˆ˜ì›ì‹œ', 'êµ°í¬ì‹œ', 'ì„±ë‚¨ì‹œ'],
                'êµ°í¬ì‹œ': ['ì•ˆì–‘ì‹œ', 'ì˜ì™•ì‹œ', 'ì•ˆì‚°ì‹œ', 'ìˆ˜ì›ì‹œ'],
                'ì•ˆì‚°ì‹œ': ['ì‹œí¥ì‹œ', 'êµ°í¬ì‹œ', 'ìˆ˜ì›ì‹œ', 'í™”ì„±ì‹œ', 'ê´‘ëª…ì‹œ'],
                'ì‹œí¥ì‹œ': ['ì•ˆì‚°ì‹œ', 'ê´‘ëª…ì‹œ', 'ë¶€ì²œì‹œ', 'ì•ˆì–‘ì‹œ', 'ì¸ì²œ'],
                'ê´‘ëª…ì‹œ': ['ì˜ë“±í¬êµ¬', 'êµ¬ë¡œêµ¬', 'ê¸ˆì²œêµ¬', 'ì•ˆì–‘ì‹œ', 'ì‹œí¥ì‹œ', 'ë¶€ì²œì‹œ'],
                'ë¶€ì²œì‹œ': ['ì–‘ì²œêµ¬', 'ê°•ì„œêµ¬', 'êµ¬ë¡œêµ¬', 'ê´‘ëª…ì‹œ', 'ì‹œí¥ì‹œ', 'ê¹€í¬ì‹œ', 'ì¸ì²œ'],
                'ê¹€í¬ì‹œ': ['ê°•ì„œêµ¬', 'ë¶€ì²œì‹œ', 'ê³ ì–‘ì‹œ', 'ì¸ì²œ', 'íŒŒì£¼ì‹œ'],
                'ê³ ì–‘ì‹œ': ['ì„œëŒ€ë¬¸êµ¬', 'ë§ˆí¬êµ¬', 'ì€í‰êµ¬', 'ê°•ì„œêµ¬', 'ê¹€í¬ì‹œ', 'íŒŒì£¼ì‹œ', 'ì–‘ì£¼ì‹œ'],
                'íŒŒì£¼ì‹œ': ['ê³ ì–‘ì‹œ', 'ê¹€í¬ì‹œ', 'ì–‘ì£¼ì‹œ', 'ì—°ì²œêµ°'],
                'ì–‘ì£¼ì‹œ': ['ë„ë´‰êµ¬', 'ì˜ì •ë¶€ì‹œ', 'ê³ ì–‘ì‹œ', 'íŒŒì£¼ì‹œ', 'ë™ë‘ì²œì‹œ', 'í¬ì²œì‹œ'],
                'ì˜ì •ë¶€ì‹œ': ['ê°•ë¶êµ¬', 'ë„ë´‰êµ¬', 'ë…¸ì›êµ¬', 'ì–‘ì£¼ì‹œ', 'ë‚¨ì–‘ì£¼ì‹œ', 'í¬ì²œì‹œ'],
                'ë‚¨ì–‘ì£¼ì‹œ': ['ë…¸ì›êµ¬', 'ì¤‘ë‘êµ¬', 'êµ¬ë¦¬ì‹œ', 'ì˜ì •ë¶€ì‹œ', 'ê°€í‰êµ°', 'í¬ì²œì‹œ'],
                'êµ¬ë¦¬ì‹œ': ['ê°•ë™êµ¬', 'ê´‘ì§„êµ¬', 'ì¤‘ë‘êµ¬', 'ë‚¨ì–‘ì£¼ì‹œ', 'í•˜ë‚¨ì‹œ'],
                'í•˜ë‚¨ì‹œ': ['ì†¡íŒŒêµ¬', 'ê°•ë™êµ¬', 'êµ¬ë¦¬ì‹œ', 'ë‚¨ì–‘ì£¼ì‹œ', 'ì„±ë‚¨ì‹œ', 'ê´‘ì£¼ì‹œ'],
                'ê´‘ì£¼ì‹œ': ['ì„±ë‚¨ì‹œ', 'í•˜ë‚¨ì‹œ', 'ìš©ì¸ì‹œ', 'ì—¬ì£¼ì‹œ', 'ì´ì²œì‹œ'],
                'ì´ì²œì‹œ': ['ê´‘ì£¼ì‹œ', 'ì—¬ì£¼ì‹œ', 'ìš©ì¸ì‹œ', 'ì•ˆì„±ì‹œ'],
                'ì—¬ì£¼ì‹œ': ['ê´‘ì£¼ì‹œ', 'ì´ì²œì‹œ', 'ì–‘í‰êµ°'],
                'ì•ˆì„±ì‹œ': ['ìš©ì¸ì‹œ', 'ì´ì²œì‹œ', 'í‰íƒì‹œ', 'ì²œì•ˆì‹œ'],
                'í‰íƒì‹œ': ['í™”ì„±ì‹œ', 'ì•ˆì„±ì‹œ', 'ì˜¤ì‚°ì‹œ', 'ì²œì•ˆì‹œ', 'ì•„ì‚°ì‹œ'],
                'ì˜¤ì‚°ì‹œ': ['ìˆ˜ì›ì‹œ', 'í™”ì„±ì‹œ', 'í‰íƒì‹œ', 'ìš©ì¸ì‹œ'],
                'ì¸ì²œ': ['ë¶€ì²œì‹œ', 'ì‹œí¥ì‹œ', 'ê¹€í¬ì‹œ'],
                'ì¸ì²œì‹œ': ['ë¶€ì²œì‹œ', 'ì‹œí¥ì‹œ', 'ê¹€í¬ì‹œ']
            };

            if (studentParts.region && hospitalParts.region) {
                if (adjacent[studentParts.region] && adjacent[studentParts.region].includes(hospitalParts.region)) {
                    score += 50;
                }
            }

            // ê°™ì€ ê¶Œì—­ ë³´ë„ˆìŠ¤
            const regions = {
                'ì„œìš¸ë¶ë¶€': ['ì¢…ë¡œêµ¬', 'ì„±ë¶êµ¬', 'ê°•ë¶êµ¬', 'ë…¸ì›êµ¬', 'ë„ë´‰êµ¬', 'ë™ëŒ€ë¬¸êµ¬', 'ì¤‘ë‘êµ¬', 'ì˜ì •ë¶€ì‹œ', 'ì–‘ì£¼ì‹œ', 'í¬ì²œì‹œ', 'ë™ë‘ì²œì‹œ', 'ì—°ì²œêµ°'],
                'ì„œìš¸ë™ë¶€': ['ê´‘ì§„êµ¬', 'ì„±ë™êµ¬', 'ì¤‘êµ¬', 'êµ¬ë¦¬ì‹œ', 'ë‚¨ì–‘ì£¼ì‹œ', 'í•˜ë‚¨ì‹œ', 'ê°€í‰êµ°'],
                'ì„œìš¸ì„œë¶€': ['ì„œëŒ€ë¬¸êµ¬', 'ë§ˆí¬êµ¬', 'ì€í‰êµ¬', 'ê³ ì–‘ì‹œ', 'íŒŒì£¼ì‹œ', 'ê¹€í¬ì‹œ'],
                'ì„œìš¸ë‚¨ì„œ': ['ì˜ë“±í¬êµ¬', 'ì–‘ì²œêµ¬', 'ê°•ì„œêµ¬', 'êµ¬ë¡œêµ¬', 'ê¸ˆì²œêµ¬', 'ê´‘ëª…ì‹œ', 'ë¶€ì²œì‹œ', 'ì‹œí¥ì‹œ', 'ì¸ì²œ', 'ì¸ì²œì‹œ'],
                'ì„œìš¸ë‚¨ë¶€': ['ë™ì‘êµ¬', 'ê´€ì•…êµ¬', 'ì•ˆì–‘ì‹œ', 'ê³¼ì²œì‹œ', 'ì˜ì™•ì‹œ', 'êµ°í¬ì‹œ', 'ì•ˆì‚°ì‹œ'],
                'ê°•ë‚¨ê¶Œ': ['ê°•ë‚¨êµ¬', 'ì„œì´ˆêµ¬', 'ì†¡íŒŒêµ¬', 'ê°•ë™êµ¬', 'ì„±ë‚¨ì‹œ', 'ë¶„ë‹¹êµ¬', 'ìˆ˜ì •êµ¬', 'ì¤‘ì›êµ¬', 'í•˜ë‚¨ì‹œ', 'ê´‘ì£¼ì‹œ'],
                'ìˆ˜ì›ê¶Œ': ['ìˆ˜ì›ì‹œ', 'ìš©ì¸ì‹œ', 'í™”ì„±ì‹œ', 'ì˜¤ì‚°ì‹œ', 'í‰íƒì‹œ', 'ì•ˆì„±ì‹œ', 'ì´ì²œì‹œ', 'ì—¬ì£¼ì‹œ']
            };

            for (const [regionName, areas] of Object.entries(regions)) {
                if (areas.includes(studentParts.region) && areas.includes(hospitalParts.region)) {
                    score += 25;
                    break;
                }
            }

            score += Math.random() * 3;
            return score;
        }

        function extractAddressParts(address) {
            const parts = { region: null, dong: null };
            if (!address) return parts;

            const cityMatch = address.match(/([ê°€-í£]+[ì‹œêµ°])/);
            const guMatch = address.match(/([ê°€-í£]+êµ¬)/);
            const dongMatch = address.match(/([ê°€-í£]+[ë™ìë©´ë¦¬])/);

            if (guMatch) {
                const gu = guMatch[1];
                const seoulGu = ['ê°•ë‚¨êµ¬', 'ê°•ë™êµ¬', 'ê°•ë¶êµ¬', 'ê°•ì„œêµ¬', 'ê´€ì•…êµ¬', 'ê´‘ì§„êµ¬', 'êµ¬ë¡œêµ¬', 'ê¸ˆì²œêµ¬',
                    'ë…¸ì›êµ¬', 'ë„ë´‰êµ¬', 'ë™ëŒ€ë¬¸êµ¬', 'ë™ì‘êµ¬', 'ë§ˆí¬êµ¬', 'ì„œëŒ€ë¬¸êµ¬', 'ì„œì´ˆêµ¬', 'ì„±ë™êµ¬',
                    'ì„±ë¶êµ¬', 'ì†¡íŒŒêµ¬', 'ì–‘ì²œêµ¬', 'ì˜ë“±í¬êµ¬', 'ìš©ì‚°êµ¬', 'ì€í‰êµ¬', 'ì¢…ë¡œêµ¬', 'ì¤‘êµ¬', 'ì¤‘ë‘êµ¬'];
                const seongnamGu = ['ë¶„ë‹¹êµ¬', 'ìˆ˜ì •êµ¬', 'ì¤‘ì›êµ¬'];
                const gyeonggiGu = ['ì²˜ì¸êµ¬', 'ê¸°í¥êµ¬', 'ìˆ˜ì§€êµ¬', 'ì¥ì•ˆêµ¬', 'ê¶Œì„ êµ¬', 'íŒ”ë‹¬êµ¬', 'ì˜í†µêµ¬',
                    'ë•ì–‘êµ¬', 'ì¼ì‚°ë™êµ¬', 'ì¼ì‚°ì„œêµ¬', 'ë§Œì•ˆêµ¬', 'ë™ì•ˆêµ¬', 'ìƒë¡êµ¬', 'ë‹¨ì›êµ¬',
                    'ë¶€í‰êµ¬', 'ê³„ì–‘êµ¬', 'ë‚¨ë™êµ¬', 'ì—°ìˆ˜êµ¬', 'ë¯¸ì¶”í™€êµ¬', 'ì¤‘êµ¬', 'ë™êµ¬', 'ì„œêµ¬'];

                if (seoulGu.includes(gu)) {
                    parts.region = gu;
                } else if (seongnamGu.includes(gu) || gyeonggiGu.includes(gu)) {
                    parts.region = gu;
                } else if (cityMatch) {
                    parts.region = cityMatch[1];
                }
            } else if (cityMatch) {
                parts.region = cityMatch[1];
            }

            if (dongMatch) parts.dong = dongMatch[1];
            return parts;
        }

        // ====== ê²°ê³¼ í‘œì‹œ ======
        function showResults() {
            document.getElementById('noResultMessage').style.display = 'none';
            document.getElementById('resultContent').style.display = 'block';

            // í†µê³„ ì—…ë°ì´íŠ¸
            const total = students.length;
            const placed = placementResult.filter(r => r.status === 'ë°°ì¹˜ì™„ë£Œ').length;
            const unplaced = total - placed;
            const rate = total > 0 ? Math.round((placed / total) * 100) : 0;

            document.getElementById('statTotal').textContent = total;
            document.getElementById('statPlaced').textContent = placed;
            document.getElementById('statUnplaced').textContent = unplaced;
            document.getElementById('statRate').textContent = rate + '%';

            // í•„í„° ë²„íŠ¼ ìƒì„±
            renderFilterButtons();

            // ê²°ê³¼ í…Œì´ë¸” í—¤ë”
            renderResultTableHeader();

            // ê²°ê³¼ í…Œì´ë¸”
            filterResult('all');

            // ë³‘ì›ë³„ í˜„í™©
            showHospitalSummary();

            // ê²°ê³¼ íƒ­ìœ¼ë¡œ ì´ë™
            document.getElementById('result-tab').click();
        }

        function renderFilterButtons() {
            const container = document.getElementById('filterButtons');
            let html = '<span class="me-3 fw-bold">í•„í„°:</span>';
            html += '<button class="filter-btn active" data-filter="all" onclick="filterResult(\'all\')">ì „ì²´</button>';

            // ë¶„ë°˜ë³„ í•„í„°
            config.classGroups.forEach(g => {
                html += `<button class="filter-btn" data-filter="${g.id}" onclick="filterResult('${g.id}')"
                         style="border-color: ${g.textColor};">${g.name}</button>`;
            });

            html += '<span class="mx-2">|</span>';
            html += '<button class="filter-btn" data-filter="regular" onclick="filterResult(\'regular\')">ì •ê·œë°°ì¹˜</button>';
            html += '<button class="filter-btn" data-filter="mixed" onclick="filterResult(\'mixed\')">ì¶”ê°€ë°°ì¹˜</button>';
            html += '<span class="mx-2">|</span>';

            // ë³‘ë™ë³„ í•„í„°
            config.departments.forEach(d => {
                html += `<button class="filter-btn" data-filter="${d.id}" onclick="filterResult('${d.id}')"
                         style="border-color: ${d.textColor};">${d.name}</button>`;
            });

            html += '<span class="mx-2">|</span>';
            html += '<button class="filter-btn text-danger" data-filter="lowscore" onclick="filterResult(\'lowscore\')">ì›ê±°ë¦¬ ë°°ì¹˜</button>';

            container.innerHTML = html;
        }

        function renderResultTableHeader() {
            const thead = document.getElementById('resultTableHead');
            thead.innerHTML = `
                <tr>
                    <th>í•™ë²ˆ</th>
                    <th>ì´ë¦„</th>
                    <th>ë¶„ë°˜</th>
                    <th>ì‹¤ìŠµê¸°ê°„</th>
                    <th>ì£¼ì†Œ</th>
                    <th>ë°°ì •ë³‘ì›</th>
                    <th>ì‹¤ìŠµë³‘ë™</th>
                    <th>ìƒíƒœ</th>
                </tr>
            `;
        }

        function filterResult(filter) {
            // ë²„íŠ¼ í™œì„±í™”
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.filter === filter) btn.classList.add('active');
            });

            let filtered;
            if (filter === 'all') {
                filtered = placementResult;
            } else if (filter === 'regular') {
                filtered = placementResult.filter(r => !r.isMixed && r.status === 'ë°°ì¹˜ì™„ë£Œ');
            } else if (filter === 'mixed') {
                filtered = placementResult.filter(r => r.isMixed);
            } else if (filter === 'lowscore') {
                filtered = placementResult.filter(r => r.status === 'ë°°ì¹˜ì™„ë£Œ' && (r.score || 0) < 50);
            } else if (config.classGroups.find(g => g.id === filter)) {
                filtered = placementResult.filter(r => r.classId === filter);
            } else if (config.departments.find(d => d.id === filter)) {
                filtered = placementResult.filter(r => r.deptId === filter);
            } else {
                filtered = placementResult;
            }

            document.getElementById('resultCount').textContent = filtered.length + 'ëª…';

            const tbody = document.getElementById('resultTableBody');
            tbody.innerHTML = filtered.map(r => {
                const score = r.score || 0;
                const isLowScore = r.status === 'ë°°ì¹˜ì™„ë£Œ' && score < 50;
                const scoreClass = score >= 100 ? 'text-success' : score >= 50 ? 'text-primary' : 'text-danger';
                const scoreLabel = score >= 100 ? 'ë™ì¼ì§€ì—­' : score >= 50 ? 'ì¸ì ‘ì§€ì—­' : 'ì›ê±°ë¦¬';

                const group = config.classGroups.find(g => g.id === r.classId);
                const dept = config.departments.find(d => d.id === r.deptId);
                const classStyle = group ? `background: ${group.color}; color: ${group.textColor};` : '';
                const deptStyle = dept ? `background: ${dept.color}; color: ${dept.textColor};` : '';

                return `
                <tr class="${r.status === 'ë¯¸ë°°ì¹˜' ? 'table-danger' : isLowScore ? 'table-warning' : r.isMixed ? 'table-info' : ''}">
                    <td>${r.studentId}</td>
                    <td>${r.name}</td>
                    <td><span class="badge" style="${classStyle}">${r.className}</span></td>
                    <td><span class="badge ${r.isMixed ? 'bg-purple' : 'bg-secondary'}" style="${r.isMixed ? 'background: #8b5cf6;' : ''}">${r.period}</span></td>
                    <td>${r.address}</td>
                    <td>${r.hospital}${r.hospitalAddr ? `<br><small class="text-muted">(${r.hospitalAddr})</small>` : ''}</td>
                    <td>
                        ${r.department !== '-' ?
                            `<span class="badge" style="${deptStyle}">${r.department}</span>`
                            : '-'}
                    </td>
                    <td>
                        ${r.status === 'ë°°ì¹˜ì™„ë£Œ' ?
                            `<span class="badge ${isLowScore ? 'bg-warning text-dark' : 'bg-success'}">${r.isMixed ? 'ì¶”ê°€' : 'ì™„ë£Œ'}</span>
                             <br><small class="${scoreClass}">${scoreLabel}</small>`
                            : `<span class="badge bg-danger">ë¯¸ë°°ì¹˜</span>`
                        }
                    </td>
                </tr>
            `}).join('');
        }

        function showHospitalSummary() {
            const slots = getPlacementSlots();
            const summary = {};

            hospitals.forEach(h => {
                summary[h.name] = {};
                slots.forEach(slot => {
                    summary[h.name][slot.id] = {};
                    config.departments.forEach(dept => {
                        summary[h.name][slot.id][dept.id] = { placed: 0, total: h[`${slot.id}_${dept.id}`] || 0 };
                    });
                });
            });

            placementResult.forEach(r => {
                if (r.hospital !== '-' && summary[r.hospital] && r.slotId) {
                    if (summary[r.hospital][r.slotId] && summary[r.hospital][r.slotId][r.deptId]) {
                        summary[r.hospital][r.slotId][r.deptId].placed++;
                    }
                }
            });

            // í—¤ë” ìƒì„±
            const thead = document.getElementById('hospitalSummaryHead');
            let headerRow1 = '<th rowspan="2" class="align-middle text-center">ë³‘ì›ëª…</th>';
            let headerRow2 = '';

            slots.forEach(slot => {
                const group = config.classGroups.find(g => g.id === slot.classId);
                const style = group ? `background: ${group.color}; color: ${group.textColor};` : 'background: #ede9fe; color: #7c3aed;';
                headerRow1 += `<th colspan="${config.departments.length}" class="text-center" style="${style}">${slot.label}</th>`;

                config.departments.forEach(dept => {
                    headerRow2 += `<th class="text-center" style="font-size:0.7rem; background: ${dept.color};">${dept.name.substring(0, 2)}</th>`;
                });
            });

            headerRow1 += '<th rowspan="2" class="align-middle text-center">ì´ê³„</th>';
            thead.innerHTML = `<tr>${headerRow1}</tr><tr>${headerRow2}</tr>`;

            // ë°”ë”” ìƒì„±
            const tbody = document.getElementById('hospitalSummaryBody');
            tbody.innerHTML = Object.entries(summary).map(([name, data]) => {
                let totalPlaced = 0;
                let cells = '';

                slots.forEach(slot => {
                    config.departments.forEach(dept => {
                        const info = data[slot.id][dept.id];
                        totalPlaced += info.placed;
                        const isFull = info.placed >= info.total && info.total > 0;
                        cells += `<td class="text-center ${isFull ? 'text-success fw-bold' : ''}" style="font-size:0.8rem;">
                            ${info.total > 0 ? `${info.placed}/${info.total}` : '-'}
                        </td>`;
                    });
                });

                return `
                    <tr>
                        <td>${name}</td>
                        ${cells}
                        <td class="text-center"><strong>${totalPlaced}ëª…</strong></td>
                    </tr>
                `;
            }).join('');
        }

        // ====== ê²°ê³¼ ë‹¤ìš´ë¡œë“œ ======
        function downloadResult() {
            if (placementResult.length === 0) {
                alert('ë‹¤ìš´ë¡œë“œí•  ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const subjectName = config.subjectName || 'ì„ìƒì‹¤ìŠµ';

            const ws = XLSX.utils.json_to_sheet(placementResult.map(r => ({
                'í•™ë²ˆ': r.studentId,
                'ì´ë¦„': r.name,
                'ë¶„ë°˜': r.className,
                'ì‹¤ìŠµê¸°ê°„': r.period,
                'ë°°ì¹˜ìœ í˜•': r.isMixed ? 'ì¶”ê°€ë°°ì¹˜' : 'ì •ê·œë°°ì¹˜',
                'ì£¼ì†Œ': r.address,
                'ë°°ì •ë³‘ì›': r.hospital,
                'ì‹¤ìŠµë³‘ë™': r.department,
                'ìƒíƒœ': r.status
            })));

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'ë°°ì¹˜ê²°ê³¼');

            // ë³‘ì›ë³„ ìš”ì•½ ì‹œíŠ¸
            const slots = getPlacementSlots();
            const summaryData = [];

            hospitals.forEach(h => {
                const row = { 'ë³‘ì›ëª…': h.name };
                slots.forEach(slot => {
                    config.departments.forEach(dept => {
                        const placed = placementResult.filter(r => r.hospital === h.name && r.slotId === slot.id && r.deptId === dept.id).length;
                        row[`${slot.label}_${dept.name}`] = `${placed}/${h[`${slot.id}_${dept.id}`] || 0}`;
                    });
                });
                summaryData.push(row);
            });

            const ws2 = XLSX.utils.json_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, ws2, 'ë³‘ì›ë³„í˜„í™©');

            XLSX.writeFile(wb, `${subjectName}_ë°°ì¹˜ê²°ê³¼_${new Date().toISOString().slice(0,10)}.xlsx`);
        }
    </script>
</body>
</html>
