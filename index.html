<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìŠ¤ë§ˆíŠ¸ ì‹¤ìŠµ ë°°ì¹˜ ì‹œìŠ¤í…œ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #8b5cf6;
            --primary-dark: #7c3aed;
            --primary-light: #a78bfa;
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        * {
            font-family: 'Noto Sans KR', sans-serif;
        }

        body {
            background: #f8fafc;
            min-height: 100vh;
        }

        .header {
            background: var(--bg-gradient);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }

        .header h1 {
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .card {
            border: none;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-bottom: 1.5rem;
        }

        .card-header {
            background: white;
            border-bottom: 1px solid #e2e8f0;
            border-radius: 16px 16px 0 0 !important;
            font-weight: 600;
            padding: 1rem 1.5rem;
        }

        .btn-primary {
            background: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            border-color: var(--primary-dark);
        }

        .upload-zone {
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            padding: 3rem 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8fafc;
        }

        .upload-zone:hover, .upload-zone.dragover {
            border-color: var(--primary-color);
            background: #faf5ff;
        }

        .hospital-table {
            font-size: 0.8rem;
        }

        .hospital-table input[type="text"] {
            width: 100%;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 0.4rem 0.6rem;
            font-size: 0.85rem;
        }

        .hospital-table input[type="number"] {
            width: 45px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            padding: 0.25rem;
            text-align: center;
            font-size: 0.8rem;
        }

        .hospital-table input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.1);
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .stat-card .number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .stat-card .label {
            color: #64748b;
            font-size: 0.9rem;
        }

        .result-table {
            font-size: 0.85rem;
        }

        .badge-class-A { background: #3b82f6; }
        .badge-class-B { background: #10b981; }
        .badge-class-C { background: #f59e0b; }

        .period-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }

        .period-mixed {
            background: #8b5cf6 !important;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            display: none;
        }

        .loading-overlay.show {
            display: flex;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e2e8f0;
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .nav-tabs .nav-link {
            color: #64748b;
            border: none;
            padding: 1rem 1.5rem;
            font-weight: 500;
        }

        .nav-tabs .nav-link.active {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
            background: transparent;
        }

        .schedule-info {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
        }

        .schedule-item {
            display: inline-flex;
            align-items: center;
            padding: 0.4rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            margin: 0.25rem;
            font-size: 0.9rem;
        }

        .dept-nicu {
            background: #fee2e2;
            color: #dc2626;
        }

        .dept-peds {
            background: #dbeafe;
            color: #2563eb;
        }

        .filter-btn {
            border: 1px solid #e2e8f0;
            background: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
            transition: all 0.2s;
        }

        .filter-btn:hover, .filter-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .class-header {
            text-align: center;
            font-weight: 600;
            font-size: 0.75rem;
            padding: 0.5rem !important;
        }

        .class-header-C { background: #fef3c7 !important; }
        .class-header-A { background: #dbeafe !important; }
        .class-header-B { background: #d1fae5 !important; }
        .class-header-mixed { background: #ede9fe !important; }

        .dept-sub-header {
            font-size: 0.65rem;
            text-align: center;
            padding: 0.25rem !important;
        }

        .nicu-col { background: #fff5f5 !important; }
        .peds-col { background: #f0f9ff !important; }

        .to-cell {
            padding: 0.25rem !important;
            text-align: center;
        }

        .hospital-name-cell {
            min-width: 120px;
        }

        .hospital-addr-cell {
            min-width: 100px;
        }

        .table-scroll-wrapper {
            overflow-x: auto;
            max-width: 100%;
        }

        .capacity-summary {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .capacity-box {
            background: white;
            border-radius: 8px;
            padding: 0.75rem;
            text-align: center;
            border: 1px solid #e2e8f0;
        }

        .capacity-box.class-C { border-left: 4px solid #f59e0b; }
        .capacity-box.class-A { border-left: 4px solid #3b82f6; }
        .capacity-box.class-B { border-left: 4px solid #10b981; }
        .capacity-box.class-mixed { border-left: 4px solid #8b5cf6; }

        .capacity-box .class-name {
            font-weight: 600;
            font-size: 0.85rem;
            margin-bottom: 0.25rem;
        }

        .capacity-box .capacity-detail {
            font-size: 0.75rem;
            color: #64748b;
        }

        .capacity-box .capacity-total {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .order-select-group {
            text-align: center;
        }

        .order-select-group label {
            display: block;
            margin-bottom: 0.25rem;
            font-size: 0.75rem;
        }

        .order-select {
            width: 80px;
            font-weight: 600;
            text-align: center;
        }

        .order-arrow {
            font-size: 1.2rem;
            color: #64748b;
            margin: 0 0.25rem;
            padding-top: 1rem;
        }

        .fixed-slot {
            width: 80px;
            padding: 0.375rem 0.75rem;
            background: #ede9fe;
            color: #7c3aed;
            border-radius: 6px;
            font-weight: 600;
            text-align: center;
            font-size: 0.875rem;
        }

        .order-warning {
            color: #dc2626;
            font-size: 0.8rem;
            margin-top: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="text-center">
            <div class="spinner mx-auto mb-3"></div>
            <p class="text-muted">ë°°ì¹˜ ì²˜ë¦¬ ì¤‘...</p>
        </div>
    </div>

    <header class="header">
        <div class="container">
            <h1>ğŸ¥ ìŠ¤ë§ˆíŠ¸ ì‹¤ìŠµ ë°°ì¹˜ ì‹œìŠ¤í…œ</h1>
            <p class="mb-0 opacity-75">ê³µì •í•˜ê³  íš¨ìœ¨ì ì¸ ì‹¤ìŠµ ë³‘ì› ë°°ì •</p>
        </div>
    </header>

    <div class="container pb-5">
        <!-- 8ì£¼ ìŠ¤ì¼€ì¤„ ì•ˆë‚´ -->
        <div class="schedule-info">
            <h6 class="mb-3"><strong>ğŸ“… 8ì£¼ ì‹¤ìŠµ ìŠ¤ì¼€ì¤„ (ê° ë°˜ 2ì£¼ì”© ì‹¤ìŠµ)</strong></h6>

            <!-- ë°˜ ìˆœì„œ ì„¤ì • -->
            <div class="row justify-content-center mb-3">
                <div class="col-auto">
                    <div class="d-flex align-items-center flex-wrap gap-2">
                        <div class="order-select-group">
                            <label class="small text-muted">1-2ì£¼ì°¨</label>
                            <select class="form-select form-select-sm order-select" id="order1" onchange="updateClassOrder()">
                                <option value="C">Cë°˜</option>
                                <option value="A">Aë°˜</option>
                                <option value="B">Bë°˜</option>
                            </select>
                        </div>
                        <span class="order-arrow">â†’</span>
                        <div class="order-select-group">
                            <label class="small text-muted">3-4ì£¼ì°¨</label>
                            <select class="form-select form-select-sm order-select" id="order2" onchange="updateClassOrder()">
                                <option value="A">Aë°˜</option>
                                <option value="C">Cë°˜</option>
                                <option value="B">Bë°˜</option>
                            </select>
                        </div>
                        <span class="order-arrow">â†’</span>
                        <div class="order-select-group">
                            <label class="small text-muted">5-6ì£¼ì°¨</label>
                            <select class="form-select form-select-sm order-select" id="order3" onchange="updateClassOrder()">
                                <option value="B">Bë°˜</option>
                                <option value="C">Cë°˜</option>
                                <option value="A">Aë°˜</option>
                            </select>
                        </div>
                        <span class="order-arrow">â†’</span>
                        <div class="order-select-group">
                            <label class="small text-muted">7-8ì£¼ì°¨</label>
                            <div class="fixed-slot">í˜¼í•©</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ë™ì  ìŠ¤ì¼€ì¤„ í‘œì‹œ -->
            <div class="d-flex align-items-center justify-content-center flex-wrap" id="scheduleDisplay">
            </div>

            <p class="text-muted small mt-2 mb-0 text-center">
                ê° í•™ìƒì€ <strong>2ì£¼ê°„</strong> ë°°ì •ëœ ë³‘ì›ì˜
                <span class="badge dept-nicu">ì‹ ìƒì•„ì‹¤</span> ë˜ëŠ”
                <span class="badge dept-peds">ì†Œì•„ê³¼</span> ì¤‘ <strong>í•œ ê³³</strong>ì—ì„œ ì‹¤ìŠµí•©ë‹ˆë‹¤.
                <br>ì •ê·œ ê¸°ê°„ì— ë°°ì¹˜ë˜ì§€ ëª»í•œ í•™ìƒì€ 7-8ì£¼ì°¨ì— í˜¼í•© ë°°ì¹˜ë©ë‹ˆë‹¤.
            </p>
        </div>

        <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
        <ul class="nav nav-tabs mb-4" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="hospital-tab" data-bs-toggle="tab" data-bs-target="#hospital-panel" type="button">
                    1ï¸âƒ£ ë³‘ì› í‹°ì˜¤ ì„¤ì •
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload-panel" type="button">
                    2ï¸âƒ£ í•™ìƒ ì—…ë¡œë“œ
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="result-tab" data-bs-toggle="tab" data-bs-target="#result-panel" type="button">
                    3ï¸âƒ£ ë°°ì¹˜ ê²°ê³¼
                </button>
            </li>
        </ul>

        <div class="tab-content" id="mainTabContent">
            <!-- ë³‘ì› ì„¤ì • íƒ­ -->
            <div class="tab-pane fade show active" id="hospital-panel" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>ğŸ¥ ì‹¤ìŠµ ë³‘ì› ë° ë°˜ë³„ í‹°ì˜¤ ì„¤ì •</span>
                        <button class="btn btn-sm btn-outline-primary" onclick="addHospitalRow()">
                            + ë³‘ì› ì¶”ê°€
                        </button>
                    </div>
                    <div class="card-body">
                        <p class="text-muted small mb-3">
                            ğŸ’¡ ê° ë³‘ì›ì˜ <strong>ë°˜ë³„ Â· ë¶€ì„œë³„</strong> ì •ì›(í‹°ì˜¤)ì„ ì…ë ¥í•˜ì„¸ìš”. <strong>7-8ì£¼ì°¨</strong>ëŠ” ì •ê·œ ê¸°ê°„ì— ë°°ì¹˜ë˜ì§€ ëª»í•œ í•™ìƒë“¤ì„ ìœ„í•œ ì¶”ê°€ í‹°ì˜¤ì…ë‹ˆë‹¤.
                        </p>
                        <div class="table-scroll-wrapper">
                            <table class="table table-bordered hospital-table mb-0" id="hospitalTable">
                                <thead>
                                    <tr>
                                        <th rowspan="2" class="align-middle text-center" style="min-width:120px;">ë³‘ì›ëª…</th>
                                        <th rowspan="2" class="align-middle text-center" style="min-width:100px;">ì£¼ì†Œ(êµ¬)</th>
                                        <th colspan="2" class="class-header class-header-C">Cë°˜ (1-2ì£¼)</th>
                                        <th colspan="2" class="class-header class-header-A">Aë°˜ (3-4ì£¼)</th>
                                        <th colspan="2" class="class-header class-header-B">Bë°˜ (5-6ì£¼)</th>
                                        <th colspan="2" class="class-header class-header-mixed">7-8ì£¼ (í˜¼í•©)</th>
                                        <th rowspan="2" class="align-middle text-center" style="width:40px;"></th>
                                    </tr>
                                    <tr>
                                        <th class="dept-sub-header nicu-col">ì‹ ìƒ</th>
                                        <th class="dept-sub-header peds-col">ì†Œì•„</th>
                                        <th class="dept-sub-header nicu-col">ì‹ ìƒ</th>
                                        <th class="dept-sub-header peds-col">ì†Œì•„</th>
                                        <th class="dept-sub-header nicu-col">ì‹ ìƒ</th>
                                        <th class="dept-sub-header peds-col">ì†Œì•„</th>
                                        <th class="dept-sub-header nicu-col">ì‹ ìƒ</th>
                                        <th class="dept-sub-header peds-col">ì†Œì•„</th>
                                    </tr>
                                </thead>
                                <tbody id="hospitalTableBody">
                                </tbody>
                            </table>
                        </div>

                        <!-- ë°˜ë³„ ì •ì› ìš”ì•½ -->
                        <div class="capacity-summary" id="capacitySummary">
                        </div>

                        <div class="text-end mt-3">
                            <button class="btn btn-outline-secondary me-2" onclick="resetHospitals()">ì´ˆê¸°í™”</button>
                            <button class="btn btn-primary" onclick="saveHospitals()">ğŸ’¾ ë³‘ì› ì„¤ì • ì €ì¥</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- í•™ìƒ ì—…ë¡œë“œ íƒ­ -->
            <div class="tab-pane fade" id="upload-panel" role="tabpanel">
                <div class="card">
                    <div class="card-header">ğŸ“„ í•™ìƒ ëª…ë‹¨ ì—…ë¡œë“œ</div>
                    <div class="card-body">
                        <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
                            <div class="mb-3">
                                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#a78bfa" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="17 8 12 3 7 8"></polyline>
                                    <line x1="12" y1="3" x2="12" y2="15"></line>
                                </svg>
                            </div>
                            <h5>ì—‘ì…€ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ</h5>
                            <p class="text-muted mb-0">ì§€ì› í˜•ì‹: .xlsx, .xls, .csv</p>
                        </div>
                        <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" style="display: none;" onchange="handleFileUpload(event)">

                        <div class="alert alert-info mt-4">
                            <h6 class="alert-heading">ğŸ“‹ í•„ìˆ˜ ì»¬ëŸ¼</h6>
                            <ul class="mb-0">
                                <li><strong>í•™ë²ˆ</strong> - í•™ìƒ í•™ë²ˆ</li>
                                <li><strong>ì´ë¦„</strong> - í•™ìƒ ì´ë¦„</li>
                                <li><strong>ë°˜</strong> - A, B, C ì¤‘ í•˜ë‚˜</li>
                                <li><strong>ì£¼ì†Œ</strong> - ê±°ì£¼ì§€ ì£¼ì†Œ (êµ¬/ë™ í¬í•¨)</li>
                            </ul>
                        </div>

                        <div id="uploadPreview" style="display: none;">
                            <h5 class="mt-4 mb-3">ğŸ“Š ì—…ë¡œë“œëœ í•™ìƒ ëª…ë‹¨</h5>

                            <!-- ë°˜ë³„ í•™ìƒ ìˆ˜ ìš”ì•½ -->
                            <div class="row mb-3" id="classSummary"></div>

                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                <table class="table table-sm table-bordered" id="previewTable">
                                    <thead class="table-light" style="position: sticky; top: 0;">
                                        <tr>
                                            <th>#</th>
                                            <th>í•™ë²ˆ</th>
                                            <th>ì´ë¦„</th>
                                            <th>ë°˜</th>
                                            <th>ì£¼ì†Œ</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                            <div class="text-end mt-3">
                                <button class="btn btn-lg btn-primary" onclick="runPlacement()">
                                    ğŸš€ ë°°ì¹˜ ì‹œì‘í•˜ê¸°
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ë°°ì¹˜ ê²°ê³¼ íƒ­ -->
            <div class="tab-pane fade" id="result-panel" role="tabpanel">
                <div id="resultContent" style="display: none;">
                    <!-- í†µê³„ ì¹´ë“œ -->
                    <div class="row mb-4" id="statsRow">
                        <div class="col-md-3 col-6 mb-3">
                            <div class="stat-card">
                                <div class="number" id="statTotal">0</div>
                                <div class="label">ì „ì²´ í•™ìƒ</div>
                            </div>
                        </div>
                        <div class="col-md-3 col-6 mb-3">
                            <div class="stat-card">
                                <div class="number text-success" id="statPlaced">0</div>
                                <div class="label">ë°°ì¹˜ ì™„ë£Œ</div>
                            </div>
                        </div>
                        <div class="col-md-3 col-6 mb-3">
                            <div class="stat-card">
                                <div class="number text-danger" id="statUnplaced">0</div>
                                <div class="label">ë¯¸ë°°ì¹˜</div>
                            </div>
                        </div>
                        <div class="col-md-3 col-6 mb-3">
                            <div class="stat-card">
                                <div class="number text-info" id="statRate">0%</div>
                                <div class="label">ë°°ì¹˜ìœ¨</div>
                            </div>
                        </div>
                    </div>

                    <!-- í•„í„° -->
                    <div class="card mb-3">
                        <div class="card-body py-3">
                            <div class="d-flex flex-wrap align-items-center">
                                <span class="me-3 fw-bold">í•„í„°:</span>
                                <button class="filter-btn active" data-filter="all" onclick="filterResult('all')">ì „ì²´</button>
                                <button class="filter-btn" data-filter="C" onclick="filterResult('C')">Cë°˜</button>
                                <button class="filter-btn" data-filter="A" onclick="filterResult('A')">Aë°˜</button>
                                <button class="filter-btn" data-filter="B" onclick="filterResult('B')">Bë°˜</button>
                                <span class="mx-2">|</span>
                                <button class="filter-btn" data-filter="regular" onclick="filterResult('regular')">ì •ê·œë°°ì¹˜</button>
                                <button class="filter-btn" data-filter="mixed" onclick="filterResult('mixed')">7-8ì£¼ í˜¼í•©</button>
                                <span class="mx-2">|</span>
                                <button class="filter-btn" data-filter="nicu" onclick="filterResult('nicu')">ğŸ¼ ì‹ ìƒì•„ì‹¤</button>
                                <button class="filter-btn" data-filter="peds" onclick="filterResult('peds')">ğŸ‘¶ ì†Œì•„ê³¼</button>
                            </div>
                        </div>
                    </div>

                    <!-- ê²°ê³¼ í…Œì´ë¸” -->
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span>ğŸ“‹ ë°°ì¹˜ ê²°ê³¼ <span class="badge bg-secondary" id="resultCount">0ëª…</span></span>
                            <button class="btn btn-sm btn-success" onclick="downloadResult()">
                                ğŸ“¥ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover result-table" id="resultTable">
                                    <thead class="table-light">
                                        <tr>
                                            <th>í•™ë²ˆ</th>
                                            <th>ì´ë¦„</th>
                                            <th>ë°˜</th>
                                            <th>ì‹¤ìŠµê¸°ê°„</th>
                                            <th>ì£¼ì†Œ</th>
                                            <th>ë°°ì •ë³‘ì›</th>
                                            <th>ì‹¤ìŠµë¶€ì„œ</th>
                                            <th>ìƒíƒœ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="resultTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- ë³‘ì›ë³„ í˜„í™© -->
                    <div class="card mt-4">
                        <div class="card-header">ğŸ¥ ë³‘ì›ë³„ ë°°ì¹˜ í˜„í™©</div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm table-bordered" id="hospitalSummaryTable">
                                    <thead class="table-light">
                                        <tr>
                                            <th rowspan="2" class="align-middle text-center">ë³‘ì›ëª…</th>
                                            <th colspan="2" class="text-center class-header-C">Cë°˜ (1-2ì£¼)</th>
                                            <th colspan="2" class="text-center class-header-A">Aë°˜ (3-4ì£¼)</th>
                                            <th colspan="2" class="text-center class-header-B">Bë°˜ (5-6ì£¼)</th>
                                            <th colspan="2" class="text-center class-header-mixed">7-8ì£¼ (í˜¼í•©)</th>
                                            <th rowspan="2" class="align-middle text-center">ì´ê³„</th>
                                        </tr>
                                        <tr>
                                            <th class="text-center" style="font-size:0.7rem;">ì‹ ìƒ</th>
                                            <th class="text-center" style="font-size:0.7rem;">ì†Œì•„</th>
                                            <th class="text-center" style="font-size:0.7rem;">ì‹ ìƒ</th>
                                            <th class="text-center" style="font-size:0.7rem;">ì†Œì•„</th>
                                            <th class="text-center" style="font-size:0.7rem;">ì‹ ìƒ</th>
                                            <th class="text-center" style="font-size:0.7rem;">ì†Œì•„</th>
                                            <th class="text-center" style="font-size:0.7rem;">ì‹ ìƒ</th>
                                            <th class="text-center" style="font-size:0.7rem;">ì†Œì•„</th>
                                        </tr>
                                    </thead>
                                    <tbody id="hospitalSummaryBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="noResultMessage" class="text-center py-5 text-muted">
                    <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M12 6v6l4 2"></path>
                    </svg>
                    <h5 class="mt-3">ì•„ì§ ë°°ì¹˜ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</h5>
                    <p>í•™ìƒ ëª…ë‹¨ì„ ì—…ë¡œë“œí•˜ê³  ë°°ì¹˜ë¥¼ ì‹œì‘í•˜ì„¸ìš”.</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ====== ì „ì—­ ë³€ìˆ˜ ======
        let hospitals = [];
        let students = [];
        let placementResult = [];

        // ë°˜ ëª©ë¡ (í•™ìƒ ì†Œì†)
        const STUDENT_CLASSES = ['C', 'A', 'B'];

        // ë°˜ ìˆœì„œ ì„¤ì • (ì‚¬ìš©ì ì§€ì • ê°€ëŠ¥)
        let classOrder = ['C', 'A', 'B']; // ê¸°ë³¸ê°’: C â†’ A â†’ B â†’ í˜¼í•©

        // ë°˜ë³„ ìŠ¤íƒ€ì¼
        const CLASS_STYLES = {
            'C': { bg: '#fef3c7', color: '#b45309', headerClass: 'class-header-C' },
            'A': { bg: '#dbeafe', color: '#1d4ed8', headerClass: 'class-header-A' },
            'B': { bg: '#d1fae5', color: '#059669', headerClass: 'class-header-B' }
        };

        // ë™ì ìœ¼ë¡œ ê³„ì‚°ë˜ëŠ” ê°’ë“¤
        function getPlacementSlots() {
            return [...classOrder, 'mixed'];
        }

        function getClassPeriods() {
            const periods = {};
            classOrder.forEach((cls, idx) => {
                const weekStart = idx * 2 + 1;
                const weekEnd = weekStart + 1;
                periods[cls] = `${weekStart}-${weekEnd}ì£¼ì°¨`;
            });
            return periods;
        }

        // ====== ì´ˆê¸°í™” ======
        document.addEventListener('DOMContentLoaded', function() {
            loadClassOrder();
            loadHospitals();
            initDragDrop();
            updateScheduleDisplay();
        });

        // ====== ë°˜ ìˆœì„œ ê´€ë¦¬ ======
        function loadClassOrder() {
            const saved = localStorage.getItem('classOrder');
            if (saved) {
                classOrder = JSON.parse(saved);
                // ë“œë¡­ë‹¤ìš´ ê°’ ì„¤ì •
                document.getElementById('order1').value = classOrder[0];
                document.getElementById('order2').value = classOrder[1];
                document.getElementById('order3').value = classOrder[2];
            }
        }

        function updateClassOrder() {
            const order1 = document.getElementById('order1').value;
            const order2 = document.getElementById('order2').value;
            const order3 = document.getElementById('order3').value;

            // ì¤‘ë³µ ì²´í¬
            const orders = [order1, order2, order3];
            const unique = new Set(orders);

            if (unique.size !== 3) {
                // ì¤‘ë³µì´ ìˆìœ¼ë©´ ê²½ê³  í‘œì‹œ
                showOrderWarning('ê° ì£¼ì°¨ì— ì„œë¡œ ë‹¤ë¥¸ ë°˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            hideOrderWarning();
            classOrder = orders;
            localStorage.setItem('classOrder', JSON.stringify(classOrder));

            // UI ì—…ë°ì´íŠ¸
            updateScheduleDisplay();
            renderHospitalTable();
            updateCapacitySummary();
        }

        function showOrderWarning(msg) {
            let warning = document.getElementById('orderWarning');
            if (!warning) {
                warning = document.createElement('div');
                warning.id = 'orderWarning';
                warning.className = 'order-warning text-center';
                document.getElementById('scheduleDisplay').after(warning);
            }
            warning.textContent = 'âš ï¸ ' + msg;
            warning.style.display = 'block';
        }

        function hideOrderWarning() {
            const warning = document.getElementById('orderWarning');
            if (warning) warning.style.display = 'none';
        }

        function updateScheduleDisplay() {
            const container = document.getElementById('scheduleDisplay');
            const periods = getClassPeriods();

            let html = '';
            classOrder.forEach((cls, idx) => {
                const style = CLASS_STYLES[cls];
                const weekStart = idx * 2 + 1;
                const weekEnd = weekStart + 1;

                if (idx > 0) html += '<span class="mx-1">â†’</span>';
                html += `<span class="schedule-item" style="background: ${style.bg}; color: ${style.color};">
                    ${weekStart}-${weekEnd}ì£¼: ${cls}ë°˜
                </span>`;
            });

            html += '<span class="mx-1">â†’</span>';
            html += `<span class="schedule-item" style="background: #ede9fe; color: #7c3aed;">
                7-8ì£¼: ë¯¸ë°°ì¹˜ í•™ìƒ
            </span>`;

            container.innerHTML = html;
        }

        // ====== ë³‘ì› ê´€ë¦¬ ======
        const defaultHospitals = [
            {
                name: 'ì„œìš¸ëŒ€ë³‘ì›',
                address: 'ì¢…ë¡œêµ¬',
                C_nicu: 2, C_peds: 2,
                A_nicu: 2, A_peds: 2,
                B_nicu: 2, B_peds: 2,
                mixed_nicu: 1, mixed_peds: 1
            },
            {
                name: 'ì„¸ë¸Œë€ìŠ¤ë³‘ì›',
                address: 'ì„œëŒ€ë¬¸êµ¬',
                C_nicu: 2, C_peds: 2,
                A_nicu: 2, A_peds: 2,
                B_nicu: 2, B_peds: 2,
                mixed_nicu: 1, mixed_peds: 1
            },
            {
                name: 'ì‚¼ì„±ì„œìš¸ë³‘ì›',
                address: 'ê°•ë‚¨êµ¬',
                C_nicu: 2, C_peds: 2,
                A_nicu: 2, A_peds: 2,
                B_nicu: 2, B_peds: 2,
                mixed_nicu: 1, mixed_peds: 1
            },
            {
                name: 'ì„œìš¸ì•„ì‚°ë³‘ì›',
                address: 'ì†¡íŒŒêµ¬',
                C_nicu: 2, C_peds: 2,
                A_nicu: 2, A_peds: 2,
                B_nicu: 2, B_peds: 2,
                mixed_nicu: 1, mixed_peds: 1
            },
            {
                name: 'ê³ ë ¤ëŒ€ì•ˆì•”ë³‘ì›',
                address: 'ì„±ë¶êµ¬',
                C_nicu: 1, C_peds: 1,
                A_nicu: 2, A_peds: 2,
                B_nicu: 0, B_peds: 2,
                mixed_nicu: 1, mixed_peds: 1
            }
        ];

        function loadHospitals() {
            const saved = localStorage.getItem('hospitals_v4');
            hospitals = saved ? JSON.parse(saved) : JSON.parse(JSON.stringify(defaultHospitals));
            renderHospitalTable();
            updateCapacitySummary();
        }

        function renderHospitalTable() {
            // í…Œì´ë¸” í—¤ë”ë„ ë™ì ìœ¼ë¡œ ì—…ë°ì´íŠ¸
            updateTableHeaders();

            const tbody = document.getElementById('hospitalTableBody');
            const slots = getPlacementSlots();

            tbody.innerHTML = hospitals.map((h, idx) => {
                let cellsHtml = `
                    <td class="hospital-name-cell">
                        <input type="text" value="${h.name}" onchange="updateHospital(${idx}, 'name', this.value)" placeholder="ë³‘ì›ëª…">
                    </td>
                    <td class="hospital-addr-cell">
                        <input type="text" value="${h.address}" onchange="updateHospital(${idx}, 'address', this.value)" placeholder="êµ¬">
                    </td>
                `;

                // ìˆœì„œì— ë”°ë¼ ì…€ ìƒì„±
                slots.forEach(slot => {
                    cellsHtml += `
                        <td class="to-cell nicu-col"><input type="number" min="0" value="${h[`${slot}_nicu`] || 0}" onchange="updateHospital(${idx}, '${slot}_nicu', this.value)"></td>
                        <td class="to-cell peds-col"><input type="number" min="0" value="${h[`${slot}_peds`] || 0}" onchange="updateHospital(${idx}, '${slot}_peds', this.value)"></td>
                    `;
                });

                cellsHtml += `<td><button class="btn btn-sm btn-outline-danger" onclick="removeHospital(${idx})">âœ•</button></td>`;

                return `<tr>${cellsHtml}</tr>`;
            }).join('');
        }

        function updateTableHeaders() {
            const thead = document.querySelector('#hospitalTable thead');
            const slots = getPlacementSlots();

            // ì²« ë²ˆì§¸ í–‰ (ë°˜ í—¤ë”)
            let headerRow1 = `
                <th rowspan="2" class="align-middle text-center" style="min-width:120px;">ë³‘ì›ëª…</th>
                <th rowspan="2" class="align-middle text-center" style="min-width:100px;">ì£¼ì†Œ(êµ¬)</th>
            `;

            slots.forEach((slot, idx) => {
                if (slot === 'mixed') {
                    headerRow1 += `<th colspan="2" class="class-header class-header-mixed">7-8ì£¼ (í˜¼í•©)</th>`;
                } else {
                    const weekStart = idx * 2 + 1;
                    const weekEnd = weekStart + 1;
                    headerRow1 += `<th colspan="2" class="class-header class-header-${slot}">${slot}ë°˜ (${weekStart}-${weekEnd}ì£¼)</th>`;
                }
            });

            headerRow1 += `<th rowspan="2" class="align-middle text-center" style="width:40px;"></th>`;

            // ë‘ ë²ˆì§¸ í–‰ (ì‹ ìƒ/ì†Œì•„)
            let headerRow2 = '';
            slots.forEach(() => {
                headerRow2 += `
                    <th class="dept-sub-header nicu-col">ì‹ ìƒ</th>
                    <th class="dept-sub-header peds-col">ì†Œì•„</th>
                `;
            });

            thead.innerHTML = `<tr>${headerRow1}</tr><tr>${headerRow2}</tr>`;
        }

        function updateHospital(idx, field, value) {
            if (field === 'name' || field === 'address') {
                hospitals[idx][field] = value;
            } else {
                hospitals[idx][field] = parseInt(value) || 0;
            }
            updateCapacitySummary();
        }

        function updateCapacitySummary() {
            const slots = getPlacementSlots();
            const summary = {};
            slots.forEach(slot => {
                summary[slot] = { nicu: 0, peds: 0, total: 0 };
            });

            hospitals.forEach(h => {
                slots.forEach(slot => {
                    const nicu = h[`${slot}_nicu`] || 0;
                    const peds = h[`${slot}_peds`] || 0;
                    summary[slot].nicu += nicu;
                    summary[slot].peds += peds;
                    summary[slot].total += nicu + peds;
                });
            });

            // ë™ì  ë¼ë²¨ ìƒì„±
            const slotLabels = {};
            classOrder.forEach((cls, idx) => {
                const weekStart = idx * 2 + 1;
                const weekEnd = weekStart + 1;
                slotLabels[cls] = `${cls}ë°˜ (${weekStart}-${weekEnd}ì£¼)`;
            });
            slotLabels['mixed'] = '7-8ì£¼ (í˜¼í•©)';

            const container = document.getElementById('capacitySummary');
            container.innerHTML = slots.map(slot => {
                return `
                    <div class="capacity-box class-${slot}">
                        <div class="class-name">${slotLabels[slot]}</div>
                        <div class="capacity-total">${summary[slot].total}ëª…</div>
                        <div class="capacity-detail">
                            ì‹ ìƒì•„ì‹¤ ${summary[slot].nicu} / ì†Œì•„ê³¼ ${summary[slot].peds}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function addHospitalRow() {
            hospitals.push({
                name: '',
                address: '',
                C_nicu: 0, C_peds: 0,
                A_nicu: 0, A_peds: 0,
                B_nicu: 0, B_peds: 0,
                mixed_nicu: 0, mixed_peds: 0
            });
            renderHospitalTable();
            updateCapacitySummary();
        }

        function removeHospital(idx) {
            hospitals.splice(idx, 1);
            renderHospitalTable();
            updateCapacitySummary();
        }

        function saveHospitals() {
            localStorage.setItem('hospitals_v4', JSON.stringify(hospitals));
            alert('ë³‘ì› ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }

        function resetHospitals() {
            if (confirm('ë³‘ì› ì„¤ì •ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                hospitals = JSON.parse(JSON.stringify(defaultHospitals));
                renderHospitalTable();
                updateCapacitySummary();
                localStorage.removeItem('hospitals_v4');
            }
        }

        // ====== íŒŒì¼ ì—…ë¡œë“œ ======
        function initDragDrop() {
            const zone = document.getElementById('uploadZone');

            zone.addEventListener('dragover', (e) => {
                e.preventDefault();
                zone.classList.add('dragover');
            });

            zone.addEventListener('dragleave', () => {
                zone.classList.remove('dragover');
            });

            zone.addEventListener('drop', (e) => {
                e.preventDefault();
                zone.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                if (file) processFile(file);
            });
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) processFile(file);
        }

        function processFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(sheet);

                    // ì»¬ëŸ¼ëª… ì •ê·œí™”
                    students = json.map(row => {
                        const normalized = {};
                        for (let key in row) {
                            const lowerKey = key.toLowerCase().trim();
                            if (lowerKey.includes('í•™ë²ˆ') || lowerKey === 'id' || lowerKey === 'studentid' || lowerKey === 'student_id') {
                                normalized.studentId = String(row[key]).trim();
                            } else if (lowerKey.includes('ì´ë¦„') || lowerKey === 'name') {
                                normalized.name = String(row[key]).trim();
                            } else if (lowerKey.includes('ë°˜') || lowerKey === 'class') {
                                let classVal = String(row[key]).toUpperCase().replace('ë°˜', '').trim();
                                normalized.class = classVal;
                            } else if (lowerKey.includes('ì£¼ì†Œ') || lowerKey === 'address') {
                                normalized.address = String(row[key]).trim();
                            }
                        }
                        return normalized;
                    }).filter(s => s.studentId && s.name && s.class && s.address && STUDENT_CLASSES.includes(s.class));

                    if (students.length === 0) {
                        alert('ì˜¬ë°”ë¥¸ í˜•ì‹ì˜ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\ní•„ìˆ˜ ì»¬ëŸ¼: í•™ë²ˆ, ì´ë¦„, ë°˜(A/B/C), ì£¼ì†Œ');
                        return;
                    }

                    showPreview();
                } catch (error) {
                    alert('íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function showPreview() {
            const preview = document.getElementById('uploadPreview');
            const table = document.getElementById('previewTable');

            // ë°˜ë³„ í•™ìƒ ìˆ˜ ê³„ì‚°
            const classCounts = { C: 0, A: 0, B: 0 };
            students.forEach(s => {
                if (classCounts[s.class] !== undefined) {
                    classCounts[s.class]++;
                }
            });

            // ë°˜ë³„ ìš”ì•½ í‘œì‹œ
            document.getElementById('classSummary').innerHTML = `
                <div class="col-4">
                    <div class="stat-card py-2">
                        <div class="number fs-5" style="color: #b45309;">${classCounts.C}</div>
                        <small class="text-muted">Cë°˜ (1-2ì£¼)</small>
                    </div>
                </div>
                <div class="col-4">
                    <div class="stat-card py-2">
                        <div class="number fs-5" style="color: #1d4ed8;">${classCounts.A}</div>
                        <small class="text-muted">Aë°˜ (3-4ì£¼)</small>
                    </div>
                </div>
                <div class="col-4">
                    <div class="stat-card py-2">
                        <div class="number fs-5" style="color: #059669;">${classCounts.B}</div>
                        <small class="text-muted">Bë°˜ (5-6ì£¼)</small>
                    </div>
                </div>
            `;

            // ë°ì´í„°
            table.querySelector('tbody').innerHTML = students.map((s, i) => `
                <tr>
                    <td>${i + 1}</td>
                    <td>${s.studentId}</td>
                    <td>${s.name}</td>
                    <td><span class="badge badge-class-${s.class}">${s.class}ë°˜</span></td>
                    <td>${s.address}</td>
                </tr>
            `).join('');

            preview.style.display = 'block';
        }

        // ====== ë°°ì¹˜ ì•Œê³ ë¦¬ì¦˜ ======
        function runPlacement() {
            if (hospitals.length === 0) {
                alert('ë¨¼ì € ë³‘ì› ì„¤ì •ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”.');
                return;
            }

            document.getElementById('loadingOverlay').classList.add('show');

            setTimeout(() => {
                try {
                    placementResult = performPlacement();
                    showResults();
                } catch (error) {
                    alert('ë°°ì¹˜ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                    console.error(error);
                } finally {
                    document.getElementById('loadingOverlay').classList.remove('show');
                }
            }, 500);
        }

        function performPlacement() {
            const results = [];
            const unplacedStudents = [];
            const slots = getPlacementSlots();
            const CLASS_PERIODS = getClassPeriods();

            // ë³‘ì›ë³„ ì”ì—¬ ì •ì› ë³µì‚¬
            const remaining = hospitals.map(h => {
                const r = { name: h.name, address: h.address, originalIdx: hospitals.indexOf(h) };
                slots.forEach(slot => {
                    r[`${slot}_nicu`] = h[`${slot}_nicu`] || 0;
                    r[`${slot}_peds`] = h[`${slot}_peds`] || 0;
                });
                return r;
            });

            // ë°˜ë³„ë¡œ í•™ìƒ ê·¸ë£¹í™”
            const studentsByClass = {};
            STUDENT_CLASSES.forEach(c => studentsByClass[c] = []);
            students.forEach(s => {
                if (studentsByClass[s.class]) {
                    studentsByClass[s.class].push({ ...s });
                }
            });

            // 1ë‹¨ê³„: ì •ê·œ ê¸°ê°„ ë°°ì¹˜ (ì„¤ì •ëœ ìˆœì„œëŒ€ë¡œ - classOrder ì‚¬ìš©)
            for (const classId of classOrder) {
                const classStudents = studentsByClass[classId];
                if (classStudents.length === 0) continue;

                // ëª¨ë“  í•™ìƒì˜ ë³‘ì›ë³„ ì ìˆ˜ ê³„ì‚°
                classStudents.forEach(student => {
                    student.hospitalScores = remaining.map((h, idx) => ({
                        idx,
                        hospital: h,
                        score: calculateAddressScore(student.address, h.address)
                    })).sort((a, b) => b.score - a.score);

                    // ìµœê³  ì ìˆ˜ ì €ì¥ (ì œì•½ ì¡°ê±´ ê³„ì‚°ìš©)
                    student.bestScore = student.hospitalScores[0]?.score || 0;
                });

                // â˜… ìµœì í™” 1: ì œì•½ì´ ë§ì€ í•™ìƒ ìš°ì„  ë°°ì¹˜
                // (ì¢‹ì€ ë³‘ì› ì˜µì…˜ì´ ì ì€ í•™ìƒë¶€í„° ë°°ì¹˜í•˜ì—¬ ê³µì •ì„± í™•ë³´)
                classStudents.sort((a, b) => a.bestScore - b.bestScore);

                // ì´ˆê¸° ë°°ì¹˜
                const classResults = [];
                let nicuCount = 0, pedsCount = 0;

                for (const student of classStudents) {
                    let placed = false;
                    // ë¶€ì„œ ê· í˜• ë§ì¶”ê¸°
                    const deptOrder = nicuCount <= pedsCount ? ['nicu', 'peds'] : ['peds', 'nicu'];

                    for (const { idx } of student.hospitalScores) {
                        const hospital = remaining[idx];
                        for (const dept of deptOrder) {
                            const key = `${classId}_${dept}`;
                            if (hospital[key] > 0) {
                                hospital[key]--;
                                if (dept === 'nicu') nicuCount++; else pedsCount++;

                                classResults.push({
                                    studentId: student.studentId,
                                    name: student.name,
                                    class: student.class,
                                    address: student.address,
                                    hospitalIdx: idx,
                                    hospitalName: hospital.name,
                                    dept: dept,
                                    score: student.hospitalScores.find(h => h.idx === idx).score,
                                    slot: classId
                                });
                                placed = true;
                                break;
                            }
                        }
                        if (placed) break;
                    }

                    if (!placed) {
                        unplacedStudents.push(student);
                    }
                }

                // â˜… ìµœì í™” 2: êµí™˜ ê°œì„  (Swap Improvement)
                // ë°°ì¹˜ëœ í•™ìƒë“¤ ê°„ êµí™˜ìœ¼ë¡œ ì „ì²´ ì ìˆ˜ í–¥ìƒ
                let improved = true;
                let iterations = 0;
                const maxIterations = 100;

                while (improved && iterations < maxIterations) {
                    improved = false;
                    iterations++;

                    for (let i = 0; i < classResults.length; i++) {
                        for (let j = i + 1; j < classResults.length; j++) {
                            const r1 = classResults[i];
                            const r2 = classResults[j];

                            // ê°™ì€ ë¶€ì„œì¼ ë•Œë§Œ êµí™˜ ê°€ëŠ¥
                            if (r1.dept !== r2.dept) continue;

                            // êµí™˜ í›„ ì ìˆ˜ ê³„ì‚°
                            const student1 = classStudents.find(s => s.studentId === r1.studentId);
                            const student2 = classStudents.find(s => s.studentId === r2.studentId);

                            const currentScore = r1.score + r2.score;
                            const newScore1 = calculateAddressScore(student1.address, remaining[r2.hospitalIdx].address);
                            const newScore2 = calculateAddressScore(student2.address, remaining[r1.hospitalIdx].address);
                            const swappedScore = newScore1 + newScore2;

                            // êµí™˜ì´ ì´ë“ì´ë©´ ì‹¤í–‰
                            if (swappedScore > currentScore) {
                                // ë³‘ì› êµí™˜
                                const tempIdx = r1.hospitalIdx;
                                const tempName = r1.hospitalName;
                                r1.hospitalIdx = r2.hospitalIdx;
                                r1.hospitalName = r2.hospitalName;
                                r1.score = newScore1;
                                r2.hospitalIdx = tempIdx;
                                r2.hospitalName = tempName;
                                r2.score = newScore2;
                                improved = true;
                            }
                        }
                    }
                }

                // ê²°ê³¼ ì €ì¥
                classResults.forEach(r => {
                    results.push({
                        studentId: r.studentId,
                        name: r.name,
                        class: r.class,
                        period: CLASS_PERIODS[r.class],
                        placementSlot: r.slot,
                        isMixed: false,
                        address: r.address,
                        hospital: r.hospitalName,
                        department: r.dept === 'nicu' ? 'ì‹ ìƒì•„ì‹¤' : 'ì†Œì•„ê³¼',
                        deptKey: r.dept,
                        score: r.score,
                        status: 'ë°°ì¹˜ì™„ë£Œ'
                    });
                });
            }

            // 2ë‹¨ê³„: 7-8ì£¼ì°¨ í˜¼í•© ë°°ì¹˜ (ë™ì¼í•œ ìµœì í™” ì ìš©)
            if (unplacedStudents.length > 0) {
                // ì ìˆ˜ ì¬ê³„ì‚°
                unplacedStudents.forEach(student => {
                    student.hospitalScores = remaining.map((h, idx) => ({
                        idx,
                        hospital: h,
                        score: calculateAddressScore(student.address, h.address)
                    })).sort((a, b) => b.score - a.score);
                    student.bestScore = student.hospitalScores[0]?.score || 0;
                });

                // ì œì•½ ë§ì€ í•™ìƒ ìš°ì„ 
                unplacedStudents.sort((a, b) => a.bestScore - b.bestScore);

                const mixedResults = [];
                let nicuCount = 0, pedsCount = 0;

                for (const student of unplacedStudents) {
                    let placed = false;
                    const deptOrder = nicuCount <= pedsCount ? ['nicu', 'peds'] : ['peds', 'nicu'];

                    for (const { idx } of student.hospitalScores) {
                        const hospital = remaining[idx];
                        for (const dept of deptOrder) {
                            const key = `mixed_${dept}`;
                            if (hospital[key] > 0) {
                                hospital[key]--;
                                if (dept === 'nicu') nicuCount++; else pedsCount++;

                                mixedResults.push({
                                    studentId: student.studentId,
                                    name: student.name,
                                    class: student.class,
                                    address: student.address,
                                    hospitalIdx: idx,
                                    hospitalName: hospital.name,
                                    dept: dept,
                                    score: student.hospitalScores.find(h => h.idx === idx).score
                                });
                                placed = true;
                                break;
                            }
                        }
                        if (placed) break;
                    }

                    if (!placed) {
                        results.push({
                            studentId: student.studentId,
                            name: student.name,
                            class: student.class,
                            period: '-',
                            placementSlot: null,
                            isMixed: false,
                            address: student.address,
                            hospital: '-',
                            department: '-',
                            deptKey: null,
                            score: 0,
                            status: 'ë¯¸ë°°ì¹˜'
                        });
                    }
                }

                // í˜¼í•© ë°°ì¹˜ë„ êµí™˜ ê°œì„ 
                let improved = true;
                let iterations = 0;
                while (improved && iterations < 100) {
                    improved = false;
                    iterations++;
                    for (let i = 0; i < mixedResults.length; i++) {
                        for (let j = i + 1; j < mixedResults.length; j++) {
                            const r1 = mixedResults[i];
                            const r2 = mixedResults[j];
                            if (r1.dept !== r2.dept) continue;

                            const student1 = unplacedStudents.find(s => s.studentId === r1.studentId);
                            const student2 = unplacedStudents.find(s => s.studentId === r2.studentId);

                            const currentScore = r1.score + r2.score;
                            const newScore1 = calculateAddressScore(student1.address, remaining[r2.hospitalIdx].address);
                            const newScore2 = calculateAddressScore(student2.address, remaining[r1.hospitalIdx].address);

                            if (newScore1 + newScore2 > currentScore) {
                                const tempIdx = r1.hospitalIdx;
                                const tempName = r1.hospitalName;
                                r1.hospitalIdx = r2.hospitalIdx;
                                r1.hospitalName = r2.hospitalName;
                                r1.score = newScore1;
                                r2.hospitalIdx = tempIdx;
                                r2.hospitalName = tempName;
                                r2.score = newScore2;
                                improved = true;
                            }
                        }
                    }
                }

                mixedResults.forEach(r => {
                    results.push({
                        studentId: r.studentId,
                        name: r.name,
                        class: r.class,
                        period: '7-8ì£¼ì°¨',
                        placementSlot: 'mixed',
                        isMixed: true,
                        address: r.address,
                        hospital: r.hospitalName,
                        department: r.dept === 'nicu' ? 'ì‹ ìƒì•„ì‹¤' : 'ì†Œì•„ê³¼',
                        deptKey: r.dept,
                        score: r.score,
                        status: 'ë°°ì¹˜ì™„ë£Œ'
                    });
                });
            }

            return results;
        }

        function calculateAddressScore(studentAddr, hospitalAddr) {
            const studentParts = extractAddressParts(studentAddr);
            const hospitalParts = extractAddressParts(hospitalAddr);

            let score = 0;

            // 1. ê°™ì€ ì§€ì—­ì´ë©´ ìµœê³  ì ìˆ˜
            if (studentParts.region && hospitalParts.region && studentParts.region === hospitalParts.region) {
                score += 100;
            }

            // 2. ì¸ì ‘ ì§€ì—­ ë³´ë„ˆìŠ¤
            const adjacent = {
                // ì„œìš¸ì‹œ êµ¬
                'ê°•ë‚¨êµ¬': ['ì„œì´ˆêµ¬', 'ì†¡íŒŒêµ¬', 'ê°•ë™êµ¬', 'ì„±ë‚¨ì‹œ', 'ë¶„ë‹¹êµ¬'],
                'ì„œì´ˆêµ¬': ['ê°•ë‚¨êµ¬', 'ë™ì‘êµ¬', 'ê´€ì•…êµ¬', 'ê³¼ì²œì‹œ', 'ì„±ë‚¨ì‹œ'],
                'ì†¡íŒŒêµ¬': ['ê°•ë‚¨êµ¬', 'ê°•ë™êµ¬', 'ê´‘ì§„êµ¬', 'í•˜ë‚¨ì‹œ', 'ì„±ë‚¨ì‹œ'],
                'ê°•ë™êµ¬': ['ì†¡íŒŒêµ¬', 'ê´‘ì§„êµ¬', 'í•˜ë‚¨ì‹œ', 'êµ¬ë¦¬ì‹œ'],
                'ì¢…ë¡œêµ¬': ['ì„±ë¶êµ¬', 'ë™ëŒ€ë¬¸êµ¬', 'ì¤‘êµ¬', 'ì„œëŒ€ë¬¸êµ¬', 'ì€í‰êµ¬'],
                'ì„œëŒ€ë¬¸êµ¬': ['ì¢…ë¡œêµ¬', 'ë§ˆí¬êµ¬', 'ì€í‰êµ¬', 'ê³ ì–‘ì‹œ'],
                'ì„±ë¶êµ¬': ['ì¢…ë¡œêµ¬', 'ë™ëŒ€ë¬¸êµ¬', 'ê°•ë¶êµ¬', 'ë…¸ì›êµ¬', 'ì˜ì •ë¶€ì‹œ'],
                'ë§ˆí¬êµ¬': ['ì„œëŒ€ë¬¸êµ¬', 'ìš©ì‚°êµ¬', 'ì€í‰êµ¬', 'ê³ ì–‘ì‹œ'],
                'ìš©ì‚°êµ¬': ['ë§ˆí¬êµ¬', 'ì¤‘êµ¬', 'ì„±ë™êµ¬', 'ë™ì‘êµ¬'],
                'ì¤‘êµ¬': ['ì¢…ë¡œêµ¬', 'ìš©ì‚°êµ¬', 'ì„±ë™êµ¬', 'ë™ëŒ€ë¬¸êµ¬'],
                'ë™ëŒ€ë¬¸êµ¬': ['ì¤‘êµ¬', 'ì¢…ë¡œêµ¬', 'ì„±ë¶êµ¬', 'ê´‘ì§„êµ¬', 'ì¤‘ë‘êµ¬'],
                'ê´‘ì§„êµ¬': ['ë™ëŒ€ë¬¸êµ¬', 'ì„±ë™êµ¬', 'ì†¡íŒŒêµ¬', 'ê°•ë™êµ¬', 'ì¤‘ë‘êµ¬', 'êµ¬ë¦¬ì‹œ'],
                'ì„±ë™êµ¬': ['ê´‘ì§„êµ¬', 'ì¤‘êµ¬', 'ìš©ì‚°êµ¬', 'ë™ëŒ€ë¬¸êµ¬'],
                'ê°•ë¶êµ¬': ['ë…¸ì›êµ¬', 'ë„ë´‰êµ¬', 'ì„±ë¶êµ¬', 'ì˜ì •ë¶€ì‹œ'],
                'ë…¸ì›êµ¬': ['ë„ë´‰êµ¬', 'ê°•ë¶êµ¬', 'ì„±ë¶êµ¬', 'ì¤‘ë‘êµ¬', 'ì˜ì •ë¶€ì‹œ', 'ë‚¨ì–‘ì£¼ì‹œ'],
                'ë„ë´‰êµ¬': ['ë…¸ì›êµ¬', 'ê°•ë¶êµ¬', 'ì˜ì •ë¶€ì‹œ', 'ì–‘ì£¼ì‹œ'],
                'ì¤‘ë‘êµ¬': ['ë…¸ì›êµ¬', 'ë™ëŒ€ë¬¸êµ¬', 'ê´‘ì§„êµ¬', 'êµ¬ë¦¬ì‹œ', 'ë‚¨ì–‘ì£¼ì‹œ'],
                'ì€í‰êµ¬': ['ì„œëŒ€ë¬¸êµ¬', 'ë§ˆí¬êµ¬', 'ì¢…ë¡œêµ¬', 'ê³ ì–‘ì‹œ'],
                'ë™ì‘êµ¬': ['ì„œì´ˆêµ¬', 'ê´€ì•…êµ¬', 'ì˜ë“±í¬êµ¬', 'ìš©ì‚°êµ¬'],
                'ê´€ì•…êµ¬': ['ì„œì´ˆêµ¬', 'ë™ì‘êµ¬', 'ê¸ˆì²œêµ¬', 'ê³¼ì²œì‹œ', 'ì•ˆì–‘ì‹œ'],
                'ì˜ë“±í¬êµ¬': ['ë™ì‘êµ¬', 'ì–‘ì²œêµ¬', 'ê°•ì„œêµ¬', 'êµ¬ë¡œêµ¬', 'ê´‘ëª…ì‹œ'],
                'ì–‘ì²œêµ¬': ['ì˜ë“±í¬êµ¬', 'ê°•ì„œêµ¬', 'êµ¬ë¡œêµ¬', 'ë¶€ì²œì‹œ'],
                'ê°•ì„œêµ¬': ['ì–‘ì²œêµ¬', 'ì˜ë“±í¬êµ¬', 'ë¶€ì²œì‹œ', 'ê¹€í¬ì‹œ', 'ê³ ì–‘ì‹œ'],
                'êµ¬ë¡œêµ¬': ['ì˜ë“±í¬êµ¬', 'ì–‘ì²œêµ¬', 'ê¸ˆì²œêµ¬', 'ê´‘ëª…ì‹œ', 'ë¶€ì²œì‹œ'],
                'ê¸ˆì²œêµ¬': ['êµ¬ë¡œêµ¬', 'ê´€ì•…êµ¬', 'ê´‘ëª…ì‹œ', 'ì•ˆì–‘ì‹œ'],

                // ê²½ê¸°ë„ ì‹œ
                'ì„±ë‚¨ì‹œ': ['ê°•ë‚¨êµ¬', 'ì„œì´ˆêµ¬', 'ì†¡íŒŒêµ¬', 'ë¶„ë‹¹êµ¬', 'ìˆ˜ì •êµ¬', 'ì¤‘ì›êµ¬', 'ê´‘ì£¼ì‹œ', 'í•˜ë‚¨ì‹œ', 'ìš©ì¸ì‹œ'],
                'ë¶„ë‹¹êµ¬': ['ê°•ë‚¨êµ¬', 'ì„œì´ˆêµ¬', 'ì„±ë‚¨ì‹œ', 'ìˆ˜ì •êµ¬', 'ì¤‘ì›êµ¬', 'ìš©ì¸ì‹œ', 'ê´‘ì£¼ì‹œ'],
                'ìˆ˜ì •êµ¬': ['ì„±ë‚¨ì‹œ', 'ë¶„ë‹¹êµ¬', 'ì¤‘ì›êµ¬', 'í•˜ë‚¨ì‹œ', 'ê´‘ì£¼ì‹œ'],
                'ì¤‘ì›êµ¬': ['ì„±ë‚¨ì‹œ', 'ë¶„ë‹¹êµ¬', 'ìˆ˜ì •êµ¬', 'í•˜ë‚¨ì‹œ'],
                'ìš©ì¸ì‹œ': ['ì„±ë‚¨ì‹œ', 'ë¶„ë‹¹êµ¬', 'ìˆ˜ì›ì‹œ', 'ê´‘ì£¼ì‹œ', 'ì•ˆì„±ì‹œ', 'í™”ì„±ì‹œ'],
                'ìˆ˜ì›ì‹œ': ['ìš©ì¸ì‹œ', 'í™”ì„±ì‹œ', 'ì•ˆì–‘ì‹œ', 'ì˜ì™•ì‹œ', 'ì•ˆì‚°ì‹œ', 'ì˜¤ì‚°ì‹œ'],
                'í™”ì„±ì‹œ': ['ìˆ˜ì›ì‹œ', 'ìš©ì¸ì‹œ', 'ì˜¤ì‚°ì‹œ', 'í‰íƒì‹œ', 'ì•ˆì‚°ì‹œ'],
                'ì•ˆì–‘ì‹œ': ['ê´€ì•…êµ¬', 'ê¸ˆì²œêµ¬', 'ê³¼ì²œì‹œ', 'ì˜ì™•ì‹œ', 'ìˆ˜ì›ì‹œ', 'êµ°í¬ì‹œ', 'ê´‘ëª…ì‹œ'],
                'ê³¼ì²œì‹œ': ['ì„œì´ˆêµ¬', 'ê´€ì•…êµ¬', 'ì•ˆì–‘ì‹œ', 'ì˜ì™•ì‹œ', 'ì„±ë‚¨ì‹œ'],
                'ì˜ì™•ì‹œ': ['ì•ˆì–‘ì‹œ', 'ê³¼ì²œì‹œ', 'ìˆ˜ì›ì‹œ', 'êµ°í¬ì‹œ', 'ì„±ë‚¨ì‹œ'],
                'êµ°í¬ì‹œ': ['ì•ˆì–‘ì‹œ', 'ì˜ì™•ì‹œ', 'ì•ˆì‚°ì‹œ', 'ìˆ˜ì›ì‹œ'],
                'ì•ˆì‚°ì‹œ': ['ì‹œí¥ì‹œ', 'êµ°í¬ì‹œ', 'ìˆ˜ì›ì‹œ', 'í™”ì„±ì‹œ', 'ê´‘ëª…ì‹œ'],
                'ì‹œí¥ì‹œ': ['ì•ˆì‚°ì‹œ', 'ê´‘ëª…ì‹œ', 'ë¶€ì²œì‹œ', 'ì•ˆì–‘ì‹œ', 'ì¸ì²œ'],
                'ê´‘ëª…ì‹œ': ['ì˜ë“±í¬êµ¬', 'êµ¬ë¡œêµ¬', 'ê¸ˆì²œêµ¬', 'ì•ˆì–‘ì‹œ', 'ì‹œí¥ì‹œ', 'ë¶€ì²œì‹œ'],
                'ë¶€ì²œì‹œ': ['ì–‘ì²œêµ¬', 'ê°•ì„œêµ¬', 'êµ¬ë¡œêµ¬', 'ê´‘ëª…ì‹œ', 'ì‹œí¥ì‹œ', 'ê¹€í¬ì‹œ', 'ì¸ì²œ'],
                'ê¹€í¬ì‹œ': ['ê°•ì„œêµ¬', 'ë¶€ì²œì‹œ', 'ê³ ì–‘ì‹œ', 'ì¸ì²œ', 'íŒŒì£¼ì‹œ'],
                'ê³ ì–‘ì‹œ': ['ì„œëŒ€ë¬¸êµ¬', 'ë§ˆí¬êµ¬', 'ì€í‰êµ¬', 'ê°•ì„œêµ¬', 'ê¹€í¬ì‹œ', 'íŒŒì£¼ì‹œ', 'ì–‘ì£¼ì‹œ'],
                'íŒŒì£¼ì‹œ': ['ê³ ì–‘ì‹œ', 'ê¹€í¬ì‹œ', 'ì–‘ì£¼ì‹œ', 'ì—°ì²œêµ°'],
                'ì–‘ì£¼ì‹œ': ['ë„ë´‰êµ¬', 'ì˜ì •ë¶€ì‹œ', 'ê³ ì–‘ì‹œ', 'íŒŒì£¼ì‹œ', 'ë™ë‘ì²œì‹œ', 'í¬ì²œì‹œ'],
                'ì˜ì •ë¶€ì‹œ': ['ê°•ë¶êµ¬', 'ë„ë´‰êµ¬', 'ë…¸ì›êµ¬', 'ì–‘ì£¼ì‹œ', 'ë‚¨ì–‘ì£¼ì‹œ', 'í¬ì²œì‹œ'],
                'ë‚¨ì–‘ì£¼ì‹œ': ['ë…¸ì›êµ¬', 'ì¤‘ë‘êµ¬', 'êµ¬ë¦¬ì‹œ', 'ì˜ì •ë¶€ì‹œ', 'ê°€í‰êµ°', 'í¬ì²œì‹œ'],
                'êµ¬ë¦¬ì‹œ': ['ê°•ë™êµ¬', 'ê´‘ì§„êµ¬', 'ì¤‘ë‘êµ¬', 'ë‚¨ì–‘ì£¼ì‹œ', 'í•˜ë‚¨ì‹œ'],
                'í•˜ë‚¨ì‹œ': ['ì†¡íŒŒêµ¬', 'ê°•ë™êµ¬', 'êµ¬ë¦¬ì‹œ', 'ë‚¨ì–‘ì£¼ì‹œ', 'ì„±ë‚¨ì‹œ', 'ê´‘ì£¼ì‹œ'],
                'ê´‘ì£¼ì‹œ': ['ì„±ë‚¨ì‹œ', 'í•˜ë‚¨ì‹œ', 'ìš©ì¸ì‹œ', 'ì—¬ì£¼ì‹œ', 'ì´ì²œì‹œ'],
                'ì´ì²œì‹œ': ['ê´‘ì£¼ì‹œ', 'ì—¬ì£¼ì‹œ', 'ìš©ì¸ì‹œ', 'ì•ˆì„±ì‹œ'],
                'ì—¬ì£¼ì‹œ': ['ê´‘ì£¼ì‹œ', 'ì´ì²œì‹œ', 'ì–‘í‰êµ°'],
                'ì•ˆì„±ì‹œ': ['ìš©ì¸ì‹œ', 'ì´ì²œì‹œ', 'í‰íƒì‹œ', 'ì²œì•ˆì‹œ'],
                'í‰íƒì‹œ': ['í™”ì„±ì‹œ', 'ì•ˆì„±ì‹œ', 'ì˜¤ì‚°ì‹œ', 'ì²œì•ˆì‹œ', 'ì•„ì‚°ì‹œ'],
                'ì˜¤ì‚°ì‹œ': ['ìˆ˜ì›ì‹œ', 'í™”ì„±ì‹œ', 'í‰íƒì‹œ', 'ìš©ì¸ì‹œ'],
                'ë™ë‘ì²œì‹œ': ['ì–‘ì£¼ì‹œ', 'í¬ì²œì‹œ', 'ì—°ì²œêµ°'],
                'í¬ì²œì‹œ': ['ì˜ì •ë¶€ì‹œ', 'ì–‘ì£¼ì‹œ', 'ë‚¨ì–‘ì£¼ì‹œ', 'ë™ë‘ì²œì‹œ', 'ê°€í‰êµ°', 'ì—°ì²œêµ°'],
                'ê°€í‰êµ°': ['ë‚¨ì–‘ì£¼ì‹œ', 'í¬ì²œì‹œ', 'ì–‘í‰êµ°'],
                'ì–‘í‰êµ°': ['ê°€í‰êµ°', 'ì—¬ì£¼ì‹œ', 'ê´‘ì£¼ì‹œ'],
                'ì—°ì²œêµ°': ['íŒŒì£¼ì‹œ', 'ë™ë‘ì²œì‹œ', 'í¬ì²œì‹œ'],

                // ì¸ì²œ
                'ì¸ì²œ': ['ë¶€ì²œì‹œ', 'ì‹œí¥ì‹œ', 'ê¹€í¬ì‹œ'],
                'ì¸ì²œì‹œ': ['ë¶€ì²œì‹œ', 'ì‹œí¥ì‹œ', 'ê¹€í¬ì‹œ']
            };

            if (studentParts.region && hospitalParts.region) {
                if (adjacent[studentParts.region] && adjacent[studentParts.region].includes(hospitalParts.region)) {
                    score += 50;
                }
            }

            // 3. ê°™ì€ ê¶Œì—­ ë³´ë„ˆìŠ¤ (ëŒ€ë¶„ë¥˜)
            const regions = {
                'ì„œìš¸ë¶ë¶€': ['ì¢…ë¡œêµ¬', 'ì„±ë¶êµ¬', 'ê°•ë¶êµ¬', 'ë…¸ì›êµ¬', 'ë„ë´‰êµ¬', 'ë™ëŒ€ë¬¸êµ¬', 'ì¤‘ë‘êµ¬', 'ì˜ì •ë¶€ì‹œ', 'ì–‘ì£¼ì‹œ', 'í¬ì²œì‹œ', 'ë™ë‘ì²œì‹œ', 'ì—°ì²œêµ°'],
                'ì„œìš¸ë™ë¶€': ['ê´‘ì§„êµ¬', 'ì„±ë™êµ¬', 'ì¤‘êµ¬', 'êµ¬ë¦¬ì‹œ', 'ë‚¨ì–‘ì£¼ì‹œ', 'í•˜ë‚¨ì‹œ', 'ê°€í‰êµ°'],
                'ì„œìš¸ì„œë¶€': ['ì„œëŒ€ë¬¸êµ¬', 'ë§ˆí¬êµ¬', 'ì€í‰êµ¬', 'ê³ ì–‘ì‹œ', 'íŒŒì£¼ì‹œ', 'ê¹€í¬ì‹œ'],
                'ì„œìš¸ë‚¨ì„œ': ['ì˜ë“±í¬êµ¬', 'ì–‘ì²œêµ¬', 'ê°•ì„œêµ¬', 'êµ¬ë¡œêµ¬', 'ê¸ˆì²œêµ¬', 'ê´‘ëª…ì‹œ', 'ë¶€ì²œì‹œ', 'ì‹œí¥ì‹œ', 'ì¸ì²œ', 'ì¸ì²œì‹œ'],
                'ì„œìš¸ë‚¨ë¶€': ['ë™ì‘êµ¬', 'ê´€ì•…êµ¬', 'ì•ˆì–‘ì‹œ', 'ê³¼ì²œì‹œ', 'ì˜ì™•ì‹œ', 'êµ°í¬ì‹œ', 'ì•ˆì‚°ì‹œ'],
                'ê°•ë‚¨ê¶Œ': ['ê°•ë‚¨êµ¬', 'ì„œì´ˆêµ¬', 'ì†¡íŒŒêµ¬', 'ê°•ë™êµ¬', 'ì„±ë‚¨ì‹œ', 'ë¶„ë‹¹êµ¬', 'ìˆ˜ì •êµ¬', 'ì¤‘ì›êµ¬', 'í•˜ë‚¨ì‹œ', 'ê´‘ì£¼ì‹œ'],
                'ìˆ˜ì›ê¶Œ': ['ìˆ˜ì›ì‹œ', 'ìš©ì¸ì‹œ', 'í™”ì„±ì‹œ', 'ì˜¤ì‚°ì‹œ', 'í‰íƒì‹œ', 'ì•ˆì„±ì‹œ', 'ì´ì²œì‹œ', 'ì—¬ì£¼ì‹œ']
            };

            for (const [regionName, areas] of Object.entries(regions)) {
                if (areas.includes(studentParts.region) && areas.includes(hospitalParts.region)) {
                    score += 25; // ê°™ì€ ê¶Œì—­ì´ë©´ ì¶”ê°€ ì ìˆ˜
                    break;
                }
            }

            // ê¸°ë³¸ ì ìˆ˜ (ì•ˆì •ì ì¸ ì •ë ¬ì„ ìœ„í•´)
            score += Math.random() * 3;

            return score;
        }

        function extractAddressParts(address) {
            const parts = { region: null, dong: null };
            if (!address) return parts;

            // 1. ê²½ê¸°ë„ ì‹œ/êµ° ì¶”ì¶œ (ì˜ˆ: íŒŒì£¼ì‹œ, ì„±ë‚¨ì‹œ, ê¹€í¬ì‹œ)
            const cityMatch = address.match(/([ê°€-í£]+[ì‹œêµ°])/);

            // 2. ì„œìš¸ êµ¬ ì¶”ì¶œ (ì˜ˆ: ê°•ë‚¨êµ¬, ì¢…ë¡œêµ¬)
            const guMatch = address.match(/([ê°€-í£]+êµ¬)/);

            // 3. ë™ ì¶”ì¶œ
            const dongMatch = address.match(/([ê°€-í£]+[ë™ìë©´ë¦¬])/);

            // ìš°ì„ ìˆœìœ„: êµ¬ > ì‹œ/êµ° (ì„œìš¸ ì£¼ì†Œì—ì„œ "ì„œìš¸ì‹œ ê°•ë‚¨êµ¬"ì²˜ëŸ¼ ë‘˜ ë‹¤ ìˆì„ ìˆ˜ ìˆìŒ)
            // í•˜ì§€ë§Œ "ì„±ë‚¨ì‹œ ë¶„ë‹¹êµ¬"ì²˜ëŸ¼ ê²½ê¸°ë„ ì‹œ + êµ¬ ì¡°í•©ë„ ìˆìŒ
            if (guMatch) {
                const gu = guMatch[1];
                // ì„œìš¸ì˜ êµ¬ì¸ì§€ í™•ì¸
                const seoulGu = ['ê°•ë‚¨êµ¬', 'ê°•ë™êµ¬', 'ê°•ë¶êµ¬', 'ê°•ì„œêµ¬', 'ê´€ì•…êµ¬', 'ê´‘ì§„êµ¬', 'êµ¬ë¡œêµ¬', 'ê¸ˆì²œêµ¬',
                    'ë…¸ì›êµ¬', 'ë„ë´‰êµ¬', 'ë™ëŒ€ë¬¸êµ¬', 'ë™ì‘êµ¬', 'ë§ˆí¬êµ¬', 'ì„œëŒ€ë¬¸êµ¬', 'ì„œì´ˆêµ¬', 'ì„±ë™êµ¬',
                    'ì„±ë¶êµ¬', 'ì†¡íŒŒêµ¬', 'ì–‘ì²œêµ¬', 'ì˜ë“±í¬êµ¬', 'ìš©ì‚°êµ¬', 'ì€í‰êµ¬', 'ì¢…ë¡œêµ¬', 'ì¤‘êµ¬', 'ì¤‘ë‘êµ¬'];
                // ì„±ë‚¨ì‹œì˜ êµ¬
                const seongnamGu = ['ë¶„ë‹¹êµ¬', 'ìˆ˜ì •êµ¬', 'ì¤‘ì›êµ¬'];
                // ìš©ì¸ì‹œ, ìˆ˜ì›ì‹œ ë“±ì˜ êµ¬
                const gyeonggiGu = ['ì²˜ì¸êµ¬', 'ê¸°í¥êµ¬', 'ìˆ˜ì§€êµ¬', 'ì¥ì•ˆêµ¬', 'ê¶Œì„ êµ¬', 'íŒ”ë‹¬êµ¬', 'ì˜í†µêµ¬',
                    'ë•ì–‘êµ¬', 'ì¼ì‚°ë™êµ¬', 'ì¼ì‚°ì„œêµ¬', 'ë§Œì•ˆêµ¬', 'ë™ì•ˆêµ¬', 'ìƒë¡êµ¬', 'ë‹¨ì›êµ¬',
                    'ë¶€í‰êµ¬', 'ê³„ì–‘êµ¬', 'ë‚¨ë™êµ¬', 'ì—°ìˆ˜êµ¬', 'ë¯¸ì¶”í™€êµ¬', 'ì¤‘êµ¬', 'ë™êµ¬', 'ì„œêµ¬'];

                if (seoulGu.includes(gu)) {
                    parts.region = gu;
                } else if (seongnamGu.includes(gu) || gyeonggiGu.includes(gu)) {
                    // ê²½ê¸°ë„ êµ¬ëŠ” ê·¸ëŒ€ë¡œ ì‚¬ìš© (ë¶„ë‹¹êµ¬, ìˆ˜ì •êµ¬ ë“±)
                    parts.region = gu;
                } else if (cityMatch) {
                    // ì•Œ ìˆ˜ ì—†ëŠ” êµ¬ì´ë©´ ì‹œ ì‚¬ìš©
                    parts.region = cityMatch[1];
                }
            } else if (cityMatch) {
                parts.region = cityMatch[1];
            }

            if (dongMatch) parts.dong = dongMatch[1];

            return parts;
        }

        // ====== ê²°ê³¼ í‘œì‹œ ======
        function showResults() {
            document.getElementById('noResultMessage').style.display = 'none';
            document.getElementById('resultContent').style.display = 'block';

            // í†µê³„ ì—…ë°ì´íŠ¸
            const total = students.length;
            const placed = placementResult.filter(r => r.status === 'ë°°ì¹˜ì™„ë£Œ').length;
            const unplaced = total - placed;
            const rate = total > 0 ? Math.round((placed / total) * 100) : 0;

            document.getElementById('statTotal').textContent = total;
            document.getElementById('statPlaced').textContent = placed;
            document.getElementById('statUnplaced').textContent = unplaced;
            document.getElementById('statRate').textContent = rate + '%';

            // ê²°ê³¼ í…Œì´ë¸”
            filterResult('all');

            // ë³‘ì›ë³„ í˜„í™©
            showHospitalSummary();

            // ê²°ê³¼ íƒ­ìœ¼ë¡œ ì´ë™
            document.getElementById('result-tab').click();
        }

        function filterResult(filter) {
            // ë²„íŠ¼ í™œì„±í™”
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.filter === filter) btn.classList.add('active');
            });

            let filtered;
            if (filter === 'all') {
                filtered = placementResult;
            } else if (filter === 'nicu') {
                filtered = placementResult.filter(r => r.deptKey === 'nicu');
            } else if (filter === 'peds') {
                filtered = placementResult.filter(r => r.deptKey === 'peds');
            } else if (filter === 'regular') {
                filtered = placementResult.filter(r => !r.isMixed && r.status === 'ë°°ì¹˜ì™„ë£Œ');
            } else if (filter === 'mixed') {
                filtered = placementResult.filter(r => r.isMixed);
            } else {
                // A, B, C ë°˜ í•„í„°
                filtered = placementResult.filter(r => r.class === filter);
            }

            document.getElementById('resultCount').textContent = filtered.length + 'ëª…';

            const tbody = document.getElementById('resultTableBody');
            tbody.innerHTML = filtered.map(r => `
                <tr class="${r.status === 'ë¯¸ë°°ì¹˜' ? 'table-danger' : r.isMixed ? 'table-warning' : ''}">
                    <td>${r.studentId}</td>
                    <td>${r.name}</td>
                    <td><span class="badge badge-class-${r.class}">${r.class}ë°˜</span></td>
                    <td><span class="badge ${r.isMixed ? 'period-mixed' : 'bg-secondary'} period-badge">${r.period}</span></td>
                    <td>${r.address}</td>
                    <td>${r.hospital}</td>
                    <td>
                        ${r.department !== '-' ?
                            `<span class="badge ${r.deptKey === 'nicu' ? 'dept-nicu' : 'dept-peds'}">${r.department}</span>`
                            : '-'}
                    </td>
                    <td>
                        <span class="badge ${r.status === 'ë°°ì¹˜ì™„ë£Œ' ? (r.isMixed ? 'bg-warning text-dark' : 'bg-success') : 'bg-danger'}">
                            ${r.status}${r.isMixed ? ' (í˜¼í•©)' : ''}
                        </span>
                    </td>
                </tr>
            `).join('');
        }

        function showHospitalSummary() {
            const slots = getPlacementSlots();
            const summary = {};

            // ê²°ê³¼ í…Œì´ë¸” í—¤ë”ë„ ë™ì  ì—…ë°ì´íŠ¸
            updateResultTableHeaders();

            hospitals.forEach(h => {
                summary[h.name] = {};
                slots.forEach(slot => {
                    summary[h.name][slot] = {
                        nicu: { placed: 0, total: h[`${slot}_nicu`] || 0 },
                        peds: { placed: 0, total: h[`${slot}_peds`] || 0 }
                    };
                });
            });

            placementResult.forEach(r => {
                if (r.hospital !== '-' && summary[r.hospital] && r.placementSlot) {
                    const slot = r.placementSlot;
                    if (summary[r.hospital][slot]) {
                        if (r.deptKey === 'nicu') {
                            summary[r.hospital][slot].nicu.placed++;
                        } else if (r.deptKey === 'peds') {
                            summary[r.hospital][slot].peds.placed++;
                        }
                    }
                }
            });

            const tbody = document.getElementById('hospitalSummaryBody');
            tbody.innerHTML = Object.entries(summary).map(([name, data]) => {
                let totalPlaced = 0;
                let cells = '';

                slots.forEach(slot => {
                    const nicu = data[slot].nicu;
                    const peds = data[slot].peds;
                    totalPlaced += nicu.placed + peds.placed;

                    const nicuFull = nicu.placed >= nicu.total && nicu.total > 0;
                    const pedsFull = peds.placed >= peds.total && peds.total > 0;

                    cells += `
                        <td class="text-center ${nicuFull ? 'text-success fw-bold' : ''}" style="font-size:0.8rem;">
                            ${nicu.total > 0 ? `${nicu.placed}/${nicu.total}` : '-'}
                        </td>
                        <td class="text-center ${pedsFull ? 'text-success fw-bold' : ''}" style="font-size:0.8rem;">
                            ${peds.total > 0 ? `${peds.placed}/${peds.total}` : '-'}
                        </td>
                    `;
                });

                return `
                    <tr>
                        <td>${name}</td>
                        ${cells}
                        <td class="text-center"><strong>${totalPlaced}ëª…</strong></td>
                    </tr>
                `;
            }).join('');
        }

        function updateResultTableHeaders() {
            const thead = document.querySelector('#hospitalSummaryTable thead');
            if (!thead) return;

            const slots = getPlacementSlots();

            // ë™ì  ë¼ë²¨ ìƒì„±
            let headerRow1 = '<th rowspan="2" class="align-middle text-center">ë³‘ì›ëª…</th>';
            let headerRow2 = '';

            slots.forEach((slot, idx) => {
                if (slot === 'mixed') {
                    headerRow1 += `<th colspan="2" class="text-center class-header-mixed">7-8ì£¼ (í˜¼í•©)</th>`;
                } else {
                    const weekStart = idx * 2 + 1;
                    const weekEnd = weekStart + 1;
                    headerRow1 += `<th colspan="2" class="text-center class-header-${slot}">${slot}ë°˜ (${weekStart}-${weekEnd}ì£¼)</th>`;
                }
                headerRow2 += `
                    <th class="text-center" style="font-size:0.7rem;">ì‹ ìƒ</th>
                    <th class="text-center" style="font-size:0.7rem;">ì†Œì•„</th>
                `;
            });

            headerRow1 += '<th rowspan="2" class="align-middle text-center">ì´ê³„</th>';

            thead.innerHTML = `<tr>${headerRow1}</tr><tr>${headerRow2}</tr>`;
        }

        // ====== ê²°ê³¼ ë‹¤ìš´ë¡œë“œ ======
        function downloadResult() {
            if (placementResult.length === 0) {
                alert('ë‹¤ìš´ë¡œë“œí•  ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const ws = XLSX.utils.json_to_sheet(placementResult.map(r => ({
                'í•™ë²ˆ': r.studentId,
                'ì´ë¦„': r.name,
                'ë°˜': r.class + 'ë°˜',
                'ì‹¤ìŠµê¸°ê°„': r.period,
                'ë°°ì¹˜ìœ í˜•': r.isMixed ? '7-8ì£¼ í˜¼í•©' : 'ì •ê·œë°°ì¹˜',
                'ì£¼ì†Œ': r.address,
                'ë°°ì •ë³‘ì›': r.hospital,
                'ì‹¤ìŠµë¶€ì„œ': r.department,
                'ìƒíƒœ': r.status
            })));

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'ë°°ì¹˜ê²°ê³¼');

            // ë³‘ì›ë³„ ìš”ì•½ ì‹œíŠ¸
            const summaryData = [];
            const slots = getPlacementSlots();

            // ë™ì  ë¼ë²¨ ìƒì„±
            const slotLabels = {};
            classOrder.forEach((cls, idx) => {
                const weekStart = idx * 2 + 1;
                const weekEnd = weekStart + 1;
                slotLabels[cls] = `${cls}ë°˜(${weekStart}-${weekEnd}ì£¼)`;
            });
            slotLabels['mixed'] = '7-8ì£¼(í˜¼í•©)';

            hospitals.forEach(h => {
                const row = { 'ë³‘ì›ëª…': h.name };
                slots.forEach(slot => {
                    const placed = placementResult.filter(r => r.hospital === h.name && r.placementSlot === slot);
                    row[`${slotLabels[slot]}_ì‹ ìƒì•„ì‹¤`] = `${placed.filter(r => r.deptKey === 'nicu').length}/${h[`${slot}_nicu`] || 0}`;
                    row[`${slotLabels[slot]}_ì†Œì•„ê³¼`] = `${placed.filter(r => r.deptKey === 'peds').length}/${h[`${slot}_peds`] || 0}`;
                });
                summaryData.push(row);
            });
            const ws2 = XLSX.utils.json_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, ws2, 'ë³‘ì›ë³„í˜„í™©');

            XLSX.writeFile(wb, 'ì‹¤ìŠµë°°ì¹˜ê²°ê³¼_' + new Date().toISOString().slice(0,10) + '.xlsx');
        }
    </script>
</body>
</html>
